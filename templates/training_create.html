{% extends "base.html" %}
{% set title = "Создать курс — Sales Journey" %}

{% block content %}
<section class="max-w-3xl mx-auto px-4 py-8" x-data="createCourse({{ company_id }})">
  <h1 class="text-3xl font-extrabold">Создать курс для своей компании</h1>
  <p class="text-slate-400 mt-1">Курс увидят только сотрудники вашей компании.</p>

  <div class="mt-6 rounded-2xl border border-white/10 bg-slate-900/60 p-5 space-y-3">
    <input x-model="form.title" class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2"
           placeholder="Название курса">
    <textarea x-model="form.description" class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 h-24"
              placeholder="Короткое описание"></textarea>
    <textarea x-model="form.content_md" class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 h-40"
              placeholder="Материал (Markdown)"></textarea>
    <input x-model="form.youtube_url" class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2"
           placeholder="YouTube URL (опционально)">
    <div class="grid grid-cols-3 gap-3">
      <div>
        <label class="text-xs text-slate-400">Порог, %</label>
        <input x-model.number="form.pass_score" type="number"
               class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
      </div>
      <div>
        <label class="text-xs text-slate-400">Попыток</label>
        <input x-model.number="form.max_attempts" type="number"
               class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
      </div>
      <div>
        <label class="text-xs text-slate-400">XP награда</label>
        <input x-model.number="form.xp_reward" type="number"
               class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
      </div>
    </div>

    <div class="rounded-xl border border-white/10 p-3">
      <div class="font-semibold">Вопросы</div>
      <template x-for="(q,qi) in form.questions" :key="qi">
        <div class="mt-3 rounded-lg border border-white/10 p-3">
          <input x-model="q.text" class="w-full rounded-lg bg-black/40 border border-white/10 px-3 py-2"
                 placeholder="Текст вопроса">
          <div class="mt-2 space-y-2">
            <template x-for="(o,oi) in q.options" :key="oi">
              <div class="flex items-center gap-2">
                <input x-model="o.text" class="flex-1 rounded-lg bg-black/40 border border-white/10 px-3 py-2"
                       placeholder="Вариант">
                <label class="text-xs flex items-center gap-1">
                  <input type="checkbox" x-model="o.is_correct" class="rounded"> верный
                </label>
              </div>
            </template>
            <button class="text-sm px-3 py-1 rounded-lg border border-white/10 hover:bg-white/5"
                    @click="q.options.push({text:'', is_correct:false})">+ вариант</button>
          </div>
        </div>
      </template>
      <button class="mt-2 text-sm px-3 py-1 rounded-lg border border-white/10 hover:bg-white/5"
              @click="form.questions.push({text:'', options:[{text:'',is_correct:false}]})">+ вопрос</button>
    </div>

    <button class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 py-2 font-semibold"
            @click="submit()">Создать курс</button>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function createCourse(companyId){
  return {
    form: {
      title:'', description:'', content_md:'', youtube_url:'',
      pass_score:80, max_attempts:3, xp_reward:50,
      questions:[{text:'', options:[{text:'',is_correct:false}]}]
    },
    async submit(){
      const payload = {
        scope:'company', company_id: companyId,
        title:this.form.title, description:this.form.description,
        content_md:this.form.content_md, youtube_url:this.form.youtube_url,
        pass_score:this.form.pass_score, max_attempts:this.form.max_attempts, xp_reward:this.form.xp_reward,
        questions:this.form.questions
      };
      const r = await fetch('/api/training/courses', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      if(!r.ok){
        const e = await r.json().catch(()=>({description:'Ошибка'}));
        return alert(e.description || 'Ошибка');
      }
      const d = await r.json();
      location.href = `/training/${d.course.id}`;
    }
  }
}
</script>
{% endblock %}
