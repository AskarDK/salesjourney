{% extends "base.html" %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-10" x-data="storePage()" x-init="init()">
  <h1 class="text-2xl font-bold">–ú–∞–≥–∞–∑–∏–Ω</h1>

  <!-- —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div class="mt-4 text-slate-400" x-show="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <div class="mt-4 text-rose-300" x-show="error" x-text="error"></div>

  <!-- —Ç–æ–≤–∞—Ä—ã -->
  <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4" x-show="!loading && items.length">
    <template x-for="it in items" :key="it.id">
      <div class="rounded-2xl border border-white/10 bg-slate-900/70 p-4 flex flex-col justify-between">
        <div>
          <div class="flex items-center justify-between">
            <div class="font-semibold" x-text="it.title"></div>
            <span class="text-xs px-2 py-0.5 rounded-full border border-white/10" x-text="badge(it)"></span>
          </div>
          <div class="text-sm text-slate-400 mt-1" x-text="desc(it)"></div>
          <div class="mt-3 text-amber-300 font-semibold">ü™ô <span x-text="it.cost_coins"></span></div>
          <div class="text-xs text-slate-500 mt-1" x-show="it.locked" x-text="it.lock_reason"></div>
          <div class="text-xs text-slate-500 mt-1" x-show="it.stock !== null">–û—Å—Ç–∞—Ç–æ–∫: <span x-text="it.stock"></span></div>
        </div>

        <button
          class="mt-4 px-4 py-2 rounded-xl font-semibold transition
                 disabled:opacity-50 disabled:cursor-not-allowed
                 border border-white/10"
          :class="it.locked ? 'bg-white/5 text-slate-400' : 'bg-indigo-600 hover:bg-indigo-500'"
          :disabled="it.locked || buyingId===it.id"
          @click="buy(it)">
          <span x-show="buyingId!==it.id">–ö—É–ø–∏—Ç—å</span>
          <span x-show="buyingId===it.id">–ü–æ–∫—É–ø–∫–∞‚Ä¶</span>
        </button>
      </div>
    </template>
  </div>

  <div class="mt-10 text-slate-400" x-show="!loading && !items.length">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>
</section>
{% endblock %}

{% block scripts %}
<script>
window.storePage = function(){
  return {
    items: [],
    loading: false,
    error: null,
    buyingId: null,

    async init(){
      this.loading = true;
      this.error = null;
      try{
        const r = await fetch('/api/store');
        const data = await r.json();
        this.items = (data.items || []);
      }catch(e){
        this.error = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω';
      }finally{
        this.loading = false;
      }
    },

    badge(it){
      if(it.type === 'coupon') return '–ö—É–ø–æ–Ω';
      if(it.type === 'skin')   return '–ö–æ—Å–º–µ—Ç–∏–∫–∞';
      return it.type || '–¢–æ–≤–∞—Ä';
    },

    desc(it){
      // –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ payload (—Å–ª–æ—Ç/–∫–ª—é—á)
      const p = it.payload || {};
      if(it.type==='skin' && p.slot && p.key){
        const slot = {frame:'–†–∞–º–∫–∞', outfit:'–û–¥–µ–∂–¥–∞', hair:'–ü—Ä–∏—á–µ—Å–∫–∞'}[p.slot] || p.slot;
        return `${slot}: ${p.key}`;
      }
      return '';
    },

    async buy(it){
      if(it.locked) return;
      this.buyingId = it.id;
      this.error = null;
      try{
        const r = await fetch(`/api/store/buy/${it.id}`, {method:'POST', headers:{'Content-Type':'application/json'}});
        if(!r.ok){
          const msg = await r.text();
          throw new Error(msg || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
        }
        const data = await r.json();

        // —É–º–µ–Ω—å—à–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –ª–æ–∫–∞–ª—å–Ω–æ
        if(it.stock !== null && typeof it.stock === 'number') it.stock = Math.max(0, it.stock - 1);

        // –µ—Å–ª–∏ —ç—Ç–æ –∫–æ—Å–º–µ—Ç–∏–∫–∞ ‚Äî –≤–µ—Ä–æ—è—Ç–Ω–æ –∞–≤—Ç–æ—ç–∫–∏–ø–∏—Ä–æ–≤–∞–ª–∏; –æ–±–Ω–æ–≤–∏–º –∞–≤–∞—Ç–∞—Ä –≤ navbar (–∫—ç—à-–±–∞—Å—Ç–∏–Ω–≥)
        const navImg = document.querySelector('img[data-avatar]');
        if(navImg){
          const url = new URL(navImg.src, window.location.origin);
          url.searchParams.set('t', Date.now().toString());
          navImg.src = url.toString();
        }

        // –ø–æ–∫–∞–∂–µ–º —Ç–æ—Å—Ç (–µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å $store.toasts)
        if(window.Alpine && Alpine.store && Alpine.store('toasts')){
          Alpine.store('toasts').push({
            emoji:'üéâ',
            title:'–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞',
            text:`${it.title} –∫—É–ø–ª–µ–Ω${it.type==='skin' ? ' –∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω' : ''}!`
          });
        }
      }catch(e){
        this.error = '–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å: ' + (e.message || e);
      }finally{
        this.buyingId = null;
      }
    }
  }
}
</script>
{% endblock %}
