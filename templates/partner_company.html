{% extends "base.html" %}
{% set title = "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è ‚Äî Sales Journey" %}

{% block content %}

<style>
  /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ base.html: --sj-bg, --sj-elev, --sj-border, --sj-text, --sj-muted, --sj-primary */
  [x-cloak]{ display:none !important; }

  .card{
    background: var(--sj-elev);
    color: var(--sj-text);
    border:1px solid var(--sj-border);
    border-radius: 18px;
  }
  .muted{
    background: color-mix(in oklab, var(--sj-bg) 88%, transparent);
    border:1px solid var(--sj-border);
    border-radius: 14px;
  }
  .glass{
    position:relative; background: color-mix(in oklab, var(--sj-elev) 86%, transparent);
    backdrop-filter: blur(10px);
    border:1px solid var(--sj-border); border-radius: 24px; box-shadow: var(--shadow, 0 10px 30px -12px rgba(0,0,0,.25));
  }

  .input,.select,.textarea{
    width:100%; background: color-mix(in oklab, var(--sj-elev) 96%, transparent);
    color: var(--sj-text); border:1px solid var(--sj-border); border-radius: 12px; padding:.6rem .8rem;
    transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .textarea{ min-height: 3.5rem; }
  .input:focus,.select:focus,.textarea:focus{
    outline:none; border-color: var(--sj-primary);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--sj-primary) 35%, transparent);
    background: color-mix(in oklab, var(--sj-elev) 98%, transparent);
  }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
    font-weight:700; border-radius:12px; padding:.6rem .9rem; border:1px solid var(--sj-border);
    transition: transform .06s ease, filter .15s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .btn:hover{ filter:brightness(.98); }
  .btn:active{ transform: translateY(1px); }
  .btn:focus-visible{ outline:none; box-shadow: 0 0 0 3px color-mix(in oklab, var(--sj-primary) 35%, transparent); }
  .btn-outline{ background:transparent; }
  .btn-ghost{ background:transparent; border-color: transparent; color: var(--sj-muted); }
  .btn-indigo{ background: var(--sj-primary); border-color: var(--sj-primary); color: #fff; }
  .btn-emerald{ background: rgb(16 185 129); border-color: rgb(16 185 129); color:#fff; }
  .btn-sky{ background: rgb(14 165 233); border-color: rgb(14 165 233); color:#fff; }
  .btn-amber{ background: rgb(217 119 6); border-color: rgb(217 119 6); color:#000; }
  .btn-rose{ background: rgb(225 29 72); border-color: rgb(225 29 72); color:#fff; }

  .pill{ padding:.4rem .8rem; border:1px solid var(--sj-border); border-radius: 999px; cursor:pointer; }
  .pill.active{ background: color-mix(in oklab, var(--sj-primary) 18%, var(--sj-elev)); border-color: color-mix(in oklab, var(--sj-primary) 45%, var(--sj-border)); color: white; }

  .table-wrap{ overflow-x:auto; border:1px solid var(--sj-border); border-radius: 14px; }
  table{ width:100%; border-collapse: separate; border-spacing:0; }
  thead th{
    text-align:left; font-weight:700; font-size:.85rem; color: var(--sj-muted);
    background: color-mix(in oklab, var(--sj-elev) 85%, transparent);
    border-bottom: 1px solid var(--sj-border); padding:.6rem .75rem; position: sticky; top:0; z-index:1;
    backdrop-filter: blur(4px);
  }
  tbody td{ padding:.6rem .75rem; border-top:1px solid var(--sj-border); }
  tbody tr:hover{ background: color-mix(in oklab, var(--sj-elev) 70%, transparent); }

  .toggle{
    --w: 40px; --h: 24px; width:var(--w); height:var(--h);
    background: color-mix(in oklab, var(--sj-bg) 75%, transparent);
    border:1px solid var(--sj-border); border-radius: var(--h); position:relative; cursor:pointer;
    transition: background .2s ease, border-color .2s ease;
  }
  .toggle::after{
    content:""; position:absolute; top:2px; left:2px;
    width: calc(var(--h) - 4px); height: calc(var(--h) - 4px);
    background: #fff; border-radius: 999px; box-shadow: 0 3px 10px rgba(0,0,0,.25);
    transition: transform .2s cubic-bezier(.22,.61,.36,1);
  }
  .toggle.is-on{ background: rgba(16,185,129,.35); border-color: rgba(16,185,129,.6); }
  .toggle.is-on::after{ transform: translateX(calc(var(--w) - var(--h))); }

  .badge{ display:inline-flex; gap:.35rem; align-items:center; font-size:.72rem; border-radius: 999px; padding:.15rem .55rem; border:1px solid var(--sj-border); color: var(--sj-muted); }

  /* —É–ø—Ä—É–≥–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è */
  .fade-enter[x-cloak]{ opacity:0; transform: translateY(4px); }
</style>

<section class="max-w-7xl mx-auto px-4 py-8"
x-data='window.partnerCompanyPageEnh(
  {{ company_id if company_id is not none else "null" }},
  {{ company_slug|default(none)|tojson }}
)'
         x-init="init()"
         x-cloak>

  <!-- Header -->
  <div class="glass px-5 py-5 sm:px-6 sm:py-6 mb-6">
    <div class="flex items-start sm:items-center justify-between gap-4">
      <div class="min-w-0">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</h1>
        <p class="text-sm mt-1 text-[color:var(--sj-muted)]" x-text="headerSubtitle"></p>
      </div>
      <div class="flex items-center gap-2 sm:gap-3 shrink-0">
        <button class="btn btn-outline" @click="toggleTheme()" :aria-label="theme==='dark'?'–í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É':'–í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É'">
          <i class="bi bi-moon-stars-fill dark:hidden"></i>
          <i class="bi bi-sun-fill hidden dark:inline"></i>
          <span class="hidden sm:inline">–¢–µ–º–∞</span>
        </button>

        {% if company_id %}
          <a class="btn btn-indigo" href="/partner/company/{{ company_id }}/onboarding">–†–µ–¥–∞–∫—Ç–æ—Ä –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞</a>
          <button @click="setTab('crm'); loadCrm()" class="btn btn-indigo">CRM</button>
        {% else %}
          <button class="btn btn-indigo opacity-60 cursor-not-allowed" disabled>–†–µ–¥–∞–∫—Ç–æ—Ä –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞</button>
        {% endif %}

        <template x-if="companyId">
          <div class="hidden md:flex items-center gap-2">
            <a href="/partner/requests" class="btn btn-outline">–ó–∞—è–≤–∫–∏</a>
            <a href="/partner/reports"  class="btn btn-outline">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
          </div>
        </template>
        <template x-if="!companyId">
          <a href="/partner/company/create" class="btn btn-emerald">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</a>
        </template>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="flex flex-wrap items-center gap-2 mb-4">
    <button :class="['pill', tab==='feed'?'active':'']"  @click="setTab('feed')">–õ–µ–Ω—Ç–∞</button>
    <button :class="['pill', tab==='tasks'?'active':'']" @click="setTab('tasks')">–ó–∞–¥–∞—á–∏</button>
    <button :class="['pill', tab==='people'?'active':'']" @click="setTab('people'); loadPeople(people.page,true)">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
    <button :class="['pill', tab==='store'?'active':'']"  @click="setTab('store'); loadStore(true)">–ú–∞–≥–∞–∑–∏–Ω</button>
    <button :class="['pill', tab==='crm'?'active':'']"   @click="setTab('crm'); loadCrm()">CRM</button>
  </div>

  <!-- ===== FEED ===== -->
  <div x-show="tab==='feed'" x-transition.opacity class="space-y-4 fade-enter">
    <div class="card p-4" x-show="canPost">
      <div class="font-semibold mb-2">–ù–æ–≤—ã–π –ø–æ—Å—Ç</div>
      <textarea x-model="newPost" class="textarea" placeholder="–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è..."></textarea>

      <div class="mt-2">
        <input type="file" accept="image/*" x-ref="newPostImageInput"
               class="block w-full text-sm file:mr-3 file:rounded-lg file:border file:border-[var(--sj-border)] file:bg-[color-mix(in_oklab,var(--sj-elev)_96%,transparent)] file:px-3 file:py-1.5 hover:file:brightness-95"
               @change="onNewPostFile($event)">
        <div x-show="newPostPreview" class="mt-2">
          <img :src="newPostPreview" alt="" class="max-h-56 rounded-xl border border-[var(--sj-border)] object-contain">
          <button type="button" class="mt-2 text-xs underline text-[color:var(--sj-muted)]" @click="clearNewPostFile()">–£–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
        </div>
      </div>

      <label class="inline-flex items-center gap-2 text-sm mt-2 text-[color:var(--sj-muted)]">
        <input type="checkbox" x-model="newPinned" class="rounded"> –ó–∞–∫—Ä–µ–ø–∏—Ç—å
      </label>

      <button class="mt-3 w-full btn btn-indigo" :disabled="posting" @click="createPost()">
        <span x-show="!posting">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</span>
        <span x-show="posting" class="inline-flex items-center gap-2"><i class="bi bi-arrow-repeat animate-spin"></i> –ü—É–±–ª–∏–∫—É–µ–º‚Ä¶</span>
      </button>
    </div>

    <!-- –õ–µ–Ω—Ç–∞ -->
    <template x-if="loading.feed">
      <div class="space-y-3">
        <div class="card p-4 skeleton h-28 rounded-xl"></div>
        <div class="card p-4 skeleton h-24 rounded-xl"></div>
        <div class="card p-4 skeleton h-36 rounded-xl"></div>
      </div>
    </template>

    <div class="space-y-3" x-show="!loading.feed">
      <template x-for="p in feed" :key="p.id">
        <div class="card p-4 group">
          <div class="text-xs text-[color:var(--sj-muted)]" x-text="fmtDateTime(p.created_at)"></div>
          <div class="font-semibold mt-1 flex items-center gap-2">
            <span class="text-emerald-400" x-text="p.author"></span>
            <span class="text-xs text-[color:var(--sj-muted)]" x-text="p.type==='partner'?'(–ø–∞—Ä—Ç–Ω—ë—Ä)':'(–º–µ–Ω–µ–¥–∂–µ—Ä)'"></span>
            <span x-show="p.pinned" class="ml-2 text-amber-400">üìå</span>
          </div>
          <div class="mt-1 whitespace-pre-line" x-text="p.text"></div>
          <template x-if="(p.image_url || p.photo_url || p.image)">
            <img :src="p.image_url || p.photo_url || p.image"
                 class="mt-2 rounded-xl border border-[var(--sj-border)] max-h-80 object-contain"
                 loading="lazy" alt="">
          </template>
        </div>
      </template>
      <div x-show="feed.length===0" class="text-sm text-[color:var(--sj-muted)]">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>
    </div>
  </div>

  <!-- ===== TASKS ===== -->
  <div x-show="tab==='tasks'" x-transition.opacity class="space-y-3 fade-enter">
    <template x-if="loading.tasks">
      <div class="space-y-3">
        <div class="card p-4 skeleton h-24 rounded-xl"></div>
        <div class="card p-4 skeleton h-24 rounded-xl"></div>
      </div>
    </template>

    <div x-show="!loading.tasks">
      <template x-for="t in tasks" :key="t.id">
        <div class="card p-4 flex items-start justify-between gap-4">
          <div>
            <div class="font-semibold" x-text="t.title"></div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-[11px] px-2 py-0.5 rounded-full border border-[var(--sj-border)]"
                    :class="priorityClass(t.priority)"
                    x-text="'–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ' + (t.priority || 'normal')"></span>
              <span class="text-[11px] text-[color:var(--sj-muted)]" x-text="t.require_proof ? '—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç' : '–±–µ–∑ –æ—Ç—á—ë—Ç–∞'"></span>
            </div>

            <div class="text-sm mt-1" x-text="t.description"></div>

            <div class="text-xs mt-1 text-[color:var(--sj-muted)]">
              –ù–∞–≥—Ä–∞–¥–∞:
              <b class="text-emerald-400" x-text="t.points_xp + ' XP'"></b>,
              <b class="text-amber-400"   x-text="t.coins + ' ü™ô'"></b>
              <span x-show="t.due_at"> ¬∑ –¥–µ–¥–ª–∞–π–Ω:
                <span x-text="fmtDate(t.due_at)"></span>
              </span>
              <span x-show="t.due_at" class="ml-2"
                    :class="t.is_due_passed ? 'text-rose-400' : 'text-emerald-400'"
                    x-text="t.is_due_passed ? '—Å—Ä–æ–∫ –∏—Å—Ç—ë–∫' : '—Å—Ä–æ–∫ –Ω–µ –∏—Å—Ç—ë–∫'"></span>
            </div>

            <div class="text-xs mt-1"
                 :class="assignClass(t.assign_status)"
                 x-show="t.assign_status"
                 x-text="assignText(t.assign_status)">
            </div>
          </div>

          <div class="shrink-0 flex items-center gap-2">
            <template x-if="canCreateTasks">
              <button class="btn btn-outline" @click="openTaskModal('edit', t)">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            </template>

            <template x-if="t.submittable">
              <div class="flex items-center gap-2">
                <input type="file" class="hidden" :id="'proof_'+t.id" @change="submitProof(t.id, $event)">
                <button class="btn btn-sky" @click="document.getElementById('proof_'+t.id).click()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
              </div>
            </template>
          </div>
        </div>
      </template>
      <div x-show="tasks.length===0" class="text-sm text-[color:var(--sj-muted)]">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.</div>

      <div class="flex justify-end" x-show="canCreateTasks">
        <button class="btn btn-indigo" @click="openTaskModal('create')">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>
    </div>
  </div>

  <!-- ===== PEOPLE ===== -->
  <div x-show="tab==='people'" x-transition.opacity class="space-y-4 fade-enter">
    <div class="card p-4">
      <div class="flex flex-wrap items-center gap-2">
        <h3 class="text-lg font-semibold">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3>
        <span class="badge" x-text="people.items?.length ? ('–≤—Å–µ–≥–æ: '+people.total) : '‚Äî'"></span>

        <div class="ml-auto flex flex-wrap items-center gap-2">
          <input x-model.debounce.250ms="filters.query" @input="applyPeopleFilters()"
                 class="input" placeholder="–ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email" style="min-width:240px">

          <select class="select" x-model="filters.role" @change="applyPeopleFilters()">
            <option value="all">–≤—Å–µ —Ä–æ–ª–∏</option>
            <option value="admin">—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã</option>
            <option value="user">—Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
          </select>

          <select class="select" x-model="filters.sort" @change="applyPeopleFilters()">
            <option value="name_asc">–∏–º—è ‚Üë</option>
            <option value="name_desc">–∏–º—è ‚Üì</option>
            <option value="level_desc">—É—Ä–æ–≤–µ–Ω—å ‚Üì</option>
            <option value="level_asc">—É—Ä–æ–≤–µ–Ω—å ‚Üë</option>
          </select>

          <select class="select" x-model.number="people.per_page" @change="loadPeople(1,true)">
            <option :value="10">10</option>
            <option :value="20">20</option>
            <option :value="50">50</option>
            <option :value="100">100</option>
          </select>

          <button class="btn btn-emerald" @click="openCreateAdmin()">+ –ê–¥–º–∏–Ω</button>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <template x-if="loading.people">
        <div class="mt-3 space-y-2">
          <div class="skeleton h-12 rounded-lg"></div>
          <div class="skeleton h-12 rounded-lg"></div>
          <div class="skeleton h-12 rounded-lg"></div>
        </div>
      </template>

      <div class="table-wrap mt-3" x-show="!loading.people">
        <table class="text-sm">
          <thead>
            <tr>
              <th>ID</th><th>–ò–º—è</th><th>Email</th><th>–†–æ–ª—å</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th class="text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="u in people.items" :key="u.id">
              <tr>
                <td x-text="u.id"></td>
                <td><div class="font-medium" x-text="u.display_name || '‚Äî'"></div></td>
                <td x-text="u.email"></td>
                <td>
                  <span class="badge" :class="u.is_admin ? 'border-emerald-500/40' : ''" x-text="u.is_admin ? '–∞–¥–º–∏–Ω' : '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫'"></span>
                </td>
                <td x-text="u.level != null ? u.level : '‚Äî'"></td>
                <td class="text-right">
                  <div class="flex justify-end gap-2">
                    <button class="btn btn-sky"   x-show="!u.is_admin" @click="setCompanyAdmin(u.id,true)">–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
                    <button class="btn btn-amber" x-show="u.is_admin"  @click="setCompanyAdmin(u.id,false)">–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞</button>
                    <button class="btn btn-rose"  @click="removeFromCompany(u.id)">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
        <div x-show="!people.items?.length" class="text-sm p-4 text-[color:var(--sj-muted)]">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
      </div>

      <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
      <div class="flex items-center justify-between mt-3" x-show="(people.total||0) > (people.per_page||20)">
        <button class="btn btn-ghost text-sm py-1.5" :disabled="people.page<=1" @click="loadPeople(people.page-1,true)">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="text-xs text-[color:var(--sj-muted)]">
          –°—Ç—Ä. <b x-text="people.page||1"></b> / <b x-text="Math.ceil((people.total||0)/(people.per_page||20))"></b>
        </div>
        <button class="btn btn-ghost text-sm py-1.5"
                :disabled="(people.page||1) >= Math.ceil((people.total||0)/(people.per_page||20))"
                @click="loadPeople(people.page+1,true)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ===== STORE ===== -->
  <div x-show="tab==='store'" x-transition.opacity class="space-y-4 fade-enter">
    <div class="card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">–ú–∞–≥–∞–∑–∏–Ω –∫–æ–º–ø–∞–Ω–∏–∏</h3>
        <div class="flex items-center gap-2">
          <button class="btn btn-sky" @click="openStoreModal('create')">Ôºã –¢–æ–≤–∞—Ä</button>
          <button class="btn btn-outline" @click="loadStore(true)">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <template x-if="loading.store">
        <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-3">
          <div class="card p-3 skeleton h-28 rounded-xl"></div>
          <div class="card p-3 skeleton h-28 rounded-xl"></div>
          <div class="card p-3 skeleton h-28 rounded-xl"></div>
        </div>
      </template>

      <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-3" x-show="!loading.store">
        <template x-for="i in store.items" :key="i.id">
          <div class="card p-3 hover-lift">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-semibold truncate" x-text="i.title"></div>
                <div class="text-xs mt-0.5 text-[color:var(--sj-muted)]">
                  —Ç–∏–ø: <b x-text="i.type"></b> ‚Ä¢ —Ü–µ–Ω–∞: <b x-text="i.cost_coins"></b> ‚Ä¢ –º–∏–Ω. —É—Ä.: <b x-text="i.min_level"></b>
                </div>
                <div class="text-xs mt-0.5 text-[color:var(--sj-muted)]">
                  stock: <b x-text="i.stock ?? '‚àû'"></b>
                </div>
              </div>
              <div class="shrink-0">
                <div class="toggle" role="switch" :aria-checked="i.is_active?'true':'false'"
                     :class="i.is_active ? 'is-on' : ''" @click="toggleStoreItem(i)"></div>
              </div>
            </div>

            <div class="mt-2 flex gap-2">
              <button class="btn btn-outline" @click="openStoreModal('edit', i)">–†–µ–¥–∞–∫—Ç.</button>
              <button class="btn btn-rose" @click="deleteStoreItem(i.id)">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </template>
      </div>

      <div x-show="!loading.store && !store.items?.length" class="text-sm text-[color:var(--sj-muted)]">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
    </div>
  </div>

  <!-- ===== CRM (—Å—Ç–∞—Ç—É—Å + –∫–Ω–æ–ø–∫–∞) ===== -->
  <div x-show="tab==='crm'" x-transition.opacity class="space-y-4 fade-enter">
    <div class="card p-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-semibold">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è amo/Kommo</div>
          <div class="text-sm text-[color:var(--sj-muted)]">
            <template x-if="crm.loading">
              <span class="inline-flex items-center gap-2"><i class="bi bi-arrow-repeat animate-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å‚Ä¶</span>
            </template>
            <template x-if="!crm.loading">
              <span>
                <template x-if="crm.connected">
                  <span>
                    –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ <b x-text="crm.base_domain"></b>.
                    <span x-show="crm.token_expires_at"> –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç: <b x-text="human(crm.token_expires_at)"></b>.</span>
                    <span> –û–±–Ω–æ–≤–ª–µ–Ω–æ: <b x-text="crm.last_sync_at||'‚Äî'"></b></span>
                  </span>
                </template>
                <span x-show="!crm.connected">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.</span>
              </span>
            </template>
          </div>
        </div>
        <div class="shrink-0 flex flex-wrap items-center gap-2">
          <a class="btn btn-indigo" :href="`/partner/company/${companyId}/crm`">–ü–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CRM</a>
          <button class="btn btn-outline" @click="loadCrm()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        </div>
      </div>
    </div>

    <div class="card p-4">
      <div class="text-sm text-[color:var(--sj-muted)]">
        –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø—Ä–∏–≤—è–∑–∫–æ–π –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ CRM¬ª.
      </div>
    </div>
  </div>

  <!-- ===== –ú–æ–¥–∞–ª–∫–∏ (tasks/store/admin/invite) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –ª–æ–≥–∏–∫–µ, —Ç–æ–ª—å–∫–æ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞ –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π ===== -->
  <!-- TASK MODAL -->
  <div x-show="taskModal.open" x-transition.opacity x-cloak>
    <div class="fixed inset-0" style="background:rgba(0,0,0,.55)" @click="closeTaskModal()"></div>
    <div class="fixed inset-x-0 top-[6%] mx-auto max-w-2xl z-50 card p-5" @click.stop>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold" x-text="taskModal.mode==='create' ? '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞' : '–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É'"></h3>
        <button class="btn btn-ghost px-3" @click="closeTaskModal()">‚úï</button>
      </div>

      <div class="px-1 py-4 max-h-[75vh] overflow-y-auto overscroll-contain">
        <div class="mt-2 grid gap-3">
          <input x-model="taskModal.form.title" class="input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
          <textarea x-model="taskModal.form.description" class="textarea h-28" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-[color:var(--sj-muted)]">XP</label>
              <input x-model.number="taskModal.form.points_xp" type="number" class="input">
            </div>
            <div>
              <label class="text-xs text-[color:var(--sj-muted)]">–ö–æ–∏–Ω—ã</label>
              <input x-model.number="taskModal.form.coins" type="number" class="input">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-[color:var(--sj-muted)]">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
              <select x-model="taskModal.form.priority" class="select">
                <option value="low">low</option>
                <option value="normal">normal</option>
                <option value="high">high</option>
                <option value="critical">critical</option>
              </select>
            </div>
            <div class="flex items-end">
              <label class="inline-flex items-center gap-2 text-xs text-[color:var(--sj-muted)]">
                <input type="checkbox" x-model="taskModal.form.require_proof" class="rounded"> –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç —Å —Ñ–æ—Ç–æ
              </label>
            </div>
          </div>

          <div>
            <label class="text-xs text-[color:var(--sj-muted)]">–î–µ–¥–ª–∞–π–Ω (–¥–∞—Ç–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="date" x-model="taskModal.form._due_date" class="input">
          </div>

          <div>
            <label class="text-xs text-[color:var(--sj-muted)]">ID –∞—á–∏–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input x-model.number="taskModal.form.reward_achievement_id" type="number" class="input" placeholder="–ù–∞–ø—Ä., 3">
          </div>
        </div>

        <!-- Members -->
        <div class="mt-5">
          <div class="text-sm font-semibold">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>

          <div class="mt-2 flex flex-wrap gap-2" x-show="taskModal.selectedIds.length">
            <template x-for="uid in taskModal.selectedIds" :key="uid">
              <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full border border-[var(--sj-border)] bg-[color-mix(in_oklab,var(--sj-elev)_92%,transparent)]">
                <span x-text="nameById(uid)"></span>
                <button class="hover:text-rose-400" @click="tmUnselect(uid)">‚úï</button>
              </span>
            </template>
          </div>

          <div class="mt-2">
            <input x-model="taskModal.query" @input="tmSearchMembers" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email" class="input">
          </div>

          <div class="mt-3 max-h-64 overflow-auto divide-y" style="border-color:var(--sj-border)">
            <template x-for="m in taskModal.members" :key="m.id">
              <label class="flex items-center gap-3 py-2 px-1 cursor-pointer">
                <input type="checkbox"
                       :value="String(m.id)"
                       :checked="taskModal.selectedIds.includes(String(m.id))"
                       @change="tmToggleSelect(m.id)">
                <div class="leading-tight">
                  <div class="font-medium" x-text="m.display_name"></div>
                  <div class="text-xs text-[color:var(--sj-muted)]" x-text="m.email"></div>
                </div>
              </label>
            </template>
            <div class="text-sm py-6 text-center text-[color:var(--sj-muted)]" x-show="!taskModal.members.length">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-3" style="border-top:1px solid var(--sj-border)">
        <button class="btn btn-ghost" @click="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-indigo disabled:opacity-50"
                :disabled="!taskModal.form.title?.trim()"
                @click="saveTask()"
                x-text="taskModal.mode==='create' ? '–°–æ–∑–¥–∞—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'">
        </button>
      </div>
    </div>
  </div>

  <!-- STORE MODAL -->
  <div x-show="storeModal.open" x-transition.opacity x-cloak>
    <div class="fixed inset-0" style="background:rgba(0,0,0,.55)" @click="closeStoreModal()"></div>
    <div class="fixed inset-x-0 top-[6%] mx-auto max-w-2xl z-50 card p-5" @click.stop>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold" x-text="storeModal.mode==='create' ? '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä' : '–ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä'"></h3>
        <button class="btn btn-ghost px-3" @click="closeStoreModal()">‚úï</button>
      </div>

      <div class="px-1 py-4 max-h-[75vh] overflow-y-auto overscroll-contain">
        <div class="grid gap-3">
          <select x-model="storeModal.form.type" class="select">
            <option value="skin">skin</option>
            <option value="coupon">coupon</option>
            <option value="merch">merch</option>
          </select>
          <input x-model="storeModal.form.title" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          <div class="grid grid-cols-3 gap-2">
            <input x-model.number="storeModal.form.cost_coins" type="number" class="input" placeholder="–¶–µ–Ω–∞ ü™ô">
            <input x-model.number="storeModal.form.min_level"  type="number" class="input" placeholder="–ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å">
            <input x-model="storeModal.form.stock" class="input" placeholder="stock (–ø—É—Å—Ç–æ = ‚àû)">
          </div>
          <textarea x-model="storeModal.form.payload" class="textarea" rows="4" placeholder='JSON payload, –Ω–∞–ø—Ä. {"slot":"frame","key":"frame_gold","auto_equip":true}'></textarea>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-3" style="border-top:1px solid var(--sj-border)">
        <button class="btn btn-ghost" @click="closeStoreModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-sky" @click="saveStoreItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- CREATE ADMIN MODAL -->
  <div x-show="adminModal.open" x-transition.opacity x-cloak>
    <div class="fixed inset-0" style="background:rgba(0,0,0,.55)" @click="closeAdminModal()"></div>
    <div class="fixed inset-x-0 top-[12%] mx-auto max-w-md z-50 card p-5" @click.stop>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">–°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞ –∫–æ–º–ø–∞–Ω–∏–∏</h3>
        <button class="btn btn-ghost px-3" @click="closeAdminModal()">‚úï</button>
      </div>
      <div class="px-1 py-4 grid gap-3">
        <input class="input" placeholder="email" x-model="adminModal.form.email">
        <input class="input" type="password" placeholder="–ø–∞—Ä–æ–ª—å" x-model="adminModal.form.password">
        <input class="input" placeholder="–∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" x-model="adminModal.form.display_name">
      </div>
      <div class="flex justify-end gap-2 pt-3" style="border-top:1px solid var(--sj-border)">
        <button class="btn btn-ghost" @click="closeAdminModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-emerald" @click="createCompanyAdmin()">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- INVITE MODAL -->
  <div x-show="inviteModal" x-transition.opacity x-cloak>
    <div class="fixed inset-0" style="background:rgba(0,0,0,.55)" @click="inviteModal=false"></div>
    <div class="fixed inset-x-0 top-[12%] mx-auto max-w-lg z-50 card p-5" @click.stop>
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">–ò–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–∞</h3>
        <button class="btn btn-ghost px-3" @click="inviteModal=false">‚úï</button>
      </div>
      <div class="px-1 py-4">
        <template x-if="invite">
          <div class="space-y-2">
            <div class="text-sm text-[color:var(--sj-muted)]">–ü–µ—Ä–µ–¥–∞–π—Ç–µ —Å—Å—ã–ª–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:</div>
            <div class="muted p-2 rounded-lg">
              <code class="text-xs break-all" x-text="invite.url || invite.invite_url || ''"></code>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-indigo" @click="copy(invite.url || invite.invite_url)">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-amber" @click="regenerateInvite()">–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-rose" @click="deactivateInvite()">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>
        </template>
        <div x-show="!invite" class="text-sm text-[color:var(--sj-muted)]">–°—Å—ã–ª–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.</div>
      </div>
    </div>
  </div>

</section>
{% endblock %}

{% block scripts %}
<script>
/* ===== API client with abort support for fast filters ===== */
function createApi(){
  const withCreds = { credentials:'same-origin' };
  const ctrls = new Map(); // key -> AbortController
  async function parse(r){
    let j=null; try{ j=await r.json(); }catch(_){}
    if(!r.ok){ throw new Error(j?.description || j?.detail || j?.message || `HTTP ${r.status}`); }
    return j ?? {};
  }
  async function get(u, key=null){
    const opts={...withCreds};
    if(key){
      if(ctrls.has(key)) ctrls.get(key).abort();
      const ac=new AbortController(); ctrls.set(key, ac); opts.signal=ac.signal;
    }
    return parse(await fetch(u, opts));
  }
  async function del(u){ return parse(await fetch(u, {...withCreds, method:'DELETE'})); }
  async function post(u, body){
    const opts={...withCreds, method:'POST'};
    if(body instanceof FormData){ opts.body=body; }
    else { opts.headers={'Content-Type':'application/json'}; opts.body=JSON.stringify(body||{}); }
    return parse(await fetch(u, opts));
  }
  async function put(u, body){
    const opts={...withCreds, method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{})};
    return parse(await fetch(u, opts));
  }
  return {get, post, put, del};
}
const API = createApi();

/* ===== Helpers ===== */
function isoFromLocalDateEnd(s){ if(!s) return null; const dt=new Date(`${s}T23:59:59`); return dt.toISOString(); }

window.partnerCompanyPageEnh = function(initialCompanyId, companySlug){
  return {
    /* theme (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π __setTheme –∏–∑ base.html) */
    theme: (document.documentElement.dataset.theme || (document.documentElement.classList.contains('dark')?'dark':'light')),
    toggleTheme(){ window.__setTheme(this.theme==='dark'?'light':'dark'); this.theme = document.documentElement.dataset.theme; },

    /* state */
    companyId: initialCompanyId, company:null, kpi:{}, feed:[], tasks:[], leaderboard:[], tab:'feed',
    canPost:false, canCreateTasks:false, posting:false,
    loading:{ page:true, feed:true, tasks:true, people:false, store:false, crm:false },
    netError:false,

    // FEED form
    newPost:'', newPinned:false, newPostFile:null, newPostPreview:'',

    // dialogs
    inviteModal:false, invite:null,
    adminModal:{ open:false, form:{ email:'', password:'', display_name:'' } },
    storeModal:{ open:false, mode:'create', id:null, form:{ type:'skin', title:'', cost_coins:0, min_level:0, stock:'', payload:'' } },

    // tasks modal
    taskModal:{ open:false, mode:'create', taskId:null,
      form:{ title:'', description:'', points_xp:20, coins:5, due_at:'', priority:'normal', require_proof:true, reward_achievement_id:null, _due_date:'' },
      query:'', members:[], selectedIds:[], _byId:Object.create(null)
    },

    // people + filters (persist)
    people:{ items:[], page:1, per_page:20, total:0 },
    filters:{ query:'', role:'all', sort:'name_asc' },

    // store
    store:{ items:[] },

    // crm
    crm:{ connected:false, base_domain:'', last_sync_at:null, token_expires_at:null, loading:false },

    get headerSubtitle(){ return this.company ? `${this.company.name} (${this.company.slug||''})` : '–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π'; },

    toast(msg, emoji='‚ÑπÔ∏è'){ const s=Alpine.store?.('toasts'); if(s?.push) s.push({title:String(msg), emoji}); else alert(msg); },
    copy(v){ navigator.clipboard?.writeText(v).then(()=> Alpine.store('toasts')?.push?.({title:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', emoji:'üìã'})); },
    human(ts){ try{ const d=new Date((typeof ts==='number' && ts<4e9)? ts*1000 : ts); return d.toLocaleString(); }catch(e){ return ts || '‚Äî'; } },
    fmtDate(s){ const d=new Date(s); return isNaN(d)?'':d.toLocaleDateString(); },
    fmtDateTime(s){ const d=new Date(s); return isNaN(d)?'':d.toLocaleString(); },
    priorityClass(p){ return {'text-emerald-400':p==='low','text-sky-400':p==='normal','text-amber-400':p==='high','text-rose-400':p==='critical'}; },
    assignClass(st){ return {'text-sky-400':st==='assigned','text-emerald-400':st==='approved','text-rose-400':st==='rejected'}; },
    assignText(st){ return st==='assigned'?'–ù–∞–∑–Ω–∞—á–µ–Ω–∞':(st==='approved'?'–ó–∞—á—Ç–µ–Ω–∞':'–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'); },

    setTab(t){ this.tab=t; localStorage.setItem(this._ls('tab'), t); },

    _ls(suffix){ return `sj:company:${this.companyId || 'none'}:${suffix}`; },

    async init(){
      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–±/—Ñ–∏–ª—å—Ç—Ä—ã
      try{
        const savedTab = localStorage.getItem(this._ls('tab')); if(savedTab) this.tab = savedTab;
        const pf = localStorage.getItem(this._ls('peopleFilters')); if(pf){ Object.assign(this.filters, JSON.parse(pf)); }
        const per = Number(localStorage.getItem(this._ls('peoplePerPage'))||'0'); if(per>0) this.people.per_page = per;
      }catch(_){}

      await this.loadDashboard();
      this.loading.page=false;

      // –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ—Å–ª–µ OAuth
      try{ const p = new URLSearchParams(location.search); if(p.get('crm')==='connected'){ this.setTab('crm'); await this.loadCrm(); } }catch(_){}

      // –∞–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
      if(this.tab==='people') this.loadPeople(1,true);
      if(this.tab==='store') this.loadStore(true);
      if(this.tab==='crm')   this.loadCrm();
    },

    /* DASHBOARD */
    async loadDashboard(){
      this.netError=false; this.loading.feed=true; this.loading.tasks=true;
      try{
        const d=await API.get(`/api/partners/company/${this.companyId}/dashboard`);
        const dd=d.dashboard || d.data || d;
        this.company=dd.company || dd.company_info || null;
        this.kpi=dd.kpi || dd.stats || {};
        this.feed=dd.feed || dd.company_feed || dd.posts || [];
        this.tasks=dd.tasks || dd.company_tasks || [];
        this.leaderboard=dd.leaderboard || dd.top || [];
        const perms=dd.permissions || dd.perms || {};
        this.canPost=!!(perms.can_create_feed ?? perms.can_manage ?? false);
        this.canCreateTasks=!!(perms.can_create_tasks ?? perms.can_manage ?? false);
      }catch(e){ this.netError=true; this.toast(e.message,'‚õî'); }
      finally{ this.loading.feed=false; this.loading.tasks=false; }
    },

    /* FEED */
    async createPost(){
      if(!this.newPost.trim() && !this.newPostFile) return;
      this.posting=true;
      try{
        if(this.newPostFile){
          const fd=new FormData(); fd.append('text', this.newPost||''); fd.append('pinned', this.newPinned ? '1':'0'); fd.append('photo', this.newPostFile);
          await API.post(`/api/partners/company/${this.companyId}/feed`, fd);
        }else{
          await API.post(`/api/partners/company/${this.companyId}/feed`, {text:this.newPost, pinned:this.newPinned});
        }
        this.newPost=''; this.newPinned=false; this.clearNewPostFile();
        await this.loadDashboard();
      }catch(e){ this.toast(e.message,'‚õî'); }
      finally{ this.posting=false; }
    },
    onNewPostFile(ev){ const f=ev.target.files?.[0]; if(!f){ this.clearNewPostFile(); return; } if(this.newPostPreview) URL.revokeObjectURL(this.newPostPreview); this.newPostFile=f; this.newPostPreview=URL.createObjectURL(f); },
    clearNewPostFile(){ this.newPostFile=null; if(this.newPostPreview){ URL.revokeObjectURL(this.newPostPreview); this.newPostPreview=''; } this.$refs?.newPostImageInput && (this.$refs.newPostImageInput.value=''); },

    /* TASKS */
    async submitProof(taskId, ev){
      const input=ev.target; const file=input.files?.[0]; if(!file) return;
      const fd=new FormData(); fd.append('photo', file);
      try{
        const r=await fetch(`/api/company/tasks/${taskId}/submit`, {method:'POST', body:fd, credentials:'same-origin'});
        if(!r.ok){ let err=null; try{ err=await r.json(); }catch(_){ } this.toast(err?.description||'–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç','‚õî'); return; }
        this.toast('–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω','üì§'); input.value=''; await this.loadDashboard();
      }catch(_e){ this.toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞','‚õî'); }
    },
    openTaskModal(mode, task=null){
      this.taskModal.open=true; document.body.style.overflow='hidden';
      this.taskModal.mode=mode; this.taskModal.taskId=null;
      this.taskModal.form={ title:'', description:'', points_xp:20, coins:5, due_at:'', priority:'normal', require_proof:true, reward_achievement_id:null, _due_date:'' };
      this.taskModal.selectedIds=[]; this.taskModal.query=''; this.taskModal.members=[]; this.taskModal._byId=Object.create(null);
      if(mode==='edit' && task){
        this.taskModal.taskId=task.id;
        const toLocal=(iso)=>{ if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
        this.taskModal.form={ title:task.title||'', description:task.description||'', points_xp:task.points_xp??20, coins:task.coins??5, due_at:task.due_at||'', _due_date:task.due_at?toLocal(task.due_at):'', priority:task.priority||'normal', require_proof:!!task.require_proof, reward_achievement_id:task.reward_achievement_id??null };
        const preset=this.extractAssignedIds(task); this.taskModal.selectedIds=preset.length?preset:[];
      }
      this.tmFetchMembers();
    },
    closeTaskModal(){ this.taskModal.open=false; document.body.style.overflow=''; this.taskModal.taskId=null; },
    extractAssignedIds(task){
      const out=[]; if(task){
        if(Array.isArray(task.assigned_user_ids)) out.push(...task.assigned_user_ids);
        else if(Array.isArray(task.assignees)) out.push(...task.assignees.map(a=> (typeof a==='object' ? (a.id??a.user_id) : a)));
        else if(Array.isArray(task.assigned)) out.push(...task.assigned);
        else if(Array.isArray(task.assigned_ids)) out.push(...task.assigned_ids);
      }
      return out.map(x=>String(x));
    },
    async tmFetchMembers(){
      try{
        const q=this.taskModal.query?`?query=${encodeURIComponent(this.taskModal.query)}`:'';  // supports ?query or ?q
        const d=await API.get(`/api/partners/company/${this.companyId}/members${q}`, 'members');
        this.taskModal.members=d.members||d.items||[]; this.taskModal._byId=Object.create(null);
        for(const m of this.taskModal.members){ this.taskModal._byId[String(m.id)]=m; }
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    tmSearchMembers(){ clearTimeout(this._tmTimer); this._tmTimer=setTimeout(()=>this.tmFetchMembers(), 250); },
    tmToggleSelect(id){ id=String(id); const i=this.taskModal.selectedIds.indexOf(id); if(i===-1) this.taskModal.selectedIds.push(id); else this.taskModal.selectedIds.splice(i,1); },
    tmUnselect(id){ id=String(id); const i=this.taskModal.selectedIds.indexOf(id); if(i!==-1) this.taskModal.selectedIds.splice(i,1); },
    nameById(id){ id=String(id); return this.taskModal._byId[id]?.display_name || `#${id}`; },
    async saveTask(){
      const cid=this.companyId; const body={...this.taskModal.form};
      body.due_at = (body._due_date && body._due_date.trim()) ? isoFromLocalDateEnd(body._due_date.trim()) : null; delete body._due_date;
      try{
        if(this.taskModal.mode==='create'){
          const created=await API.post(`/api/partners/company/${cid}/tasks`, body);
          const taskId=created?.task_id || created?.id;
          if(taskId && this.taskModal.selectedIds.length){
            try{ await API.post(`/api/partners/company/${cid}/tasks/${taskId}/assign`, { user_ids:this.taskModal.selectedIds.map(Number), replace:true }); }
            catch(e){ this.toast('–°–æ–∑–¥–∞–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤','‚ö†Ô∏è'); }
          }
          this.toast('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞','‚úÖ');
        }else{
          const taskId=this.taskModal.taskId; if(!taskId) return;
          await API.put(`/api/partners/company/${cid}/tasks/${taskId}`, body);
          try{ await API.post(`/api/partners/company/${cid}/tasks/${taskId}/assign`, { user_ids:this.taskModal.selectedIds.map(Number), replace:true }); }
          catch(e){ this.toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è','‚ö†Ô∏è'); }
          this.toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã','üíæ');
        }
      }catch(e){ this.toast(e.message,'‚õî'); }
      this.closeTaskModal(); await this.loadDashboard();
    },

    /* PEOPLE + filters */
    applyPeopleFilters(){
      localStorage.setItem(this._ls('peopleFilters'), JSON.stringify(this.filters));
      this.loadPeople(1, true);
    },
    sortLocal(items){
      const s=this.filters.sort;
      const byName = (a,b)=> (a.display_name||'').localeCompare(b.display_name||'', 'ru', {sensitivity:'base'});
      const byLevel = (a,b)=> (Number(b.level||0) - Number(a.level||0));
      if(s==='name_asc') items.sort(byName);
      if(s==='name_desc') items.sort((a,b)=>-byName(a,b));
      if(s==='level_desc') items.sort(byLevel);
      if(s==='level_asc') items.sort((a,b)=>-byLevel(a,b));
      return items;
    },
    filterLocal(items){
      const q=(this.filters.query||'').trim().toLowerCase();
      let arr = !q ? items : items.filter(u => (u.display_name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
      if(this.filters.role==='admin') arr = arr.filter(u=>!!u.is_admin);
      if(this.filters.role==='user')  arr = arr.filter(u=>!u.is_admin);
      return this.sortLocal(arr);
    },
    async loadPeople(page=1, showLoader=false){
      try{
        if(showLoader) this.loading.people=true;
        const params = new URLSearchParams();
        params.set('page', String(page)); params.set('per_page', String(this.people.per_page));
        if(this.filters.query?.trim()) params.set('query', this.filters.query.trim());
        const r = await API.get(`/api/partners/company/${this.companyId}/members?`+params.toString(), 'people');
        let items = r.members || r.items || r.data || [];
        // –ª–æ–∫–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç–∏
        items = this.filterLocal(items);
        this.people.items = items;
        this.people.page = r.page || page;
        this.people.per_page = r.per_page || r.limit || this.people.per_page;
        this.people.total = r.total || r.count || items.length;
        localStorage.setItem(this._ls('peoplePerPage'), String(this.people.per_page));
      }catch(e){ this.toast(e.message,'‚õî'); }
      finally{ this.loading.people=false; }
    },
    async setCompanyAdmin(userId, makeAdmin){
      const cid=this.companyId;
      const tries = makeAdmin
        ? [
            [`/api/partners/company/${cid}/admins`, 'POST', { user_id:userId }],
            [`/api/partners/company/${cid}/members/${userId}/admin`, 'PUT', { is_admin:true }],
            [`/api/partners/company/${cid}/admin/${userId}`, 'POST', {}],
          ]
        : [
            [`/api/partners/company/${cid}/admins/${userId}`, 'DELETE', {}],
            [`/api/partners/company/${cid}/members/${userId}/admin`, 'PUT', { is_admin:false }],
            [`/api/partners/company/${cid}/admin/${userId}`, 'DELETE', {}],
          ];
      let ok=false, err=null;
      for(const [u,m,b] of tries){
        try{
          if(m==='POST') await API.post(u,b);
          else if(m==='PUT') await API.put(u,b);
          else await API.del(u);
          ok=true; break;
        }catch(e){ err=e; }
      }
      if(ok){ this.toast(makeAdmin?'–ù–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–æ–º':'–°–Ω—è—Ç —Å –∞–¥–º–∏–Ω–æ–≤','‚úÖ'); this.loadPeople(this.people.page,true); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å','‚õî'); }
    },
    async removeFromCompany(userId){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏?')) return;
      const cid=this.companyId;
      const tries = [
        `/api/partners/company/${cid}/members/${userId}`,
        `/api/partners/company/${cid}/member/${userId}`,
        `/api/partners/company/${cid}/users/${userId}`,
      ];
      let ok=false, err=null;
      for(const u of tries){
        try{ await API.del(u); ok=true; break; }catch(e){ err=e; }
      }
      if(ok){ this.toast('–£–¥–∞–ª—ë–Ω','üóëÔ∏è'); this.loadPeople(this.people.page,true); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å','‚õî'); }
    },
    openCreateAdmin(){ this.adminModal.open=true; },
    closeAdminModal(){ this.adminModal.open=false; this.adminModal.form={ email:'', password:'', display_name:'' }; },
    async createCompanyAdmin(){
      const cid=this.companyId; const b={...this.adminModal.form};
      const tries = [
        () => API.post(`/api/partners/company/${cid}/admins`, b),
        () => API.post(`/api/partners/company/${cid}/admin`, b),
      ];
      let ok=false, err=null;
      for(const fn of tries){ try{ await fn(); ok=true; break; }catch(e){ err=e; } }
      if(ok){ this.toast('–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω','‚ú®'); this.closeAdminModal(); this.loadPeople(1,true); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞','‚õî'); }
    },

    /* STORE */
    async loadStore(showLoader=false){
      try{
        if(showLoader) this.loading.store=true;
        const r = await API.get(`/api/partners/company/${this.companyId}/store`, 'store');
        this.store.items = r.items || r.store || r.data || r || [];
      }catch(e){
        try{
          const r2 = await API.get(`/api/partners/company/${this.companyId}/shop`, 'store');
          this.store.items = r2.items || r2.store || r2.data || r2 || [];
        }catch(err){ this.toast(err.message,'‚õî'); }
      }finally{ this.loading.store=false; }
    },
    openStoreModal(mode, item=null){
      this.storeModal.open=true; this.storeModal.mode=mode; this.storeModal.id=null;
      this.storeModal.form={ type:'skin', title:'', cost_coins:0, min_level:0, stock:'', payload:'' };
      if(mode==='edit' && item){
        this.storeModal.id=item.id;
        this.storeModal.form={ type:item.type||'skin', title:item.title||'', cost_coins:Number(item.cost_coins||0), min_level:Number(item.min_level||0), stock:item.stock??'', payload:(typeof item.payload==='string'?item.payload: JSON.stringify(item.payload||{})) };
      }
    },
    closeStoreModal(){ this.storeModal.open=false; this.storeModal.id=null; },
    async saveStoreItem(){
      const cid=this.companyId; const b={...this.storeModal.form};
      if(b.payload && typeof b.payload==='string'){ try{ b.payload_json = JSON.parse(b.payload); }catch(_){ b.payload_json=null; } }
      const payload = { type:b.type, title:b.title, cost_coins:Number(b.cost_coins||0), min_level:Number(b.min_level||0), stock: b.stock===''? null : b.stock, payload: b.payload_json ?? b.payload ?? null };
      try{
        if(this.storeModal.mode==='create'){
          await API.post(`/api/partners/company/${cid}/store`, payload);
          this.toast('–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω','‚úÖ');
        }else{
          const id = this.storeModal.id;
          await API.put(`/api/partners/company/${cid}/store/${id}`, payload);
          this.toast('–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω','üíæ');
        }
        this.closeStoreModal(); this.loadStore(true);
      }catch(e){
        try{
          if(this.storeModal.mode==='create'){
            await API.post(`/api/partners/company/${cid}/shop/items`, payload);
          }else{
            await API.put(`/api/partners/company/${cid}/shop/items/${this.storeModal.id}`, payload);
          }
          this.toast(this.storeModal.mode==='create'?'–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω':'–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω','‚úÖ');
          this.closeStoreModal(); this.loadStore(true);
        }catch(err){ this.toast(err.message,'‚õî'); }
      }
    },
    async toggleStoreItem(item){
      const cid=this.companyId; const id=item.id; const next=!item.is_active;
      const bodies=[{is_active:next},{active:next}];
      let ok=false, err=null;
      for(const b of bodies){
        try{ await API.put(`/api/partners/company/${cid}/store/${id}`, b); ok=true; break; }catch(e){ err=e; }
      }
      if(!ok){
        try{ await API.put(`/api/partners/company/${cid}/shop/items/${id}`, {is_active:next}); ok=true; }catch(e){ err=e; }
      }
      if(ok){ item.is_active=next; this.toast(next?'–í–∫–ª—é—á–µ–Ω–æ':'–í—ã–∫–ª—é—á–µ–Ω–æ','üîÅ'); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å','‚õî'); }
    },
    async deleteStoreItem(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
      const cid=this.companyId;
      const tries = [
        `/api/partners/company/${cid}/store/${id}`,
        `/api/partners/company/${cid}/shop/items/${id}`
      ];
      let ok=false, err=null;
      for(const u of tries){ try{ await API.del(u); ok=true; break; }catch(e){ err=e; } }
      if(ok){ this.toast('–£–¥–∞–ª–µ–Ω–æ','üóëÔ∏è'); this.loadStore(true); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å','‚õî'); }
    },

    /* INVITES */
    async openInviteModal(){ this.inviteModal=true; try{ this.invite = await API.get(`/api/partners/company/${this.companyId}/invite`);}catch(e){ this.toast(e.message,'‚õî'); } },
    async regenerateInvite(){ try{ this.invite = await API.post(`/api/partners/company/${this.companyId}/invite/regenerate`,{});}catch(e){ this.toast(e.message,'‚õî'); } },
    async deactivateInvite(){ try{ this.invite = await API.post(`/api/partners/company/${this.companyId}/invite/deactivate`,{});}catch(e){ this.toast(e.message,'‚õî'); } },

    /* CRM */
    async loadCrm(){
      this.crm.loading=true;
      try{
        const s = await API.get(`/api/partners/company/${this.companyId}/crm/amocrm/status`, 'crm');
        this.crm.connected = !!(s.connected ?? s.linked);
        this.crm.base_domain = s.base_domain || s.account?.domain || '';
        this.crm.last_sync_at = s.last_sync_at || null;
        this.crm.token_expires_at = s.token_expires_at || null;
      }catch(e){ this.toast(e.message,'‚õî'); }
      finally{ this.crm.loading=false; }
    },
  }
}
</script>
{% endblock %}
