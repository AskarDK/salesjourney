<!DOCTYPE html>
<html lang="ru" x-data>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{{ title or "Sales Journey" }}</title>
  <meta name="theme-color" content="#0c1222" id="themeColorMeta">

  <!-- Tailwind (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Å–æ–±–µ—Ä–∏ —á–µ—Ä–µ–∑ CLI/PostCSS) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { brand: '#6D5CF7' },
          boxShadow: {
            soft: '0 10px 30px -12px rgba(0,0,0,.25)',
            'inner-soft': 'inset 0 1px 0 rgba(255,255,255,.04), inset 0 -1px 0 rgba(0,0,0,.08)'
          },
          transitionTimingFunction: { 'swift': 'cubic-bezier(.2,.8,.2,1)' }
        }
      }
    };
  </script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    body{font-family:'Inter',sans-serif}
    [x-cloak]{display:none!important}

    /* –†–∞—Å—Ç—è–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ header/footer */
    header.sticky > div[class*="max-w-"],
    header.sticky [class*="max-w-"].mx-auto,
    footer > div[class*="max-w-"],
    footer [class*="max-w-"].mx-auto{
      max-width: none !important;
      width: 100% !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
    }
    @media (max-width: 768px){
      header.sticky [class*="max-w-"],
      footer [class*="max-w-"]{
        max-width: none !important;
        width: 100% !important;
      }
    }
    header.sticky > div,
    footer > div{
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right: max(1rem, env(safe-area-inset-right));
    }

    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–¥ —à–∞–ø–∫–æ–π */
    .grad-anim { background: linear-gradient(90deg,#22d3ee,#6366f1,#22c55e,#f59e0b,#22d3ee); background-size: 300% 100%; animation: shift 12s ease infinite; }
    @keyframes shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    /* Skeleton */
    .skeleton{
      position:relative; overflow:hidden;
      background:linear-gradient(90deg, rgba(148,163,184,.15), rgba(148,163,184,.08), rgba(148,163,184,.15));
      background-size:200% 100%; animation:sk 1.4s linear infinite;
    }
    @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .hover-lift{ transition:transform .25s var(--swift, cubic-bezier(.2,.8,.2,1)), box-shadow .25s var(--swift, cubic-bezier(.2,.8,.2,1)); }
    .hover-lift:hover{ transform:translateY(-2px); box-shadow:var(--shadow, 0 10px 20px -12px rgba(0,0,0,.25)); }

    @media (prefers-reduced-motion: reduce){
      * { animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; scroll-behavior: auto !important; }
    }
  </style>

  <!-- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞: —Ç–æ–∫–µ–Ω—ã -->
  <script>
    (function(){
      try{
        const KEY='sj_theme';
        const saved = localStorage.getItem(KEY);
        const mode = saved || 'dark';
        const root = document.documentElement;
        const meta = document.getElementById('themeColorMeta');

        const DARK_BG      = '#0c1222';
        const DARK_ELEV    = '#121a30';
        const DARK_BORDER  = '#1c2a4a';
        const DARK_TEXT    = '#e9eeff';
        const DARK_MUTED   = '#a6b1cf';
        const DARK_PRIMARY = '#7c6cff';

        root.style.setProperty('--sj-bg',      DARK_BG);
        root.style.setProperty('--sj-elev',    DARK_ELEV);
        root.style.setProperty('--sj-border',  DARK_BORDER);
        root.style.setProperty('--sj-text',    DARK_TEXT);
        root.style.setProperty('--sj-muted',   DARK_MUTED);
        root.style.setProperty('--sj-primary', DARK_PRIMARY);

        root.classList.toggle('dark', mode==='dark');
        root.dataset.theme = mode;
        if (meta) meta.setAttribute('content', mode==='dark' ? DARK_BG : '#ffffff');

        window.__setTheme = function(m){
          const dark = m==='dark';
          root.classList.toggle('dark', dark);
          root.dataset.theme = m;
          localStorage.setItem(KEY, m);
          if (meta) meta.setAttribute('content', dark ? DARK_BG : '#ffffff');
          window.dispatchEvent(new CustomEvent('sj:theme', { detail:{ mode:m } }));
        };
      }catch(e){}
    })();
  </script>

  <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
  <script defer src="{{ url_for('static', filename='app.js') }}"></script>
  <script defer src="{{ url_for('static', filename='admin.js') }}"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="min-h-screen bg-white text-slate-900 dark:bg-[var(--sj-bg)] dark:text-[var(--sj-text)]">
  <!-- HEADER -->
  <header x-data="headerUI()" class="sticky top-0 z-40 border-b border-slate-200 dark:border-[var(--sj-border)] bg-white dark:bg-[var(--sj-bg)] transition-shadow">
    <div class="h-0.5 grad-anim"></div>

    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">

      <!-- –õ–û–ì–û + –ë–£–†–ì–ï–† -->
      <div class="flex items-center gap-3">
        <button class="md:hidden p-2 rounded-lg border border-slate-300 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)]"
                @click="toggleMobile()" :aria-expanded="mobileOpen.toString()" aria-controls="mobileNav" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
          <i x-show="!mobileOpen" class="bi bi-list text-xl"></i>
          <i x-show="mobileOpen" x-cloak class="bi bi-x-lg text-xl"></i>
        </button>

        <a href="/" class="text-xl font-extrabold tracking-tight hover:opacity-90 transition">
          <span class="bg-gradient-to-r from-indigo-400 via-cyan-400 to-emerald-400 text-transparent bg-clip-text">
            Sales Journey
          </span>
        </a>
      </div>

      {% set is_user = current_user is not none %}
      {% set is_partner = current_partner is not none %}
      {% set is_admin = current_admin is not none %}

      <!-- NAV (desktop) -->
      <nav class="hidden md:flex items-center gap-3">
        {% if is_user %}
          <a href="{{ url_for('page_training_list') }}" class="px-3 py-2 rounded-xl border border-transparent hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–ö—É—Ä—Å—ã</a>
          <a href="/contests" class="px-3 py-2 rounded-xl border border-transparent hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–ö–æ–Ω–∫—É—Ä—Å—ã</a>
          <a href="/store" class="px-3 py-2 rounded-xl border border-transparent hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–ú–∞–≥–∞–∑–∏–Ω</a>
          {% if current_user.company and is_manager(current_user.company.id) %}
            <a href="/company/requests" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–ó–∞—è–≤–∫–∏</a>
            <a href="/partner/reports" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
            <a href="/training/create" class="px-3 py-2 rounded-xl bg-[var(--sj-primary)] hover:opacity-90 text-white font-semibold hover-lift">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
          {% endif %}
        {% endif %}

        {% if is_partner %}
          <a href="/partner/company" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</a>
          <a href="/partner/training/create" class="px-3 py-2 rounded-xl bg-[var(--sj-primary)] hover:opacity-90 text-white font-semibold hover-lift">–ö—É—Ä—Å –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</a>
        {% endif %}

        {% if is_admin %}
          <a href="/partner/requests" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–ó–∞—è–≤–∫–∏</a>
          <a href="/partner/reports" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hover-lift">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
          <a href="{{ url_for('page_admin_dashboard') }}" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold hover-lift">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
        {% endif %}
      </nav>

      <!-- –ü—Ä–∞–≤—ã–π –±–ª–æ–∫ -->
      <div class="flex items-center gap-2 sm:gap-3">

        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
        <button class="rounded-xl border border-slate-300 dark:border-[var(--sj-border)] px-3 py-2 hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)]"
                @click="toggleTheme()" aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          <span class="flex items-center gap-2">
            <i class="bi bi-moon-stars-fill dark:hidden"></i>
            <i class="bi bi-sun-fill hidden dark:inline"></i>
            <span class="hidden sm:inline">–¢–µ–º–∞</span>
          </span>
        </button>

        {% if is_user %}
          <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
          <div class="relative" x-data="notifMenu()" @click.outside="open=false" @keydown.escape="open=false">
            <button @click.stop="toggle()"
                    class="relative rounded-xl border border-slate-300 dark:border-[var(--sj-border)] px-3 py-2 hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)]"
                    aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" aria-haspopup="menu" :aria-expanded="open.toString()">
              <i class="bi bi-bell"></i>
              <span x-show="unreadCount"
                    class="absolute -top-1 -right-1 text-[10px] px-1.5 rounded bg-rose-600 text-white"
                    x-text="unreadCount"></span>
            </button>

            <!-- –ü–∞–Ω–µ–ª—å -->
            <div x-show="open"
                 x-transition.opacity
                 class="absolute right-0 mt-2 z-50 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] bg-white dark:bg-[var(--sj-elev)] shadow-soft
                        min-w-[20rem] w-[22rem] sm:w-[26rem]">
              <!-- –®–∞–ø–∫–∞ -->
              <div class="sticky top-0 bg-white dark:bg-[var(--sj-elev)] rounded-t-xl px-2 py-2 border-b border-slate-200 dark:border-[var(--sj-border)]">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-medium text-slate-700 dark:text-[var(--sj-text)]">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                  <button class="text-xs flex items-center gap-1 text-slate-600 dark:text-[var(--sj-muted)] hover:text-slate-900 dark:hover:text-[var(--sj-text)]"
                          @click="markAllRead()">
                    <i class="bi bi-check2-all"></i> –ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ
                  </button>
                </div>

                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="mt-2 grid grid-cols-5 gap-1">
                  <button @click="setTab('all')"
                          class="px-2 py-1 rounded-lg text-xs border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]"
                          :class="{'bg-slate-100 dark:bg-[var(--sj-bg)] font-semibold': tab==='all'}">
                    –í—Å–µ <span class="opacity-70 ml-1" x-text="counts.all"></span>
                  </button>
                  <button @click="setTab('system')"
                          class="px-2 py-1 rounded-lg text-xs border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)] flex items-center gap-1"
                          :class="{'bg-slate-100 dark:bg-[var(--sj-bg)] font-semibold': tab==='system'}">
                    <i class="bi bi-gear text-[.9rem]"></i> <span x-text="counts.system"></span>
                  </button>
                  <button @click="setTab('review')"
                          class="px-2 py-1 rounded-lg text-xs border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)] flex items-center gap-1"
                          :class="{'bg-slate-100 dark:bg-[var(--sj-bg)] font-semibold': tab==='review'}">
                    <i class="bi bi-clipboard-check text-[.9rem]"></i> <span x-text="counts.review"></span>
                  </button>
                  <button @click="setTab('achievement')"
                          class="px-2 py-1 rounded-lg text-xs border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)] flex items-center gap-1"
                          :class="{'bg-slate-100 dark:bg-[var(--sj-bg)] font-semibold': tab==='achievement'}">
                    <i class="bi bi-trophy text-[.9rem]"></i> <span x-text="counts.achievement"></span>
                  </button>
                  <button @click="setTab('purchase')"
                          class="px-2 py-1 rounded-lg text-xs border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)] flex items-center gap-1"
                          :class="{'bg-slate-100 dark:bg-[var(--sj-bg)] font-semibold': tab==='purchase'}">
                    <i class="bi bi-bag text-[.9rem]"></i> <span x-text="counts.purchase"></span>
                  </button>
                </div>
              </div>

              <!-- –õ–æ–∞–¥–µ—Ä -->
              <template x-if="loading">
                <div class="p-2 space-y-2">
                  <div class="skeleton h-10 rounded-lg"></div>
                  <div class="skeleton h-10 rounded-lg"></div>
                </div>
              </template>

              <!-- –ü—É—Å—Ç–æ -->
              <div class="px-3 py-3 text-sm text-slate-500 dark:text-[var(--sj-muted)]" x-show="!loading && filtered.length===0">
                –ü–æ–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç.
              </div>

              <!-- –°–ø–∏—Å–æ–∫ -->
              <div class="max-h-[60vh] overflow-y-auto">
                <template x-for="n in filtered" :key="n.id || JSON.stringify(n)">
                  <a :href="n.href || '#'"
                     class="flex items-start gap-3 px-3 py-2 hover:bg-slate-50 dark:hover:bg-[var(--sj-bg)] border-b border-slate-100 dark:border-[var(--sj-border)] last:border-0">
                    <div class="mt-0.5 shrink-0">
                      <i :class="iconFor(n)"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                      <div class="flex items-center gap-2">
                        <div class="text-sm font-semibold text-slate-800 dark:text-[var(--sj-text)] truncate" x-text="n.title || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞'"></div>
                        <span x-show="!n.is_read" class="ml-1 inline-block w-1.5 h-1.5 rounded-full bg-[var(--sj-primary)]"></span>
                      </div>
                      <div class="text-xs text-slate-600 dark:text-[var(--sj-muted)] mt-0.5" x-text="n.body || ''"></div>
                    </div>
                    <div class="text-[10px] text-slate-400 dark:text-[var(--sj-muted)] whitespace-nowrap mt-0.5" x-text="fmtDate(n.created_at)"></div>
                  </a>
                </template>
              </div>
            </div>
          </div>

          <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
          <div class="relative" x-data="{open:false}" @keydown.escape="open=false">
            <button class="flex items-center gap-3 group" @click="open=!open" :aria-expanded="open.toString()" aria-haspopup="menu">
              <img src="{{ url_for('avatar_svg', user_id=current_user.id) }}?part=head&t={{ (current_user.updated_at.timestamp()|int) if current_user.updated_at else 0 }}"
                   alt="avatar" class="w-9 h-9 rounded-full ring-2 ring-slate-200 dark:ring-[var(--sj-border)] transition group-hover:ring-indigo-400">
              <span class="font-semibold hidden sm:inline">{{ current_user.display_name }}</span>
              <i class="bi bi-caret-down-fill text-xs opacity-60 hidden sm:inline"></i>
            </button>
            <div x-show="open" x-transition
                 class="absolute right-0 mt-2 w-56 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] bg-white dark:bg-[var(--sj-elev)] p-2 shadow-soft"
                 @click.outside="open=false" x-cloak role="menu">
              <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]" href="/profile" role="menuitem">
                <i class="bi bi-person-circle"></i> –ü—Ä–æ—Ñ–∏–ª—å
              </a>
              {% if current_user.company and is_manager(current_user.company.id) %}
              <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]" href="/company/requests" role="menuitem">
                <i class="bi bi-inboxes"></i> –ó–∞—è–≤–∫–∏
              </a>
              <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]" href="/partner/reports" role="menuitem">
                <i class="bi bi-clipboard-data"></i> –û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º
              </a>
              {% endif %}
              <button class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]"
                      onclick="fetch('/api/auth/logout',{method:'POST'}).then(()=>location.href('/login'))"
                      role="menuitem">
                <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
              </button>
            </div>
          </div>

        {% elif is_partner %}
          <div class="relative" x-data="{open:false}" @keydown.escape="open=false">
            <button class="flex items-center gap-3 group" @click="open=!open" :aria-expanded="open.toString()" aria-haspopup="menu">
              <div class="w-9 h-9 grid place-items-center rounded-full ring-2 ring-slate-200 dark:ring-[var(--sj-border)] bg-[color-mix(in_srgb,var(--sj-primary)_20%,transparent)] text-[var(--sj-primary)]">ü§ù</div>
              <span class="font-semibold hidden sm:inline">{{ current_partner.email }}</span>
              <i class="bi bi-caret-down-fill text-xs opacity-60 hidden sm:inline"></i>
            </button>
            <div x-show="open" x-transition
                 class="absolute right-0 mt-2 w-60 rounded-xl border border-slate-200 dark:border-[var(--sj-border)] bg-white dark:bg-[var(--sj-elev)] p-2 shadow-soft"
                 @click.outside="open=false" x-cloak role="menu">
              <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]" href="/partner/company" role="menuitem">
                <i class="bi bi-building"></i> –ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è
              </a>
              <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]" href="/partner/training/create" role="menuitem">
                <i class="bi bi-bookmark-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å
              </a>
              <button class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-bg)]"
                      onclick="fetch('/api/partners/auth/logout',{method:'POST'}).then(()=>location.href='/partner/login')"
                      role="menuitem">
                <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏ (–ø–∞—Ä—Ç–Ω—ë—Ä)
              </button>
            </div>
          </div>

        {% elif is_admin %}
          <form onsubmit="event.preventDefault(); fetch('/api/admin/logout',{method:'POST'}).then(()=>location.href='/admin/login')">
            <button class="px-3 py-2 rounded-xl border border-slate-300 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-shield-lock"></i> –í—ã–π—Ç–∏ (–∞–¥–º–∏–Ω)
            </button>
          </form>

        {% else %}
          <div class="hidden sm:flex items-center gap-2">
            <a href="/login" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-[var(--sj-elev)] dark:hover:bg-[var(--sj-bg)] border border-slate-200 dark:border-[var(--sj-border)] flex items-center gap-2">
              <i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏
            </a>
            <a href="/register" class="px-3 py-2 rounded-xl bg-[var(--sj-primary)] hover:opacity-90 text-white font-semibold flex items-center gap-2">
              <i class="bi bi-person-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </a>
            <a href="{{ url_for('page_admin_login') }}" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hidden md:inline-flex items-center gap-2">
              <i class="bi bi-shield-lock"></i> –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞
            </a>
            <a href="/partner/login" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] hidden md:inline-flex items-center gap-2">
              <i class="bi bi-people"></i> –í—Ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
            </a>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –∏ –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
    <div x-cloak x-show="mobileOpen" x-transition.opacity class="fixed inset-0 z-40 bg-black/40 backdrop-blur-sm md:hidden" @click="closeMobile()" aria-hidden="true"></div>

    <aside id="mobileNav" x-cloak x-show="mobileOpen"
           x-transition:enter="transition transform ease-out duration-200"
           x-transition:enter-start="-translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transition transform ease-in duration-150"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="-translate-x-full"
           class="fixed inset-0 z-50 w-full bg-white dark:bg-[var(--sj-bg)] shadow-soft md:hidden overscroll-contain">
      <div class="h-full w-full flex flex-col">
        <div class="p-4 flex items-center justify-between border-b border-slate-200 dark:border-[var(--sj-border)]">
          <span class="text-lg font-extrabold">–ù–∞–≤–∏–≥–∞—Ü–∏—è</span>
          <button class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)]"
                  @click="closeMobile()" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">
            <i class="bi bi-x-lg text-xl"></i>
          </button>
        </div>

        <nav class="p-3 flex-1 overflow-y-auto flex flex-col gap-2 text-sm">
          {% if is_user %}
            <a href="{{ url_for('page_training_list') }}" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-journals"></i> –ö—É—Ä—Å—ã
            </a>
            <a href="/contests" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-trophy"></i> –ö–æ–Ω–∫—É—Ä—Å—ã
            </a>
            <a href="/store" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-bag"></i> –ú–∞–≥–∞–∑–∏–Ω
            </a>
            {% if current_user.company and is_manager(current_user.company.id) %}
              <a href="/company/requests" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
                <i class="bi bi-inboxes"></i> –ó–∞—è–≤–∫–∏
              </a>
              <a href="/partner/reports" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
                <i class="bi bi-clipboard-data"></i> –û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º
              </a>
              <a href="/training/create" class="px-3 py-2 rounded-lg bg-[var(--sj-primary)] hover:opacity-90 text-white font-semibold flex items-center gap-2">
                <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å
              </a>
            {% endif %}
            <hr class="my-2 border-slate-200 dark:border-[var(--sj-border)]">
            <a href="/profile" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-person-circle"></i> –ü—Ä–æ—Ñ–∏–ª—å
            </a>
            <button class="text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2"
                    onclick="fetch('/api/auth/logout',{method:'POST'}).then(()=>location.href='/login')">
              <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
            </button>
          {% elif is_partner %}
            <a href="/partner/company" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-building"></i> –ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è
            </a>
            <a href="/partner/training/create" class="px-3 py-2 rounded-lg bg-[var(--sj-primary)] hover:opacity-90 text-white font-semibold flex items-center gap-2">
              <i class="bi bi-bookmark-plus"></i> –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å
            </a>
            <hr class="my-2 border-slate-200 dark:border-[var(--sj-border)]">
            <button class="text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2"
                    onclick="fetch('/api/partners/auth/logout',{method:'POST'}).then(()=>location.href='/partner/login')">
              <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏ (–ø–∞—Ä—Ç–Ω—ë—Ä)
            </button>
          {% elif is_admin %}
            <a href="/partner/requests" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-inboxes"></i> –ó–∞—è–≤–∫–∏
            </a>
            <a href="/partner/reports" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-clipboard-data"></i> –û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º
            </a>
            <a href="{{ url_for('page_admin_dashboard') }}" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-semibold flex items-center gap-2">
              <i class="bi bi-speedometer2"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            </a>
            <hr class="my-2 border-slate-200 dark:border-[var(--sj-border)]">
            <button class="text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2"
                    onclick="fetch('/api/admin/logout',{method:'POST'}).then(()=>location.href='/admin/login')">
              <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏ (–∞–¥–º–∏–Ω)
            </button>
          {% else %}
            <a href="/login" class="px-3 py-2 rounded-lg bg-slate-100 dark:bg-[var(--sj-elev)] hover:bg-slate-200 dark:hover:bg-[var(--sj-bg)] border border-slate-200 dark:border-[var(--sj-border)] flex items-center gap-2">
              <i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏
            </a>
            <a href="/register" class="px-3 py-2 rounded-lg bg-[var(--sj-primary)] hover:opacity-90 text-white font-semibold flex items-center gap-2">
              <i class="bi bi-person-plus"></i> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            </a>
            <hr class="my-2 border-slate-200 dark:border-[var(--sj-border)]">
            <a href="{{ url_for('page_admin_login') }}" class="px-3 py-2 rounded-lg border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-shield-lock"></i> –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∞
            </a>
            <a href="/partner/login" class="px-3 py-2 rounded-lg border border-slate-200 dark:border-[var(--sj-border)] hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center gap-2">
              <i class="bi bi-people"></i> –í—Ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
            </a>
          {% endif %}
        </nav>

        <div class="p-3 border-t border-slate-200 dark:border-[var(--sj-border)]">
          <button class="w-full rounded-lg border border-slate-300 dark:border-[var(--sj-border)] px-3 py-2 hover:bg-slate-100 dark:hover:bg-[var(--sj-elev)] flex items-center justify-center gap-2"
                  @click="toggleTheme()">
            <i class="bi bi-moon-stars-fill dark:hidden"></i>
            <i class="bi bi-sun-fill hidden dark:inline"></i>
            –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
          </button>
        </div>
      </div>
    </aside>
  </header>

  <!-- MAIN -->
  <main class="min-h-[80vh]">
    {% block content %}{% endblock %}
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-slate-200 dark:border-[var(--sj-border)] w-full">
    <div class="w-full px-4 py-8 grid sm:grid-cols-3 gap-6 text-sm text-slate-500 dark:text-[var(--sj-muted)] safe-x">
      <div class="text-left">¬© 2025 Sales Journey</div>
      <div class="sm:text-center">–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ—Ç —Ü–∏—Ñ—Ä—ã</div>
      <div class="sm:text-right">hello@salesjourney.app</div>
    </div>
  </footer>

  <!-- TOASTS -->
  <div class="fixed top-3 right-3 z-[100] space-y-3 w-[92vw] max-w-80" aria-live="polite">
    <template x-for="t in $store.toasts?.items || []" :key="t.id">
      <div x-show="t.show" x-transition.opacity.duration.200ms
           class="rounded-xl border border-slate-200 dark:border-[var(--sj-border)] shadow-xl bg-white dark:bg-[var(--sj-elev)] p-4 flex gap-3">
        <div class="text-2xl leading-none flex items-center justify-center">
          <i x-show="t.icon" :class="t.icon"></i>
          <span x-show="!t.icon">‚ú®</span>
        </div>
        <div class="flex-1">
          <div class="font-semibold text-slate-800 dark:text-[var(--sj-text)]" x-text="t.title"></div>
          <div class="text-sm text-slate-600 dark:text-[var(--sj-muted)]" x-text="t.text"></div>
        </div>
        <button class="text-slate-500 dark:text-[var(--sj-muted)] hover:text-slate-800 dark:hover:text-[var(--sj-text)]" @click="$store.toasts.dismiss(t.id)">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </template>
  </div>

  <!-- FX -->
  <canvas id="confetti" class="pointer-events-none fixed inset-0 z-[90]"></canvas>

  <!-- Scroll Top -->
  <button x-data="scrollTopBtn()" x-show="visible" x-transition.opacity
          @click="go()" aria-label="–ù–∞–≤–µ—Ä—Ö"
          class="fixed bottom-[max(1rem,env(safe-area-inset-bottom))] right-[max(1rem,env(safe-area-inset-right))] z-40
                 rounded-full p-3 bg-[var(--sj-primary)] hover:opacity-90 text-white shadow-soft float">
    <i class="bi bi-arrow-up"></i>
  </button>

  {% block scripts %}{% endblock %}

  <script>
    // Header UI
    function headerUI(){
      return {
        mobileOpen:false,
        toggleMobile(){ this.mobileOpen = !this.mobileOpen },
        closeMobile(){ this.mobileOpen = false },
        toggleTheme(){ window.__setTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark') }
      }
    }

    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–µ—Ä—Ö"
    function scrollTopBtn(){
      return {
        visible:false,
        init(){
          const onScroll = () => { this.visible = (window.scrollY || document.documentElement.scrollTop) > 400; };
          window.addEventListener('scroll', onScroll, { passive: true });
          onScroll();
        },
        go(){ window.scrollTo({top:0, behavior:'smooth'}); }
      }
    }

    // ===== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è) =====
    function notifMenu(){
      return {
        open:false,
        loading:false,
        tab:'all',
        items:[],
        unreadCount:0,
        counts:{ all:0, system:0, review:0, achievement:0, purchase:0 },

        toggle(){ this.open = !this.open; if(this.open && !this.items.length){ this.load(); } },
        setTab(t){ this.tab = t; },

        kind(n){ return (n.type || n.category || 'system').toString().toLowerCase(); },
        iconFor(n){
          const k = this.kind(n);
          return ({
            system: 'bi bi-gear',
            review: 'bi bi-clipboard-check',
            achievement: 'bi bi-trophy',
            purchase: 'bi bi-bag'
          }[k]) || 'bi bi-bell';
        },
        fmtDate(s){
          if(!s) return '';
          const d = new Date(s);
          return isNaN(d) ? '' : d.toLocaleString();
        },

        get filtered(){
          if(this.tab === 'all') return this.items;
          return this.items.filter(n => this.kind(n) === this.tab);
        },

        async load(){
          this.loading = true;
          try{
            const r = await fetch('/api/notifications', { credentials:'same-origin' });
            if(!r.ok) return;
            const data = await r.json().catch(()=>({}));
            let arr = Array.isArray(data?.notifications) ? data.notifications
                    : Array.isArray(data) ? data : [];

            arr = arr.map(n => ({ ...n, is_read: !!n.is_read, _kind: this.kind(n) }));

            this.items = arr;
            this.unreadCount = arr.filter(n => !n.is_read).length;

            const c = { system:0, review:0, achievement:0, purchase:0 };
            arr.forEach(n => { if (c[n._kind] !== undefined) c[n._kind]++; });
            this.counts = { all: arr.length, ...c };
          } finally {
            this.loading = false;
          }
        },

        async markAllRead(){
          try{
            const r = await fetch('/api/notifications/read', { method:'POST', credentials:'same-origin' });
            if(r.ok){
              this.items = this.items.map(n => ({ ...n, is_read:true }));
              this.unreadCount = 0;
            }
          }catch(_){}
        }
      }
    }

    // –¢–µ–Ω—å –¥–ª—è sticky header
    (function(){
      const hdr = document.querySelector('header.sticky');
      if(!hdr) return;
      const onScroll = () => {
        const sc = window.scrollY || document.documentElement.scrollTop;
        hdr.style.boxShadow = sc > 4 ? '0 8px 24px -18px rgba(0,0,0,.25)' : 'none';
      };
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    })();

    // Alpine store –¥–ª—è —Ç–æ—Å—Ç–æ–≤
    window.addEventListener('alpine:init', () => {
      Alpine.store('toasts', {
        id: 1, items: [],
        push(t){ const id=this.id++; const item={ id, icon:null, ...t, show:true }; this.items.push(item); setTimeout(()=>{ this.dismiss(id); }, 4000); },
        dismiss(id){ const it=this.items.find(x=>x.id===id); if(!it) return; it.show=false; setTimeout(()=>{ this.items=this.items.filter(x=>x.id!==id); }, 200); }
      });
    });
  </script>
</body>
</html>
