{% extends "base.html" %}
{% set title = "–í–æ–π—Ç–∏ ‚Äî Sales Journey" %}
{% block content %}

<section class="relative min-h-[70vh] py-16 overflow-hidden">
  <!-- –ú–æ–Ω–æ-—Å—Ç–∏–∫–µ—Ä—ã / —Ñ–æ–Ω -->
  <div aria-hidden="true" class="pointer-events-none absolute inset-0 -z-10">
    <!-- –°–ª–µ–≥–∫–∞ —Ä–∞–∑–º–∞–∑–∞–Ω–Ω—ã–µ –º–æ–Ω–æ-–∫—Ä—É–∂–∫–∏ -->
    <div class="absolute -top-12 -left-20 w-64 h-64 rounded-full blur-2xl opacity-[.12] bg-slate-400 dark:bg-slate-500"></div>
    <div class="absolute -bottom-16 -right-28 w-80 h-80 rounded-full blur-3xl opacity-[.10] bg-slate-400 dark:bg-slate-600"></div>

    <!-- ¬´–°—Ç–∏–∫–µ—Ä—ã¬ª ‚Äî –º–æ–Ω–æ, —Ç–æ–ª—å–∫–æ –±–æ—Ä–¥–µ—Ä/—Ç–µ–∫—Å—Ç -->
    <div class="absolute left-6 top-10 hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-xl border border-slate-300/60 dark:border-white/10 text-slate-500 dark:text-slate-300 opacity-70 backdrop-blur-sm animate-float-slow">
      <!-- –∫—É–±–æ–∫ -->
      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8 21h8M12 17v4M7 4h10v3a5 5 0 0 1-5 5h0a5 5 0 0 1-5-5V4Z"/><path d="M5 8a3 3 0 0 1-3-3V4h5M19 8a3 3 0 0 0 3-3V4h-5"/></svg>
      <span class="text-xs">–†–µ–π—Ç–∏–Ω–≥ —Ä–∞—Å—Ç—ë—Ç</span>
    </div>

    <div class="absolute right-8 top-24 hidden md:flex items-center gap-2 px-3 py-1.5 rounded-xl border border-slate-300/60 dark:border-white/10 text-slate-500 dark:text-slate-300 opacity-70 backdrop-blur-sm animate-float">
      <!-- —â–∏—Ç -->
      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3l7 4v5c0 4.97-3.05 9.25-7 10-3.95-.75-7-5.03-7-10V7l7-4Z"/></svg>
      <span class="text-xs">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—Ö–æ–¥</span>
    </div>

    <div class="absolute left-10 bottom-14 hidden md:flex items-center gap-2 px-3 py-1.5 rounded-xl border border-slate-300/60 dark:border-white/10 text-slate-500 dark:text-slate-300 opacity-70 backdrop-blur-sm animate-float-slower">
      <!-- –∑–≤–µ–∑–¥–æ—á–∫–∏ -->
      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3l1.9 3.86L18 8.27l-3 2.92.7 4.1L12 13.77 8.3 15.3l.7-4.1-3-2.92 4.1-1.41L12 3Z"/></svg>
      <span class="text-xs">–ê—á–∏–≤–∫–∏ –∂–¥—É—Ç</span>
    </div>
  </div>

  <div class="px-4">
    <div class="max-w-md mx-auto">
      <!-- –¢–æ–Ω–∫–∏–π –Ω–µ–æ–Ω–æ–≤—ã–π –∫–∞–Ω—Ç –±–µ–∑ —Ä–∞–¥—É–∂–Ω–æ—Å—Ç–∏ -->
      <div class="p-[1.5px] rounded-[28px] bg-slate-300/50 dark:bg-white/10">
        <div id="card"
             class="rounded-[26px] border border-white/10 bg-slate-900/60 backdrop-blur-xl p-6 md:p-8
                    transition-transform duration-300 hover:translate-y-[-1px]">

          <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–ª–∞–π–Ω (–≤ –æ–¥–∏–Ω —Ü–≤–µ—Ç) -->
          <div id="progressLine"
               class="h-0.5 -mx-6 md:-mx-8 -mt-6 md:-mt-8 rounded-t-[26px]
                      bg-indigo-500 opacity-0 transition-opacity duration-300"></div>

          <h1 class="text-3xl font-extrabold">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º üëã</h1>
          <p class="text-slate-300 mt-1.5">–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ—Ö–æ—Ç—É –∑–∞ –∞—á–∏–≤–∫–∞–º–∏.</p>

          <!-- –°—Ç–∞—Ç—É—Å -->
          <div id="status"
               class="mt-4 hidden rounded-xl border text-sm px-3 py-2"
               role="status" aria-live="polite"></div>

          <form id="loginForm" class="space-y-4 mt-6">
            <!-- Email -->
            <div>
              <label for="email" class="block text-sm mb-1">Email</label>
              <div class="relative">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">üìß</div>
                <input id="email" name="email" type="email" required autocomplete="username"
                       class="w-full rounded-xl bg-black/40 border border-white/10 pl-10 pr-3 py-2
                              focus:outline-none focus:ring focus:ring-indigo-500/30"
                       placeholder="you@example.com">
              </div>
            </div>

            <!-- –ü–∞—Ä–æ–ª—å -->
            <div>
              <label for="password" class="block text-sm mb-1">–ü–∞—Ä–æ–ª—å</label>
              <div class="relative">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">üîí</div>
                <input id="password" name="password" type="password" required autocomplete="current-password"
                       class="w-full rounded-xl bg-black/40 border border-white/10 pl-10 pr-10 py-2
                              focus:outline-none focus:ring focus:ring-indigo-500/30"
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <button type="button" id="togglePassword"
                        class="absolute inset-y-0 right-0 pr-3 text-slate-400 hover:text-slate-200"
                        aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅÔ∏è</button>
              </div>
              <div id="capsHint" class="mt-1 text-xs text-amber-300 hidden">–í–Ω–∏–º–∞–Ω–∏–µ: –≤–∫–ª—é—á—ë–Ω CapsLock</div>
            </div>

            <div class="flex items-center justify-between text-sm">
              <label class="inline-flex items-center gap-2 select-none">
                <input id="remember" type="checkbox" class="rounded border-white/10 bg-black/40">
                <span class="text-slate-300">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</span>
              </label>
              <a href="/reset" class="text-slate-400 hover:text-slate-200">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
            </div>

            <button id="submitBtn" type="submit"
                    class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 py-2 font-semibold transition flex items-center justify-center gap-2">
              <svg id="spinner" class="hidden h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-90" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
              </svg>
              <span id="btnText">–í–æ–π—Ç–∏</span>
            </button>
          </form>

          <p class="mt-6 text-sm text-center text-slate-400">
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
            <a class="text-slate-300 hover:text-white underline underline-offset-2" href="/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  @keyframes sj-shake {
    0%,100% { transform: translateX(0) }
    20% { transform: translateX(-6px) }
    40% { transform: translateX(5px) }
    60% { transform: translateX(-3px) }
    80% { transform: translateX(2px) }
  }
  .shake { animation: sj-shake .4s ease-in-out 1; }

  @keyframes sj-float {
    0%,100% { transform: translateY(0) }
    50% { transform: translateY(-6px) }
  }
  .animate-float      { animation: sj-float 5s ease-in-out infinite; }
  .animate-float-slow { animation: sj-float 7s ease-in-out infinite; }
  .animate-float-slower { animation: sj-float 9s ease-in-out infinite; }
</style>

{% endblock %}

{% block scripts %}
<script>
(function(){
  const form = document.getElementById("loginForm");
  const email = document.getElementById("email");
  const password = document.getElementById("password");
  const remember = document.getElementById("remember");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("submitBtn");
  const spinner = document.getElementById("spinner");
  const btnText = document.getElementById("btnText");
  const progress = document.getElementById("progressLine");
  const togglePassword = document.getElementById("togglePassword");
  const capsHint = document.getElementById("capsHint");
  const card = document.getElementById("card");

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å email
  try{ const last = localStorage.getItem('sj_last_email'); if(last) email.value = last; }catch(e){}

  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–∞—Ä–æ–ª—è
  togglePassword.addEventListener('click', () => {
    const isPw = password.type === 'password';
    password.type = isPw ? 'text' : 'password';
    togglePassword.textContent = isPw ? 'üôà' : 'üëÅÔ∏è';
    password.focus();
  });

  // CapsLock —Ö–∏–Ω—Ç
  const capsHandler = (e) => {
    const caps = e.getModifierState && e.getModifierState('CapsLock');
    capsHint.classList.toggle('hidden', !caps);
  };
  password.addEventListener('keydown', capsHandler);
  password.addEventListener('keyup', capsHandler);

  function setLoading(is){
    btn.disabled = is;
    spinner.classList.toggle('hidden', !is);
    btnText.textContent = is ? '–í—Ö–æ–¥–∏–º‚Ä¶' : '–í–æ–π—Ç–∏';
    progress.style.opacity = is ? '1' : '0';
  }

  function showStatus(msg, ok=false){
    statusEl.textContent = msg;
    statusEl.classList.remove('hidden');
    // success
    statusEl.classList.toggle('border-emerald-500/30', ok);
    statusEl.classList.toggle('bg-emerald-500/10', ok);
    statusEl.classList.toggle('text-emerald-200', ok);
    // error
    statusEl.classList.toggle('border-rose-500/30', !ok);
    statusEl.classList.toggle('bg-rose-500/10', !ok);
    statusEl.classList.toggle('text-rose-200', !ok);
    if(!ok){ card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake'); }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const vEmail = email.value.trim();
    const vPassword = password.value.trim();
    if (!vEmail || !vPassword) {
      showStatus("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
      return;
    }

    setLoading(true);
    showStatus("–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶", true);

    try {
      const r = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: vEmail, password: vPassword }),
      });

      if (!r.ok) {
        const txt = await r.text();
        showStatus(txt || "–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
        setLoading(false);
        return;
      }

      const data = await r.json();
      try{
        if (data.token) localStorage.setItem("token", data.token);
        if (remember.checked) localStorage.setItem("sj_last_email", vEmail);
        else localStorage.removeItem("sj_last_email");
      }catch(e){}

      if (window.Alpine && Alpine.store && Alpine.store('toasts')) {
        Alpine.store('toasts').push({emoji:'‚úÖ', title:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', text:'–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥.'});
      }

      showStatus("–ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶", true);
      setTimeout(()=> window.location.href = "/", 300);

    } catch (err) {
      showStatus("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É");
      setLoading(false);
    }
  });
})();
</script>
{% endblock %}
