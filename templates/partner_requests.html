{% extends "base.html" %}
{% set title = "–ü–∞—Ä—Ç–Ω—ë—Ä ‚Äî –∑–∞—è–≤–∫–∏" %}
{% block content %}

<section class="max-w-7xl mx-auto px-4 py-10" x-data="partnerRequests()" x-init="init()">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <h1 class="text-2xl font-extrabold">–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h1>
    <div class="flex items-center gap-2">
      <select x-model="status" @change="load()"
              class="rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-slate-900/60 px-3 py-2">
        <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
        <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
        <option value="rejected">–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ</option>
        <option value="all">–í—Å–µ</option>
      </select>
      <input type="search" placeholder="–ü–æ–∏—Å–∫: –∏–º—è –∏–ª–∏ email‚Ä¶" x-model.trim.debounce.300ms="query" @input="filterLocal()"
             class="rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-slate-900/60 px-3 py-2">
    </div>
  </div>

  <div class="mt-6 rounded-2xl border border-slate-300 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 overflow-hidden">
    <!-- header -->
    <div class="grid grid-cols-12 px-4 py-3 text-xs font-semibold text-slate-600 dark:text-slate-400">
      <div class="col-span-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
      <div class="col-span-3">–ö–æ–º–ø–∞–Ω–∏—è</div>
      <div class="col-span-3">–î–∞—Ç–∞</div>
      <div class="col-span-2 text-right">–î–µ–π—Å—Ç–≤–∏—è</div>
    </div>

    <!-- skeleton -->
    <template x-if="loading">
      <div class="p-4 space-y-3">
        <div class="skeleton h-12 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
      </div>
    </template>

    <!-- –ø—É—Å—Ç–æ -->
    <div class="px-4 py-10 text-center text-slate-600 dark:text-slate-400" x-show="!loading && filtered.length===0">
      –ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
    </div>

    <!-- rows -->
    <div class="divide-y divide-slate-200/70 dark:divide-white/10" x-show="!loading && filtered.length">
      <template x-for="r in filtered" :key="r.id">
        <div class="grid grid-cols-12 items-center px-4 py-3 text-sm">
          <div class="col-span-4">
            <div class="font-semibold text-slate-900 dark:text-slate-100" x-text="r.user_name || r.user?.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'"></div>
            <div class="text-slate-600 dark:text-slate-400" x-text="r.user_email || r.user?.email || '‚Äî'"></div>
          </div>
          <div class="col-span-3" x-text="r.company_name || r.company?.name || '‚Äî'"></div>
          <div class="col-span-3">
            <time x-text="formatDate(r.created_at)"></time>
          </div>
          <div class="col-span-2 text-right space-x-2">
            <button @click="approve(r)"
                    class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white"
                    :disabled="workingId===r.id">–û–¥–æ–±—Ä–∏—Ç—å</button>
            <button @click="reject(r)"
                    class="px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-500 text-white"
                    :disabled="workingId===r.id">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>
        </div>
      </template>
    </div>
  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
function partnerRequests(){
  return {
    loading:false, workingId:null, status:'pending', query:'', items:[], filtered:[],

    async init(){ await this.load(); },

    async load(){
      this.loading = true;
      try{
        const qs = this.status==='all' ? '' : ('?status='+encodeURIComponent(this.status));
        const r = await fetch('/api/partners/requests'+qs, { credentials:'same-origin' });
        const j = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(j.error || j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫–∏');
        this.items = Array.isArray(j.requests) ? j.requests : (Array.isArray(j.items) ? j.items : []);
        this.filterLocal();
      }catch(e){
        Alpine.store('toasts').push({ title:'–û—à–∏–±–∫–∞', text:e.message||'–û—à–∏–±–∫–∞', emoji:'‚ö†Ô∏è' });
        this.items = []; this.filtered=[];
      }finally{
        this.loading = false;
      }
    },

    filterLocal(){
      const q = (this.query||'').toLowerCase();
      this.filtered = this.items.filter(r=>{
        if(!q) return true;
        const name  = (r.user_name || r.user?.name || '').toLowerCase();
        const email = (r.user_email || r.user?.email || '').toLowerCase();
        return name.includes(q) || email.includes(q);
      });
    },

    formatDate(s){
      if(!s) return '‚Äî';
      const d = new Date(s);
      return d.toLocaleString();
    },

    async approve(row){
      if(this.workingId) return;
      this.workingId = row.id;
      try{
        const r = await fetch(`/api/partners/requests/${row.id}/approve`, { method:'POST', credentials:'same-origin' });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || j.ok===false) throw new Error(j.error || j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–¥–æ–±—Ä–∏—Ç—å');
        Alpine.store('toasts').push({ title:'–ó–∞—è–≤–∫–∏', text:'–û–¥–æ–±—Ä–µ–Ω–æ', emoji:'‚úÖ' });
        this.items = this.items.filter(x=>x.id!==row.id);
        this.filterLocal();
      }catch(e){
        Alpine.store('toasts').push({ title:'–û—à–∏–±–∫–∞', text:e.message||'–û—à–∏–±–∫–∞', emoji:'‚ö†Ô∏è' });
      }finally{
        this.workingId = null;
      }
    },

    async reject(row){
      if(this.workingId) return;
      const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
      this.workingId = row.id;
      try{
        const r = await fetch(`/api/partners/requests/${row.id}/reject`, {
          method:'POST', credentials:'same-origin',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ reason })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || j.ok===false) throw new Error(j.error || j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å');
        Alpine.store('toasts').push({ title:'–ó–∞—è–≤–∫–∏', text:'–û—Ç–∫–ª–æ–Ω–µ–Ω–æ', emoji:'üóëÔ∏è' });
        this.items = this.items.filter(x=>x.id!==row.id);
        this.filterLocal();
      }catch(e){
        Alpine.store('toasts').push({ title:'–û—à–∏–±–∫–∞', text:e.message||'–û—à–∏–±–∫–∞', emoji:'‚ö†Ô∏è' });
      }finally{
        this.workingId = null;
      }
    }
  }
}
</script>
{% endblock %}
