{% extends "base.html" %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-10" x-data="storePage()" x-init="init()">
  <div class="flex items-center justify-between gap-4">
    <h1 class="text-2xl font-bold">–ú–∞–≥–∞–∑–∏–Ω</h1>
    <button class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-white/10"
            @click="openInventory()">
      –ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
    </button>
  </div>

  <!-- –ø–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä—ã -->
  <div class="mt-4 grid md:grid-cols-3 gap-3">
    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–ª—é—á—É‚Ä¶"
           class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10"
           x-model.trim="q">
    <select class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-white/10" x-model="typeFilter">
      <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
      <option value="skin">–ö–æ—Å–º–µ—Ç–∏–∫–∞</option>
      <option value="coupon">–ö—É–ø–æ–Ω—ã</option>
    </select>
    <label class="inline-flex items-center gap-2 text-sm text-slate-300">
      <input type="checkbox" class="rounded border-white/10 bg-slate-800" x-model="onlyAvailable">
      –¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
    </label>
  </div>

  <!-- —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
  <div class="mt-4 text-slate-400" x-show="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <div class="mt-4 text-rose-300" x-show="error" x-text="error"></div>

  <!-- —Ç–æ–≤–∞—Ä—ã -->
  <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4" x-show="!loading && filteredItems().length">
    <template x-for="it in filteredItems()" :key="it.id">
      <div
        class="rounded-2xl border p-4 flex flex-col justify-between transition"
        :class="[
          'bg-slate-900/70 border-white/10',
          it.locked ? 'ring-1 ring-amber-500/30' : ''
        ]">
        <div>
          <div class="flex items-center justify-between gap-2">
            <div class="font-semibold truncate" x-text="it.title"></div>
            <span class="text-xs px-2 py-0.5 rounded-full border border-white/10" x-text="badge(it)"></span>
          </div>

          <div class="text-sm text-slate-400 mt-1" x-text="desc(it)"></div>

          <div class="mt-3 font-semibold text-amber-300">
            ü™ô <span x-text="it.cost_coins"></span>
          </div>

          <!-- –ø—Ä–∏—á–∏–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ -->
          <div class="mt-2 text-xs"
               x-show="it.locked"
               :class="it.locked ? 'text-amber-300' : 'text-slate-500'"
               x-text="it.lock_reason || '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'">
          </div>

          <div class="text-xs text-slate-500 mt-1" x-show="it.stock !== null">–û—Å—Ç–∞—Ç–æ–∫: <span x-text="it.stock"></span></div>
        </div>

        <button
          class="mt-4 px-4 py-2 rounded-xl font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed border border-white/10"
          :class="it.locked ? 'bg-white/5 text-slate-400' : 'bg-indigo-600 hover:bg-indigo-500'"
          :disabled="it.locked || buyingId===it.id"
          @click="buy(it)">
          <span x-show="buyingId!==it.id">–ö—É–ø–∏—Ç—å</span>
          <span x-show="buyingId===it.id">–ü–æ–∫—É–ø–∫–∞‚Ä¶</span>
        </button>
      </div>
    </template>
  </div>

  <div class="mt-10 text-slate-400" x-show="!loading && !filteredItems().length">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>

  <!-- –ú–æ–¥–∞–ª ¬´–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å¬ª -->
  <div x-show="showInv" x-transition.opacity class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
    <div class="w-full max-w-3xl rounded-2xl bg-slate-900 border border-white/10">
      <div class="p-4 flex items-center justify-between border-b border-white/10">
        <div class="font-semibold">–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
        <button class="px-3 py-1.5 rounded-lg bg-slate-800 border border-white/10" @click="showInv=false">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="p-4 grid md:grid-cols-2 gap-6 max-h-[70vh] overflow-y-auto">
        <!-- –ö–æ—Å–º–µ—Ç–∏–∫–∞ -->
        <div>
          <div class="text-slate-300 font-semibold mb-2">–ö–æ—Å–º–µ—Ç–∏–∫–∞</div>
          <template x-if="invLoading"><div class="text-slate-400">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></template>
          <template x-if="!invLoading && (!inventory.skins || !inventory.skins.length)"><div class="text-slate-500">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div></template>
          <div class="space-y-2" x-show="!invLoading && inventory.skins && inventory.skins.length">
            <template x-for="it in inventory.skins" :key="it.slot+'-'+it.key">
              <div class="flex items-center justify-between rounded-lg bg-slate-800/60 border border-white/10 px-3 py-2">
                <div>
                  <div class="text-sm font-medium" x-text="prettySlot(it.slot) + ': ' + it.key"></div>
                  <div class="text-xs text-slate-500" x-text="'–ü–æ–ª—É—á–µ–Ω–æ: ' + (new Date(it.obtained_at)).toLocaleString()"></div>
                </div>
                <span class="text-xs px-2 py-0.5 rounded-full border border-white/10">–ö–æ—Å–º–µ—Ç–∏–∫–∞</span>
              </div>
            </template>
          </div>
        </div>

        <!-- –ö—É–ø–æ–Ω—ã/–ø—Ä–æ—á–µ–µ -->
        <div>
          <div class="text-slate-300 font-semibold mb-2">–ö—É–ø–æ–Ω—ã –∏ –ø—Ä–æ—á–µ–µ</div>
          <template x-if="invLoading"><div class="text-slate-400">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></template>
          <template x-if="!invLoading && (!inventory.other || !inventory.other.length)"><div class="text-slate-500">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div></template>
          <div class="space-y-2" x-show="!invLoading && inventory.other && inventory.other.length">
            <template x-for="it in inventory.other" :key="it.id">
              <div class="flex items-center justify-between rounded-lg bg-slate-800/60 border border-white/10 px-3 py-2">
                <div>
                  <div class="text-sm font-medium" x-text="it.title"></div>
                  <div class="text-xs text-slate-500" x-text="'–ü–æ–∫—É–ø–∫–∞: ' + (new Date(it.created_at)).toLocaleString()"></div>
                </div>
                <span class="text-xs px-2 py-0.5 rounded-full border border-white/10" x-text="badge({type: it.type})"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
window.storePage = function(){
  return {
    items: [],
    loading: false,
    error: null,
    buyingId: null,

    // –ø–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä—ã
    q: '',
    typeFilter: 'all',
    onlyAvailable: true,   // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ
    // –∫—É–ø–ª–µ–Ω–Ω—ã–µ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞

    // –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
    showInv: false,
    invLoading: false,
    inventory: { skins: [], other: [] },

    async init(){
      this.loading = true;
      this.error = null;
      try{
        const r = await fetch('/api/store');
        const data = await r.json();
        this.items = (data.items || []);
      }catch(e){
        this.error = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω';
      }finally{
        this.loading = false;
      }
    },

    filteredItems(){
      const q = (this.q || '').toLowerCase();
      return this.items
        // —Å–∫—Ä—ã–≤–∞–µ–º –∫—É–ø–ª–µ–Ω–Ω–æ–µ
        .filter(it => !it.purchased)
        // —Ç–∏–ø
        .filter(it => this.typeFilter === 'all' ? true : it.type === this.typeFilter)
        // –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
        .filter(it => this.onlyAvailable ? !it.locked : true)
        // –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–∫–ª—é—á—É –∏–∑ payload
        .filter(it => {
          if(!q) return true;
          const text = [
            it.title || '',
            (it.payload && it.payload.key) ? String(it.payload.key) : '',
            (it.payload && it.payload.slot) ? String(it.payload.slot) : ''
          ].join(' ').toLowerCase();
          return text.includes(q);
        });
    },

    badge(it){
      if(it.type === 'coupon') return '–ö—É–ø–æ–Ω';
      if(it.type === 'skin')   return '–ö–æ—Å–º–µ—Ç–∏–∫–∞';
      return it.type || '–¢–æ–≤–∞—Ä';
    },

    desc(it){
      const p = it.payload || {};
      if(it.type==='skin' && p.slot && p.key){
        const slot = {frame:'–†–∞–º–∫–∞', outfit:'–û–¥–µ–∂–¥–∞', hair:'–ü—Ä–∏—á–µ—Å–∫–∞'}[p.slot] || p.slot;
        return `${slot}: ${p.key}`;
      }
      return '';
    },

    prettySlot(slot){
      return ({frame:'–†–∞–º–∫–∞', outfit:'–û–¥–µ–∂–¥–∞', hair:'–ü—Ä–∏—á–µ—Å–∫–∞', background:'–§–æ–Ω', accessory:'–ê–∫—Å–µ—Å—Å—É–∞—Ä', base:'–ë–∞–∑–∞'})[slot] || slot;
    },

    async buy(it){
      if(it.locked) return;
      this.buyingId = it.id;
      this.error = null;
      try{
        const r = await fetch(`/api/store/buy/${it.id}`, {method:'POST', headers:{'Content-Type':'application/json'}});
        const text = await r.text();
        if(!r.ok) throw new Error(text || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
        const data = text ? JSON.parse(text) : {};

        // –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∫—É–ø–ª–µ–Ω–Ω–æ–µ -> –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
        it.purchased = true;

        // –æ—Å—Ç–∞—Ç–æ–∫ —É–º–µ–Ω—å—à–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ already
        if(!data.already && it.stock !== null && typeof it.stock === 'number'){
          it.stock = Math.max(0, it.stock - 1);
        }

        // –æ–±–Ω–æ–≤–∏–º –∞–≤–∞—Ç–∞—Ä –≤ navbar (–∞–≤—Ç–æ—ç–∫–∏–ø –¥–ª—è –∫–æ—Å–º–µ—Ç–∏–∫–∏)
        const navImg = document.querySelector('img[data-avatar]');
        if(navImg){
          const url = new URL(navImg.src, window.location.origin);
          url.searchParams.set('t', Date.now().toString());
          navImg.src = url.toString();
        }

        if(window.Alpine?.store?.('toasts')){
          Alpine.store('toasts').push({
            emoji:'üéâ',
            title: data.already ? '–£–∂–µ –∫—É–ø–ª–µ–Ω–æ' : '–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞',
            text:`${it.title}${(it.type==='skin' && !data.already) ? ' –∫—É–ø–ª–µ–Ω –∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω!' : (data.already ? ' —É–∂–µ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.' : ' –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!')}`
          });
        }
      }catch(e){
        this.error = '–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å: ' + (e.message || e);
      }finally{
        this.buyingId = null;
      }
    },

    async openInventory(){
      this.showInv = true;
      this.invLoading = true;
      try{
        const r = await fetch('/api/store/my_inventory');
        const data = await r.json();
        this.inventory = { skins: data.skins || [], other: data.other || [] };
      }catch(e){
        if(window.Alpine?.store?.('toasts')){
          Alpine.store('toasts').push({emoji:'‚ö†Ô∏è', title:'–û—à–∏–±–∫–∞', text:'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å'});
        }
      }finally{
        this.invLoading = false;
      }
    }
  }
}
</script>
{% endblock %}
