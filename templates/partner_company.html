{% extends "base.html" %}
{% set title = "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è ‚Äî Sales Journey" %}

{% block content %}

<!-- ===== Design tokens (light/dark via .dark) ===== -->
<style>
  :root{
    /* surfaces */
    --sj-bg:            #f7fafc;
    --sj-card:          #ffffff;
    --sj-muted:         #f1f5f9;
    --sj-border:        rgba(2,6,23,.10);
    --sj-border-strong: rgba(2,6,23,.16);
    --sj-glass:         rgba(255,255,255,.75);
    --sj-overlay:       rgba(0,0,0,.55);

    /* text */
    --sj-text:          #0f172a;
    --sj-muted-text:    #475569;

    /* rings */
    --sj-ring: 79, 70, 229;   /* indigo-600 */

    /* palette (tailwind rgb) */
    --indigo: 79 70 229;
    --emerald: 16 185 129;
    --sky: 14 165 233;
    --amber: 217 119 6;
    --rose: 225 29 72;
    --slate: 100 116 139;

    --sj-radius: 14px;
    --sj-radius-lg: 18px;
    --sj-radius-xl: 24px;
  }
  .dark{
    --sj-bg:            #0b1220;
    --sj-card:          rgba(15,23,42,.88);
    --sj-muted:         rgba(15,23,42,.68);
    --sj-border:        rgba(255,255,255,.10);
    --sj-border-strong: rgba(255,255,255,.16);
    --sj-glass:         rgba(15,23,42,.78);
    --sj-overlay:       rgba(0,0,0,.6);

    --sj-text:          #e5e7eb;
    --sj-muted-text:    #94a3b8;
  }

  [x-cloak]{ display:none !important; }

  /* cards / glass */
  .card{
    background: var(--sj-card);
    color: var(--sj-text);
    border:1px solid var(--sj-border);
    border-radius: var(--sj-radius-lg);
  }
  .glass{
    position:relative;
    background: var(--sj-glass);
    backdrop-filter: blur(10px);
    border: 1px solid var(--sj-border);
    border-radius: var(--sj-radius-xl);
    box-shadow: 0 12px 40px rgba(2,6,23,.10);
  }
  .muted{
    background: var(--sj-muted);
    border: 1px solid var(--sj-border);
    border-radius: var(--sj-radius);
  }

  /* inputs */
  .input, .select, .textarea{
    width:100%;
    background: color-mix(in oklab, var(--sj-card) 94%, transparent);
    color: var(--sj-text);
    border:1px solid var(--sj-border);
    border-radius: 12px;
    padding:.6rem .8rem;
    transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .textarea{ min-height: 3.5rem; }
  .input:focus, .select:focus, .textarea:focus{
    outline:none; border-color: rgb(var(--sj-ring));
    box-shadow: 0 0 0 3px rgba(var(--sj-ring), .25);
    background: color-mix(in oklab, var(--sj-card) 98%, transparent);
  }

  /* buttons */
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
    font-weight:700; border-radius:12px;
    padding:.6rem .9rem; border:1px solid var(--sj-border);
    transition: transform .06s ease, filter .15s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .btn:hover{ filter:brightness(.98); }
  .btn:active{ transform: translateY(1px); }
  .btn:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(var(--sj-ring), .28); }

  .btn-outline{ background:transparent; }
  .btn-ghost{ background:transparent; border-color: transparent; color: var(--sj-muted-text); }

  .btn-indigo{  background: rgb(var(--indigo));  border-color: rgb(var(--indigo));  color:white; }
  .btn-emerald{ background: rgb(var(--emerald)); border-color: rgb(var(--emerald)); color:white; }
  .btn-sky{     background: rgb(var(--sky));     border-color: rgb(var(--sky));     color:white; }
  .btn-amber{   background: rgb(var(--amber));   border-color: rgb(var(--amber));   color:black; }
  .btn-rose{    background: rgb(var(--rose));    border-color: rgb(var(--rose));    color:white; }
  .btn-slate{   background: rgb(var(--slate));   border-color: rgb(var(--slate));   color:white; }

  /* table */
  .table-wrap{ overflow-x:auto; border:1px solid var(--sj-border); border-radius: 14px; }
  table{ width:100%; border-collapse: separate; border-spacing:0; }
  thead th{
    text-align:left; font-weight:700; font-size:.85rem;
    color: var(--sj-muted-text);
    background: var(--sj-muted);
    border-bottom: 1px solid var(--sj-border);
    padding:.6rem .75rem;
    position: sticky; top:0; z-index:1;
  }
  tbody td{ padding:.6rem .75rem; border-top:1px solid var(--sj-border); }
  tbody tr:hover{ background: color-mix(in oklab, var(--sj-muted) 70%, transparent); }

  /* pills (tabs) */
  .pill{ padding:.4rem .8rem; border:1px solid var(--sj-border); border-radius: 999px; }
  .pill.active{ background: color-mix(in oklab, rgb(var(--indigo)) 14%, var(--sj-card)); border-color: rgba(var(--indigo), .45); color: white; }

  .toggle{
    --w: 40px; --h: 24px;
    width:var(--w); height:var(--h);
    background: color-mix(in oklab, var(--sj-muted) 70%, transparent);
    border:1px solid var(--sj-border);
    border-radius: var(--h); position:relative; cursor:pointer;
    transition: background .2s ease, border-color .2s ease;
  }
  .toggle::after{
    content:""; position:absolute; top:2px; left:2px;
    width: calc(var(--h) - 4px); height: calc(var(--h) - 4px);
    background: #fff; border-radius: 999px;
    box-shadow: 0 3px 10px rgba(0,0,0,.25);
    transition: transform .2s cubic-bezier(.22,.61,.36,1);
  }
  .toggle.is-on{ background: rgba(16,185,129,.35); border-color: rgba(16,185,129,.6); }
  .toggle.is-on::after{ transform: translateX(calc(var(--w) - var(--h))); }

  .badge{ display:inline-flex; gap:.35rem; align-items:center; font-size:.72rem; border-radius: 999px; padding:.15rem .55rem; border:1px solid var(--sj-border); color: var(--sj-muted-text); }
</style>

<section class="max-w-7xl mx-auto px-4 py-8"
         x-data="window.partnerCompanyPage({{ company_id if company_id is not none else 'null' }})"
         x-init="init()"
         x-cloak>

  <!-- Header -->
  <div class="glass px-5 py-5 sm:px-6 sm:py-6 mb-6">
    <div class="flex items-start sm:items-center justify-between gap-4">
      <div class="min-w-0">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</h1>
        <p class="text-sm mt-1" style="color:var(--sj-muted-text)" x-text="headerSubtitle"></p>
      </div>
      <div class="flex items-center gap-2 sm:gap-3 shrink-0">
        <button @click="openOnbDrawer()" class="btn btn-indigo">–†–µ–¥–∞–∫—Ç–æ—Ä –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞</button>

        <template x-if="companyId">
          <div class="hidden md:flex items-center gap-2">
            <a href="/partner/requests" class="btn btn-outline">–ó–∞—è–≤–∫–∏</a>
            <a href="/partner/reports"  class="btn btn-outline">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
          </div>
        </template>
        <template x-if="!companyId">
          <a href="/partner/company/create" class="btn btn-emerald">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</a>
        </template>
      </div>
    </div>
  </div>

  <!-- Layout -->
  <div class="grid md:grid-cols-[1fr,360px] gap-5">
    <!-- MAIN -->
    <div class="space-y-4">

      <!-- Tabs -->
      <div class="flex flex-wrap items-center gap-2">
        <button :class="['pill', tab==='feed'?'active':'']"  @click="tab='feed'">–õ–µ–Ω—Ç–∞</button>
        <button :class="['pill', tab==='tasks'?'active':'']" @click="tab='tasks'">–ó–∞–¥–∞—á–∏</button>
        <button :class="['pill', tab==='people'?'active':'']" @click="tab='people'">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
        <button :class="['pill', tab==='store'?'active':'']"  @click="tab='store'">–ú–∞–≥–∞–∑–∏–Ω</button>
      </div>

      <!-- FEED -->
      <div x-show="tab==='feed'" x-transition.opacity class="space-y-4">
        <div class="card p-4" x-show="canPost">
          <div class="font-semibold mb-2">–ù–æ–≤—ã–π –ø–æ—Å—Ç</div>
          <textarea x-model="newPost" class="textarea" placeholder="–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è..."></textarea>

          <div class="mt-2">
            <input type="file" accept="image/*" x-ref="newPostImageInput"
                   class="block w-full text-sm file:mr-3 file:rounded-lg file:border file:border-[var(--sj-border)] file:bg-[var(--sj-muted)] file:px-3 file:py-1.5 hover:file:brightness-95"
                   @change="onNewPostFile($event)">
            <div x-show="newPostPreview" class="mt-2">
              <img :src="newPostPreview" alt="" class="max-h-56 rounded-xl border border-[var(--sj-border)] object-contain">
              <button type="button" class="mt-2 text-xs underline" style="color:var(--sj-muted-text)" @click="clearNewPostFile()">–£–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            </div>
          </div>

          <label class="inline-flex items-center gap-2 text-sm mt-2" style="color:var(--sj-muted-text)">
            <input type="checkbox" x-model="newPinned" class="rounded"> –ó–∞–∫—Ä–µ–ø–∏—Ç—å
          </label>

          <button class="mt-3 w-full btn btn-indigo" @click="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>

        <div class="space-y-3">
          <template x-for="p in feed" :key="p.id">
            <div class="card p-4 group">
              <div class="text-xs" style="color:var(--sj-muted-text)" x-text="new Date(p.created_at).toLocaleString()"></div>
              <div class="font-semibold mt-1 flex items-center gap-2">
                <span class="text-emerald-600 dark:text-emerald-300" x-text="p.author"></span>
                <span class="text-xs" style="color:var(--sj-muted-text)" x-text="p.type==='partner'?'(–ø–∞—Ä—Ç–Ω—ë—Ä)':'(–º–µ–Ω–µ–¥–∂–µ—Ä)'"></span>
                <span x-show="p.pinned" class="ml-2" style="color:rgb(var(--amber))">üìå</span>
              </div>
              <div class="mt-1 whitespace-pre-line" x-text="p.text"></div>
              <template x-if="(p.image_url || p.photo_url || p.image)">
                <img :src="p.image_url || p.photo_url || p.image"
                     class="mt-2 rounded-xl border border-[var(--sj-border)] max-h-80 object-contain"
                     loading="lazy" alt="">
              </template>
            </div>
          </template>
          <div x-show="feed.length===0" class="text-sm" style="color:var(--sj-muted-text)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>
        </div>
      </div>

      <!-- TASKS -->
      <div x-show="tab==='tasks'" x-transition.opacity class="space-y-3">
        <template x-for="t in tasks" :key="t.id">
          <div class="card p-4 flex items-start justify-between gap-4">
            <div>
              <div class="font-semibold" x-text="t.title"></div>
              <div class="flex items-center gap-2 mt-1">
                <span class="text-[11px] px-2 py-0.5 rounded-full border border-[var(--sj-border)]"
                      :class="{
                        'text-emerald-600 dark:text-emerald-300': t.priority==='low',
                        'text-sky-600 dark:text-sky-300':     t.priority==='normal',
                        'text-amber-600 dark:text-amber-300':   t.priority==='high',
                        'text-rose-600 dark:text-rose-300':    t.priority==='critical',
                      }"
                      x-text="'–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ' + (t.priority || 'normal')"></span>
                <span class="text-[11px]" style="color:var(--sj-muted-text)" x-text="t.require_proof ? '—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç' : '–±–µ–∑ –æ—Ç—á—ë—Ç–∞'"></span>
              </div>

              <div class="text-sm mt-1" x-text="t.description"></div>

              <div class="text-xs mt-1" style="color:var(--sj-muted-text)">
                –ù–∞–≥—Ä–∞–¥–∞:
                <b class="text-emerald-600 dark:text-emerald-300" x-text="t.points_xp + ' XP'"></b>,
                <b class="text-amber-600 dark:text-amber-300"   x-text="t.coins + ' ü™ô'"></b>
                <span x-show="t.due_at"> ¬∑ –¥–µ–¥–ª–∞–π–Ω:
                  <span x-text="new Date(t.due_at).toLocaleDateString()"></span>
                </span>
                <span x-show="t.due_at" class="ml-2"
                      :class="t.is_due_passed ? 'text-rose-600 dark:text-rose-300' : 'text-emerald-600 dark:text-emerald-300'"
                      x-text="t.is_due_passed ? '—Å—Ä–æ–∫ –∏—Å—Ç—ë–∫' : '—Å—Ä–æ–∫ –Ω–µ –∏—Å—Ç—ë–∫'"></span>
              </div>

              <div class="text-xs mt-1"
                   :class="{'text-sky-600 dark:text-sky-300': t.assign_status==='assigned', 'text-emerald-600 dark:text-emerald-300': t.assign_status==='approved', 'text-rose-600 dark:text-rose-300': t.assign_status==='rejected'}"
                   x-show="t.assign_status"
                   x-text="t.assign_status==='assigned' ? '–ù–∞–∑–Ω–∞—á–µ–Ω–∞' : (t.assign_status==='approved' ? '–ó–∞—á—Ç–µ–Ω–∞' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞')">
              </div>
            </div>

            <div class="shrink-0 flex items-center gap-2">
              <template x-if="canCreateTasks">
                <button class="btn btn-outline" @click="openTaskModal('edit', t)">–ò–∑–º–µ–Ω–∏—Ç—å</button>
              </template>

              <template x-if="t.submittable">
                <div class="flex items-center gap-2">
                  <input type="file" class="hidden" :id="'proof_'+t.id" @change="submitProof(t.id, $event)">
                  <button class="btn btn-sky" @click="document.getElementById('proof_'+t.id).click()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
                </div>
              </template>
            </div>
          </div>
        </template>
        <div x-show="tasks.length===0" class="text-sm" style="color:var(--sj-muted-text)">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.</div>

        <div class="flex justify-end" x-show="canCreateTasks">
          <button class="btn btn-indigo" @click="openTaskModal('create')">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
      </div>

      <!-- PEOPLE -->
      <div x-show="tab==='people'" x-transition.opacity class="space-y-4">
        <div class="card p-4">
          <div class="flex flex-wrap items-center gap-2">
            <h3 class="text-lg font-semibold">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3>
            <span class="badge" x-text="people.items?.length ? ('–≤—Å–µ–≥–æ: '+people.total) : '‚Äî'"></span>
            <div class="ml-auto flex flex-wrap items-center gap-2">
              <input x-model.debounce.300ms="people.query" @input="loadPeople(1)" class="input" placeholder="–ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email" style="min-width:260px">
              <button class="btn btn-outline" @click="openInviteModal()">–ò–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–∞</button>
              <button class="btn btn-emerald" @click="openCreateAdmin()">+ –ê–¥–º–∏–Ω</button>
            </div>
          </div>

          <div class="table-wrap mt-3">
            <table class="text-sm">
              <thead>
                <tr>
                  <th>ID</th><th>–ò–º—è</th><th>Email</th><th>–†–æ–ª—å</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th class="text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="u in people.items" :key="u.id">
                  <tr>
                    <td x-text="u.id"></td>
                    <td>
                      <div class="font-medium" x-text="u.display_name || '‚Äî'"></div>
                    </td>
                    <td x-text="u.email"></td>
                    <td>
                      <span class="badge" :class="u.is_admin ? 'border-emerald-500/40' : ''" x-text="u.is_admin ? '–∞–¥–º–∏–Ω' : '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫'"></span>
                    </td>
                    <td x-text="u.level != null ? u.level : '‚Äî'"></td>
                    <td class="text-right">
                      <div class="flex justify-end gap-2">
                        <button class="btn btn-sky"    x-show="!u.is_admin" @click="setCompanyAdmin(u.id,true)">–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
                        <button class="btn btn-amber"  x-show="u.is_admin"  @click="setCompanyAdmin(u.id,false)">–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞</button>
                        <button class="btn btn-rose"   @click="removeFromCompany(u.id)">–£–¥–∞–ª–∏—Ç—å</button>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div x-show="!people.items?.length" class="text-sm p-4" style="color:var(--sj-muted-text)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>
          </div>

          <!-- pagination -->
          <div class="flex items-center justify-between mt-3" x-show="(people.total||0) > (people.per_page||20)">
            <button class="btn btn-ghost text-sm py-1.5" :disabled="people.page<=1" @click="loadPeople(people.page-1)">‚Üê –ù–∞–∑–∞–¥</button>
            <div class="text-xs" style="color:var(--sj-muted-text)">
              –°—Ç—Ä. <b x-text="people.page||1"></b> / <b x-text="Math.ceil((people.total||0)/(people.per_page||20))"></b>
            </div>
            <button class="btn btn-ghost text-sm py-1.5"
                    :disabled="(people.page||1) >= Math.ceil((people.total||0)/(people.per_page||20))"
                    @click="loadPeople(people.page+1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- STORE -->
      <div x-show="tab==='store'" x-transition.opacity class="space-y-4">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">–ú–∞–≥–∞–∑–∏–Ω –∫–æ–º–ø–∞–Ω–∏–∏</h3>
            <div class="flex items-center gap-2">
              <button class="btn btn-sky" @click="openStoreModal('create')">Ôºã –¢–æ–≤–∞—Ä</button>
              <button class="btn btn-outline" @click="loadStore()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
          </div>

          <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-3">
            <template x-for="i in store.items" :key="i.id">
              <div class="card p-3">
                <div class="flex items-start justify-between gap-2">
                  <div class="min-w-0">
                    <div class="font-semibold truncate" x-text="i.title"></div>
                    <div class="text-xs mt-0.5" style="color:var(--sj-muted-text)">
                      —Ç–∏–ø: <b x-text="i.type"></b> ‚Ä¢ —Ü–µ–Ω–∞: <b x-text="i.cost_coins"></b> ‚Ä¢ –º–∏–Ω. —É—Ä.: <b x-text="i.min_level"></b>
                    </div>
                    <div class="text-xs mt-0.5" style="color:var(--sj-muted-text)">
                      stock: <b x-text="i.stock ?? '‚àû'"></b>
                    </div>
                  </div>
                  <div class="shrink-0">
                    <div class="toggle" :class="i.is_active ? 'is-on' : ''" @click="toggleStoreItem(i)"></div>
                  </div>
                </div>

                <div class="mt-2 flex gap-2">
                  <button class="btn btn-outline" @click="openStoreModal('edit', i)">–†–µ–¥–∞–∫—Ç.</button>
                  <button class="btn btn-rose" @click="deleteStoreItem(i.id)">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </div>
            </template>
          </div>

          <div x-show="!store.items?.length" class="text-sm" style="color:var(--sj-muted-text)">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
        </div>
      </div>

      <!-- TASK MODAL -->
      <div x-show="taskModal.open" x-transition.opacity x-cloak>
        <div class="fixed inset-0" :style="{background: 'var(--sj-overlay)'}" @click="closeTaskModal()"></div>

        <div class="fixed inset-x-0 top-[6%] mx-auto max-w-2xl z-50 card p-5" @click.stop>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold" x-text="taskModal.mode==='create' ? '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞' : '–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É'"></h3>
            <button class="btn btn-ghost px-3" @click="closeTaskModal()">‚úï</button>
          </div>

          <div class="px-1 py-4 max-h-[75vh] overflow-y-auto overscroll-contain">
            <div class="mt-2 grid gap-3">
              <input x-model="taskModal.form.title" class="input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
              <textarea x-model="taskModal.form.description" class="textarea h-28" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs" style="color:var(--sj-muted-text)">XP</label>
                  <input x-model.number="taskModal.form.points_xp" type="number" class="input">
                </div>
                <div>
                  <label class="text-xs" style="color:var(--sj-muted-text)">–ö–æ–∏–Ω—ã</label>
                  <input x-model.number="taskModal.form.coins" type="number" class="input">
                </div>
              </div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="text-xs" style="color:var(--sj-muted-text)">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                  <select x-model="taskModal.form.priority" class="select">
                    <option value="low">low</option>
                    <option value="normal">normal</option>
                    <option value="high">high</option>
                    <option value="critical">critical</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <label class="inline-flex items-center gap-2 text-xs" style="color:var(--sj-muted-text)">
                    <input type="checkbox" x-model="taskModal.form.require_proof" class="rounded"> –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç —Å —Ñ–æ—Ç–æ
                  </label>
                </div>
              </div>

              <div>
                <label class="text-xs" style="color:var(--sj-muted-text)">–î–µ–¥–ª–∞–π–Ω (–¥–∞—Ç–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="date" x-model="taskModal.form._due_date" class="input">
              </div>

              <div>
                <label class="text-xs" style="color:var(--sj-muted-text)">ID –∞—á–∏–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input x-model.number="taskModal.form.reward_achievement_id" type="number" class="input" placeholder="–ù–∞–ø—Ä., 3">
              </div>
            </div>

            <!-- Members select -->
            <div class="mt-5">
              <div class="text-sm font-semibold">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>

              <div class="mt-2 flex flex-wrap gap-2" x-show="taskModal.selectedIds.length">
                <template x-for="uid in taskModal.selectedIds" :key="uid">
                  <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full border border-[var(--sj-border)] bg-[var(--sj-muted)]">
                    <span x-text="nameById(uid)"></span>
                    <button class="hover:text-rose-600 dark:hover:text-rose-300" @click="tmUnselect(uid)">‚úï</button>
                  </span>
                </template>
              </div>

              <div class="mt-2">
                <input x-model="taskModal.query" @input="tmSearchMembers" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email" class="input">
              </div>

              <div class="mt-3 max-h-64 overflow-auto divide-y" style="border-color:var(--sj-border)">
                <template x-for="m in taskModal.members" :key="m.id">
                  <label class="flex items-center gap-3 py-2 px-1 cursor-pointer">
                    <input type="checkbox"
                           :value="String(m.id)"
                           :checked="taskModal.selectedIds.includes(String(m.id))"
                           @change="tmToggleSelect(m.id)">
                    <div class="leading-tight">
                      <div class="font-medium" x-text="m.display_name"></div>
                      <div class="text-xs" style="color:var(--sj-muted-text)" x-text="m.email"></div>
                    </div>
                  </label>
                </template>
                <div class="text-sm py-6 text-center" style="color:var(--sj-muted-text)" x-show="!taskModal.members.length">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>
          </div>

          <div class="flex justify-end gap-2 pt-3" style="border-top:1px solid var(--sj-border)">
            <button class="btn btn-ghost" @click="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-indigo disabled:opacity-50"
                    :disabled="!taskModal.form.title?.trim()"
                    @click="saveTask()"
                    x-text="taskModal.mode==='create' ? '–°–æ–∑–¥–∞—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'">
            </button>
          </div>
        </div>
      </div>

      <!-- STORE MODAL -->
      <div x-show="storeModal.open" x-transition.opacity x-cloak>
        <div class="fixed inset-0" :style="{background: 'var(--sj-overlay)'}" @click="closeStoreModal()"></div>

        <div class="fixed inset-x-0 top-[6%] mx-auto max-w-2xl z-50 card p-5" @click.stop>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold" x-text="storeModal.mode==='create' ? '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä' : '–ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä'"></h3>
            <button class="btn btn-ghost px-3" @click="closeStoreModal()">‚úï</button>
          </div>

          <div class="px-1 py-4 max-h-[75vh] overflow-y-auto overscroll-contain">
            <div class="grid gap-3">
              <select x-model="storeModal.form.type" class="select">
                <option value="skin">skin</option>
                <option value="coupon">coupon</option>
                <option value="merch">merch</option>
              </select>
              <input x-model="storeModal.form.title" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
              <div class="grid grid-cols-3 gap-2">
                <input x-model.number="storeModal.form.cost_coins" type="number" class="input" placeholder="–¶–µ–Ω–∞ ü™ô">
                <input x-model.number="storeModal.form.min_level"  type="number" class="input" placeholder="–ú–∏–Ω. —É—Ä–æ–≤–µ–Ω—å">
                <input x-model="storeModal.form.stock" class="input" placeholder="stock (–ø—É—Å—Ç–æ = ‚àû)">
              </div>
              <textarea x-model="storeModal.form.payload" class="textarea" rows="4" placeholder='JSON payload, –Ω–∞–ø—Ä. {"slot":"frame","key":"frame_gold","auto_equip":true}'></textarea>
            </div>
          </div>

          <div class="flex justify-end gap-2 pt-3" style="border-top:1px solid var(--sj-border)">
            <button class="btn btn-ghost" @click="closeStoreModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-sky" @click="saveStoreItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <!-- CREATE ADMIN MODAL -->
      <div x-show="adminModal.open" x-transition.opacity x-cloak>
        <div class="fixed inset-0" :style="{background:'var(--sj-overlay)'}" @click="closeAdminModal()"></div>
        <div class="fixed inset-x-0 top-[12%] mx-auto max-w-md z-50 card p-5" @click.stop>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">–°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞ –∫–æ–º–ø–∞–Ω–∏–∏</h3>
            <button class="btn btn-ghost px-3" @click="closeAdminModal()">‚úï</button>
          </div>
          <div class="px-1 py-4 grid gap-3">
            <input class="input" placeholder="email" x-model="adminModal.form.email">
            <input class="input" type="password" placeholder="–ø–∞—Ä–æ–ª—å" x-model="adminModal.form.password">
            <input class="input" placeholder="–∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" x-model="adminModal.form.display_name">
          </div>
          <div class="flex justify-end gap-2 pt-3" style="border-top:1px solid var(--sj-border)">
            <button class="btn btn-ghost" @click="closeAdminModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-emerald" @click="createCompanyAdmin()">–°–æ–∑–¥–∞—Ç—å</button>
          </div>
        </div>
      </div>

      <!-- INVITE MODAL -->
      <div x-show="inviteModal" x-transition.opacity x-cloak>
        <div class="fixed inset-0" :style="{background:'var(--sj-overlay)'}" @click="inviteModal=false"></div>
        <div class="fixed inset-x-0 top-[12%] mx-auto max-w-lg z-50 card p-5" @click.stop>
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">–ò–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–∞</h3>
            <button class="btn btn-ghost px-3" @click="inviteModal=false">‚úï</button>
          </div>
          <div class="px-1 py-4">
            <template x-if="invite">
              <div class="space-y-2">
                <div class="text-sm" style="color:var(--sj-muted-text)">–ü–µ—Ä–µ–¥–∞–π—Ç–µ —Å—Å—ã–ª–∫—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:</div>
                <div class="muted p-2 rounded-lg">
                  <code class="text-xs break-all" x-text="invite.url || invite.invite_url || ''"></code>
                </div>
                <div class="flex gap-2">
                  <button class="btn btn-indigo" @click="copy(invite.url || invite.invite_url)">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="btn btn-amber" @click="regenerateInvite()">–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                  <button class="btn btn-rose" @click="deactivateInvite()">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
              </div>
            </template>
            <div x-show="!invite" class="text-sm" style="color:var(--sj-muted-text)">–°—Å—ã–ª–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.</div>
          </div>
        </div>
      </div>

    </div>

    <!-- ASIDE -->
    <aside class="space-y-4 md:pt-1">
      <div class="card p-5">
        <div class="flex items-center gap-4">
          <div class="h-16 w-16 rounded-2xl border border-[var(--sj-border)] bg-[rgba(79,70,229,.12)] flex items-center justify-center text-xl font-bold shadow-inner text-indigo-700 dark:text-indigo-300">
            <span x-text="(company && company.name ? company.name.charAt(0).toUpperCase() : 'C')"></span>
          </div>
          <div>
            <div class="text-lg font-bold" x-text="company?.name || '–ö–æ–º–ø–∞–Ω–∏—è'"></div>
            <div class="text-xs" style="color:var(--sj-muted-text)" x-text="company ? '@' + company.slug : ''"></div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-2">
          <div class="muted p-3 text-center">
            <div class="text-[11px]" style="color:var(--sj-muted-text)">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
            <div class="text-lg font-bold" x-text="kpi.members ?? '‚Äî'"></div>
          </div>
          <div class="muted p-3 text-center">
            <div class="text-[11px]" style="color:var(--sj-muted-text)">–£—Ä–æ–≤–µ–Ω—å</div>
            <div class="text-lg font-bold" x-text="kpi.avg_level ?? '‚Äî'"></div>
          </div>
          <div class="muted p-3 text-center">
            <div class="text-[11px]" style="color:var(--sj-muted-text)">–°–æ–±—ã—Ç.30–¥</div>
            <div class="text-lg font-bold" x-text="kpi.events_30d ?? '‚Äî'"></div>
          </div>
        </div>
      </div>

      <div class="card p-4 text-sm" style="color:var(--sj-muted-text)">
        ¬´–õ–µ–Ω—Ç–∞¬ª ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏—è, ¬´–ó–∞–¥–∞—á–∏¬ª ‚Äî –º–∏–∫—Ä–æ-–∫–≤–µ—Å—Ç—ã, ¬´–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏¬ª ‚Äî —Ä–æ–ª–∏ –∏ —Å–æ—Å—Ç–∞–≤, ¬´–ú–∞–≥–∞–∑–∏–Ω¬ª ‚Äî –ø—Ä–∏–∑—ã –∏ –º–µ—Ä—á, ¬´–õ–∏–¥–µ—Ä–±–æ—Ä–¥¬ª ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ 30 –¥–Ω–µ–π.
      </div>

      <div class="card p-4">
        <div class="text-sm mb-2" style="color:var(--sj-muted-text)">–õ–∏–¥–µ—Ä–±–æ—Ä–¥ ¬∑ 30 –¥–Ω–µ–π</div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr>
                <th class="text-left py-2">#</th>
                <th class="text-left">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                <th class="text-right">XP</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(row,idx) in leaderboard" :key="row.user_id || row.id">
                <tr class="hover:bg-[color-mix(in_ol, var(--sj-muted)_70%, transparent)]">
                  <td class="py-2" x-text="idx+1"></td>
                  <td x-text="row.display_name"></td>
                  <td class="text-right font-semibold" x-text="row.xp_30d"></td>
                </tr>
              </template>
            </tbody>
          </table>
          <div x-show="leaderboard.length===0" class="text-sm" style="color:var(--sj-muted-text)">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- ===== RIGHT DRAWER (Onboarding Editor) ===== -->
  <div x-show="onbDrawer.open" x-cloak>
    <div class="fixed inset-0" :style="{background:'var(--sj-overlay)'}" @click="closeOnbDrawer()"></div>

    <aside class="fixed inset-y-0 right-0 w-[620px] max-w-[95vw] z-50 card rounded-l-3xl border-l-[var(--sj-border)]
                  transition-transform"
           x-transition:enter="transform ease-out duration-250"
           x-transition:enter-start="translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transform ease-in duration-200"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="translate-x-full"
           @click.stop>

      <!-- Drawer header -->
      <div class="px-5 py-4" style="border-bottom:1px solid var(--sj-border)">
        <div class="flex items-center justify-between">
          <div class="min-w-0">
            <div class="text-lg font-semibold truncate" x-text="onb.activeFlow?.name || '–û–Ω–±–æ—Ä–¥–∏–Ω–≥ ‚Äî —Ñ–ª–æ—É'"></div>
            <div class="text-xs" style="color:var(--sj-muted-text)" x-show="onb.activeFlow">
              ID: <span x-text="onb.activeFlow?.id"></span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button x-show="onb.activeFlow" @click="deleteFlow(onb.activeFlow.id)" class="btn btn-rose">–£–¥–∞–ª–∏—Ç—å</button>
            <button @click="createFlowQuick()" class="btn btn-emerald">–ë—ã—Å—Ç—Ä—ã–π —Ñ–ª–æ—É</button>
            <button @click="createFlow()" class="btn btn-outline">–ü—É—Å—Ç–æ–π —Ñ–ª–æ—É</button>
            <button @click="closeOnbDrawer()" class="btn btn-ghost px-3" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>
        </div>
      </div>

      <!-- Drawer body -->
      <div class="h-[calc(100vh-64px)] overflow-y-auto overscroll-contain p-4 space-y-4">

        <!-- Flows list -->
        <div class="card">
          <div class="flex items-center justify-between px-4 py-3" style="border-bottom:1px solid var(--sj-border)">
            <div class="font-semibold">–§–ª–æ—É –∫–æ–º–ø–∞–Ω–∏–∏</div>
            <div class="flex items-center gap-2">
              <span x-show="onbLoading" class="text-xs flex items-center gap-2" style="color:var(--sj-muted-text)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
              <button class="btn btn-ghost text-sm py-1.5" :disabled="onbLoading" @click="loadFlows()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
          </div>
          <div class="p-3">
            <template x-if="!onbLoading && !onb.flows.length">
              <div class="text-sm" style="color:var(--sj-muted-text)">–§–ª–æ—É –ø–æ–∫–∞ –Ω–µ—Ç.</div>
            </template>

            <div class="grid gap-2" x-show="!onbLoading && onb.flows.length">
              <template x-for="f in onb.flows" :key="f.id">
                <div class="flex items-center justify-between rounded-xl border border-[var(--sj-border)] bg-[color-mix(in_ol, var(--sj-muted)_60%, transparent)] px-3 py-2 hover:brightness-95 transition">
                  <div class="min-w-0">
                    <div class="font-medium truncate" x-text="f.name"></div>
                    <div class="text-xs" style="color:var(--sj-muted-text)">
                      –ë–æ–Ω—É—Å: <span x-text="f.final_bonus_coins || 0"></span> –º–æ–Ω–µ—Ç
                      <span class="mx-2">‚Ä¢</span>
                      <span x-text="f.is_active ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–Ω–µ –∞–∫—Ç–∏–≤–µ–Ω'"></span>
                    </div>
                  </div>
                  <div class="shrink-0 flex items-center gap-3">
                    <button @click="openFlow(f.id)" class="btn btn-ghost text-sm py-1.5">–û—Ç–∫—Ä—ã—Ç—å</button>
                    <div class="toggle" :class="f.is_active ? 'is-on' : ''" @click="setFlowActive(f, !f.is_active)"></div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Flow meta -->
        <template x-if="onb.activeFlow">
          <div class="card">
            <div class="px-4 py-3" style="border-bottom:1px solid var(--sj-border)">
              <div class="flex items-center justify-between">
                <div class="font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–ª–æ—É</div>
                <div class="flex items-center gap-2">
                  <button class="btn btn-ghost text-sm py-1.5" @click="openFlowStats(onb.activeFlow.id)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                </div>
              </div>
            </div>

            <div class="p-4 space-y-4">
              <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                  <div class="toggle" :class="onb.activeFlow.is_active ? 'is-on' : ''" @click="setFlowActive(onb.activeFlow, !onb.activeFlow.is_active)"></div>
                  <span class="text-sm" style="color:var(--sj-muted-text)">–ê–∫—Ç–∏–≤–µ–Ω</span>
                </div>
                <div class="flex items-center gap-2">
                  <input type="number" class="input w-28" x-model.number="onb.activeFlow.final_bonus_coins" placeholder="–ë–æ–Ω—É—Å">
                  <button @click="saveFlowMeta()" class="btn btn-emerald" :disabled="saving">
                    <span x-show="!saving">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                    <span x-show="saving">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶</span>
                  </button>
                </div>
              </div>
              <div>
                <label class="text-xs" style="color:var(--sj-muted-text)">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="input mt-1" x-model="onb.activeFlow.name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–ª–æ—É">
              </div>
              <div class="text-xs" style="color:var(--sj-muted-text)">
                ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è¬ª –≤—Å–µ–≥–¥–∞ 2-–π —à–∞–≥, –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–∞—è –∏ –Ω–µ —É–¥–∞–ª—è–µ–º–∞—è.
              </div>
            </div>
          </div>
        </template>

        <!-- Links -->
        <template x-if="onb.activeFlow">
          <div class="card">
            <div class="flex items-center justify-between px-4 py-3" style="border-bottom:1px solid var(--sj-border)">
              <div class="font-semibold">–°—Å—ã–ª–∫–∏</div>
              <button @click="generateLink()" class="btn btn-ghost text-sm py-1.5">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
            <div class="p-3 space-y-2" x-show="onb.links.length">
              <template x-for="l in onb.links" :key="l.id">
                <div class="flex items-center justify-between rounded-xl border border-[var(--sj-border)] bg-[color-mix(in_ol, var(--sj-muted)_60%, transparent)] px-3 py-2 hover:brightness-95 transition">
                  <div class="text-sm">
                    <div class="font-medium"><b>/r/<span x-text="l.slug"></span></b></div>
                    <div class="text-xs" style="color:var(--sj-muted-text)">
                      –ò—Å–ø.: <span x-text="l.uses_count || 0"></span>,
                      –ú–∞–∫—Å: <span x-text="l.max_uses ?? '‚Äî'"></span>,
                      –î–æ: <span x-text="l.expires_at || '‚Äî'"></span>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <a :href="`/r/${l.slug}`" target="_blank" class="btn btn-indigo text-sm py-1.5">–û—Ç–∫—Ä—ã—Ç—å</a>
                    <button @click="deleteLink(l.id)" class="btn btn-rose text-sm py-1.5">–£–¥–∞–ª–∏—Ç—å</button>
                  </div>
                </div>
              </template>
            </div>
            <div class="p-3 text-sm" style="color:var(--sj-muted-text)" x-show="!onb.links.length">–°—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
          </div>
        </template>

        <!-- Steps -->
        <template x-if="onb.activeFlow">
          <div class="card">
            <div class="flex items-center justify-between px-4 py-3" style="border-bottom:1px solid var(--sj-border)">
              <div class="font-semibold">–®–∞–≥–∏ —Ñ–ª–æ—É</div>
              <div class="flex items-center gap-2">
                <button @click="addStepDialog=true" class="btn btn-ghost text-sm py-1.5">–î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button>
                <button @click="saveOrder()" class="btn btn-emerald text-sm py-1.5" :disabled="saving">
                  <span x-show="!saving">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫</span>
                  <span x-show="saving">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶</span>
                </button>
              </div>
            </div>

            <div class="p-3">
              <template x-if="!onb.steps.length">
                <div class="text-sm" style="color:var(--sj-muted-text)">–®–∞–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
              </template>

              <div class="space-y-3">
                <template x-for="(s,idx) in onb.steps" :key="s.id">
                  <div class="p-4 rounded-xl border border-[var(--sj-border)] bg-[color-mix(in_ol, var(--sj-muted)_60%, transparent)] group transition hover:brightness-95">
                    <div class="flex items-center justify-between gap-3">
                      <div class="min-w-0">
                        <div class="text-xs" style="color:var(--sj-muted-text)">
                          #<span x-text="s.order_index"></span> ‚Ä¢ <span x-text="s.type"></span>
                          <span class="badge" x-show="s.type==='registration_section'">—Ñ–∏–∫—Å.</span>
                        </div>
                        <div class="font-semibold truncate" x-text="s.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'"></div>

                        <!-- Media -->
                        <template x-if="s.media_url">
                          <div class="mt-2">
                            <template x-if="/youtube\.com|youtu\.be/.test(s.media_url)">
                              <div class="rounded-xl overflow-hidden border border-[var(--sj-border)]">
                                <iframe class="w-full aspect-video" :src="youtubeEmbed(s.media_url)" frameborder="0" allowfullscreen></iframe>
                              </div>
                            </template>
                            <template x-if="!/youtube\.com|youtu\.be/.test(s.media_url)">
                              <video class="w-full rounded-xl border border-[var(--sj-border)]" controls :src="s.media_url"></video>
                            </template>
                          </div>
                        </template>
                      </div>
                      <div class="shrink-0 flex items-center gap-2">
                        <div class="toggle" :class="s.is_active ? 'is-on' : ''" @click="toggleStepActive(s, !s.is_active)"></div>
                        <button @click="moveStep(idx,-1)" :disabled="s.is_immutable" class="btn btn-ghost px-2 disabled:opacity-40">‚Üë</button>
                        <button @click="moveStep(idx, 1)" :disabled="s.is_immutable" class="btn btn-ghost px-2 disabled:opacity-40">‚Üì</button>
                        <button x-show="!s.is_immutable" @click="editStep(s)" class="btn btn-indigo text-sm py-1.5">–†–µ–¥–∞–∫—Ç.</button>
                        <button x-show="!s.is_immutable" @click="deleteStep(s.id)" class="btn btn-rose text-sm py-1.5">–£–¥–∞–ª–∏—Ç—å</button>
                        <span x-show="s.is_immutable" class="text-xs px-2 py-1 border border-[var(--sj-border)] rounded-lg" style="color:var(--sj-muted-text)">–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π</span>
                      </div>
                    </div>

                    <!-- Options (interest_selector & choice_one) -->
                    <div x-show="s.type==='interest_selector' || s.type==='choice_one'" class="mt-3">
                      <div class="text-sm font-semibold">–û–ø—Ü–∏–∏</div>

                      <div class="space-y-2" x-show="s.options && s.options.length">
                        <template x-for="o in s.options" :key="o.id || o.key">
                          <div class="flex items-start justify-between rounded-lg border border-[var(--sj-border)] bg-[color-mix(in_ol, var(--sj-muted)_75%, transparent)] px-3 py-2 gap-3 hover:brightness-95 transition">
                            <button class="min-w-0 text-left" @click="editOption(o, s.id)">
                              <div class="font-medium truncate" x-text="o.title"></div>
                              <div class="text-xs" style="color:var(--sj-muted-text)" x-text="o.key"></div>
                              <div class="text-xs mt-1 line-clamp-2" style="color:var(--sj-muted-text)" x-show="o.body_md" x-text="o.body_md"></div>
                              <div class="text-[11px] mt-1" style="color:var(--sj-muted-text)" x-show="o.media_url">–º–µ–¥–∏–∞: <span class="underline" x-text="o.media_url"></span></div>
                            </button>
                            <div class="shrink-0 flex items-center gap-2">
                              <button @click="editOption(o, s.id)" class="btn btn-ghost text-sm py-1.5">–†–µ–¥–∞–∫—Ç.</button>
                              <button @click="deleteOption(o, s.id)" class="btn btn-rose text-sm py-1.5">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                          </div>
                        </template>
                      </div>

                      <!-- Add option -->
                      <div class="mt-3 grid gap-2 md:grid-cols-[120px,1fr]">
                        <input type="text" class="input" placeholder="key" x-model="onb.tmpOpt.key">
                        <input type="text" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" x-model="onb.tmpOpt.title">
                        <textarea class="textarea md:col-span-2" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" x-model="onb.tmpOpt.body_md"></textarea>
                        <div class="md:col-span-2 flex justify-end">
                          <button @click="addOption(s.id)" class="btn btn-outline text-sm py-1.5">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Add step dialog -->
              <div x-show="addStepDialog" x-cloak class="mt-4 p-4 rounded-xl border border-[var(--sj-border)] bg-[color-mix(in_ol, var(--sj-muted)_70%, transparent)]">
                <div class="grid md:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm" style="color:var(--sj-muted-text)">–¢–∏–ø</label>
                    <select class="select mt-1" x-model="formStep.type">
                      <option value="intro_page">intro_page</option>
                      <option value="interest_selector">interest_selector</option>
                      <option value="ask_input">ask_input</option>
                      <option value="choice_one">choice_one</option>
                      <option value="interview_invite">interview_invite</option>
                      <option value="assignment">assignment</option>
                      <option value="first_assignment">first_assignment</option>
                      <option value="reward_shop">reward_shop</option>
                    </select>
                    <div class="text-xs mt-1" style="color:var(--sj-muted-text)">
                      –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –≤—Å–µ–≥–¥–∞ 2-–π —à–∞–≥.
                    </div>
                  </div>
                  <div>
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input class="input mt-1" x-model="formStep.title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —à–∞–≥–∞">
                  </div>

                  <div x-show="formStep.type==='ask_input'">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ü–æ–ª–µ</label>
                    <select class="select mt-1" x-model="formStep.ask_field">
                      <option value="first_name">first_name</option>
                      <option value="last_name">last_name</option>
                      <option value="phone">phone</option>
                      <option value="email">email</option>
                      <option value="name">name</option>
                    </select>
                  </div>

                  <div>
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ù–∞–≥—Ä–∞–¥–∞ (coins/xp)</label>
                    <div class="flex gap-2 mt-1">
                      <input type="number" class="input w-28" x-model.number="formStep.coins_award" placeholder="coins">
                      <input type="number" class="input w-28" x-model.number="formStep.xp_award" placeholder="xp">
                    </div>
                  </div>

                  <div class="md:col-span-2">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–¢–µ–∫—Å—Ç (Markdown)</label>
                    <textarea class="textarea mt-1" rows="4" x-model="formStep.body_md" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞"></textarea>
                  </div>

                  <div class="md:col-span-2">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–í–∏–¥–µ–æ (YouTube URL –∏–ª–∏ mp4)</label>
                    <input type="text" class="input mt-1" placeholder="https://youtu.be/..." x-model="formStep.media_url">
                  </div>

                  <div class="md:col-span-2" x-show="formStep.type==='interview_invite'">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ò–Ω—Ç–µ—Ä–≤—å—é (config)</label>
                    <div class="grid md:grid-cols-3 gap-2 mt-1">
                      <input type="datetime-local" class="input" x-model="formStep.cfg_date_time">
                      <input type="text" class="input" placeholder="–õ–æ–∫–∞—Ü–∏—è" x-model="formStep.cfg_location">
                      <input type="text" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" x-model="formStep.cfg_message">
                    </div>
                  </div>

                  <div class="md:col-span-2" x-show="formStep.type==='first_assignment'">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–î–∞—Ç–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="datetime-local" class="input mt-1" x-model="formStep.cfg_date_time">
                  </div>

                  <div class="md:col-span-2" x-show="formStep.type==='interest_selector'">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–õ–∏–º–∏—Ç –≤—ã–±–æ—Ä–∞ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤</label>
                    <input type="number" min="1" class="input mt-1 w-28" x-model.number="formStep.cfg_select_limit" placeholder="1">
                  </div>

                  <div class="md:col-span-2 flex items-center justify-end gap-2">
                    <button @click="addStepDialog=false" class="btn btn-ghost">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="saveNewStep()" class="btn btn-emerald" :disabled="saving">
                      <span x-show="!saving">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–≥</span>
                      <span x-show="saving">–°–æ–∑–¥–∞–Ω–∏–µ‚Ä¶</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Edit step dialog -->
              <div x-show="editStepDialog" x-transition.opacity x-cloak
                   id="edit-step-panel"
                   class="mt-4 p-4 rounded-xl border border-[var(--sj-border)] bg-[color-mix(in_ol, var(--sj-muted)_70%, transparent)]">
                <div class="grid md:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm" style="color:var(--sj-muted-text)">–¢–∏–ø</label>
                    <select class="select mt-1" x-model="formStep.type" :disabled="formStep.is_immutable || formStep.type==='registration_section'">
                      <option value="intro_page">intro_page</option>
                      <option value="interest_selector">interest_selector</option>
                      <option value="ask_input">ask_input</option>
                      <option value="choice_one">choice_one</option>
                      <option value="interview_invite">interview_invite</option>
                      <option value="assignment">assignment</option>
                      <option value="reward_shop">reward_shop</option>
                    </select>
                    <div class="text-xs mt-1" style="color:var(--sj-muted-text)" x-show="formStep.type==='registration_section'">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞.</div>
                  </div>
                  <div>
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input class="input mt-1" x-model="formStep.title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —à–∞–≥–∞">
                  </div>

                  <div x-show="formStep.type==='ask_input'">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ü–æ–ª–µ</label>
                    <select class="select mt-1" x-model="formStep.ask_field">
                      <option value="first_name">first_name</option>
                      <option value="last_name">last_name</option>
                      <option value="name">name</option>
                      <option value="phone">phone</option>
                      <option value="email">email</option>
                    </select>
                  </div>

                  <div>
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ù–∞–≥—Ä–∞–¥–∞</label>
                    <div class="flex gap-2 mt-1">
                      <input type="number" class="input w-28" x-model.number="formStep.coins_award">
                      <input type="number" class="input w-28" x-model.number="formStep.xp_award">
                    </div>
                  </div>

                  <div class="md:col-span-2">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–¢–µ–∫—Å—Ç (Markdown)</label>
                    <textarea class="textarea mt-1" rows="4" x-model="formStep.body_md" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–∞"></textarea>
                  </div>

                  <div class="md:col-span-2">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–í–∏–¥–µ–æ (YouTube URL –∏–ª–∏ mp4)</label>
                    <input type="text" class="input mt-1" placeholder="https://youtu.be/..." x-model="formStep.media_url">
                  </div>

                  <div class="md:col-span-2" x-show="formStep.type==='interview_invite'">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–ò–Ω—Ç–µ—Ä–≤—å—é (config)</label>
                    <div class="grid md:grid-cols-3 gap-2 mt-1">
                      <input type="datetime-local" class="input" x-model="formStep.cfg_date_time">
                      <input type="text" class="input" placeholder="–õ–æ–∫–∞—Ü–∏—è" x-model="formStep.cfg_location">
                      <input type="text" class="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" x-model="formStep.cfg_message">
                    </div>
                  </div>

                  <div class="md:col-span-2" x-show="formStep.type==='interest_selector'">
                    <label class="text-sm" style="color:var(--sj-muted-text)">–õ–∏–º–∏—Ç –≤—ã–±–æ—Ä–∞ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤</label>
                    <input type="number" min="1" class="input mt-1 w-28" x-model.number="formStep.cfg_select_limit" placeholder="1">
                  </div>

                  <div class="md:col-span-2 flex items-center justify-end gap-2">
                    <button @click="editStepDialog=false" class="btn btn-ghost">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="updateStep()" class="btn btn-indigo" :disabled="saving">
                      <span x-show="!saving">–û–±–Ω–æ–≤–∏—Ç—å</span>
                      <span x-show="saving">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶</span>
                    </button>
                  </div>
                </div>
              </div>
              <!-- /Edit step dialog -->
            </div>
          </div>
        </template>

        <!-- LEFT drawer: stats & option editor are –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ª–µ–≤–æ–º –¥—Ä–æ–≤–µ—Ä–µ –Ω–∏–∂–µ -->
      </div>
    </aside>
  </div>

  <!-- ===== LEFT DRAWER (Option editor + Flow stats) ===== -->
  <div x-show="optDrawer.open" x-cloak>
    <div class="fixed inset-0" :style="{background:'var(--sj-overlay)'}" @click="closeOptDrawer()"></div>

    <aside class="fixed inset-y-0 left-0 w-[620px] max-w-[95vw] z-50 card rounded-r-3xl border-r-[var(--sj-border)]
                  transition-transform"
           x-transition:enter="transform ease-out duration-250"
           x-transition:enter-start="-translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transform ease-in duration-200"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="-translate-x-full"
           @click.stop>

      <!-- Drawer header -->
      <div class="px-5 py-4" style="border-bottom:1px solid var(--sj-border)">
        <div class="flex items-center justify-between">
          <div class="min-w-0">
            <div class="text-lg font-semibold truncate"
                 x-text="onb.statsOpen ? '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–ª–æ—É' : '–†–µ–¥–∞–∫—Ç–æ—Ä —ç–ª–µ–º–µ–Ω—Ç–∞'"></div>

            <template x-if="!onb.statsOpen && onb.optEditor">
              <div class="text-xs mt-0.5" style="color:var(--sj-muted-text)">
                –û–ø—Ü–∏—è: <span class="font-mono" x-text="onb.optEditor?.key || '‚Äî'"></span>
                <span class="mx-1">‚Ä¢</span>
                –®–∞–≥ ID: <span class="font-mono" x-text="onb.optEditor?.step_id"></span>
              </div>
            </template>

            <template x-if="onb.statsOpen && onb.activeFlow">
              <div class="text-xs mt-0.5" style="color:var(--sj-muted-text)">
                –§–ª–æ—É: <span class="font-mono" x-text="onb.activeFlow?.name"></span>
                <span class="mx-1">‚Ä¢</span>
                ID: <span class="font-mono" x-text="onb.activeFlow?.id"></span>
              </div>
            </template>
          </div>
          <div class="flex items-center gap-2">
            <button x-show="!onb.statsOpen && onb.optEditor?.id" @click="deleteOption({id:onb.optEditor.id})" class="btn btn-rose">–£–¥–∞–ª–∏—Ç—å</button>
            <button @click="closeOptDrawer()" class="btn btn-ghost px-3" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>
        </div>
      </div>

      <!-- Drawer body -->
      <div class="h-[calc(100vh-64px)] overflow-y-auto overscroll-contain p-4 space-y-4">
        <!-- —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏ -->
        <template x-if="!onb.statsOpen && onb.optEditor">
          <div class="card p-4 space-y-3">
            <div>
              <label class="text-xs" style="color:var(--sj-muted-text)">–ö–ª—é—á</label>
              <input class="input mt-1" x-model="onb.optEditor.key" disabled>
            </div>
            <div>
              <label class="text-xs" style="color:var(--sj-muted-text)">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
              <input class="input mt-1" x-model="onb.optEditor.title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏">
            </div>
            <div>
              <label class="text-xs" style="color:var(--sj-muted-text)">–¢–µ–∫—Å—Ç (Markdown)</label>
              <textarea class="textarea mt-1" rows="6" x-model="onb.optEditor.body_md" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ / –∫–æ–Ω—Ç–µ–Ω—Ç –æ–ø—Ü–∏–∏"></textarea>
            </div>
            <div>
              <label class="text-xs" style="color:var(--sj-muted-text)">–ú–µ–¥–∏–∞ (YouTube URL –∏–ª–∏ mp4)</label>
              <input class="input mt-1" x-model="onb.optEditor.media_url" placeholder="https://youtu.be/... –∏–ª–∏ https://.../video.mp4">
            </div>

            <!-- Preview -->
            <div class="rounded-xl border border-[var(--sj-border)] p-3 bg-[color-mix(in_ol, var(--sj-muted)_70%, transparent)]" x-show="onb.optEditor.media_url">
              <div class="text-xs mb-2" style="color:var(--sj-muted-text)">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–∏–∞</div>
              <template x-if="/youtube\.com|youtu\.be/.test(onb.optEditor.media_url||'')">
                <div class="rounded-xl overflow-hidden border border-[var(--sj-border)]">
                  <iframe class="w-full aspect-video" :src="youtubeEmbed(onb.optEditor.media_url)" frameborder="0" allowfullscreen></iframe>
                </div>
              </template>
              <template x-if="!/youtube\.com|youtu\.be/.test(onb.optEditor.media_url||'')">
                <video class="w-full rounded-xl border border-[var(--sj-border)]" controls :src="onb.optEditor.media_url"></video>
              </template>
            </div>

            <div class="flex items-center justify-end gap-2 pt-2">
              <button class="btn btn-ghost" @click="closeOptDrawer()">–û—Ç–º–µ–Ω–∞</button>
              <button class="btn btn-indigo" :disabled="saving" @click="saveOption()">
                <span x-show="!saving">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                <span x-show="saving">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶</span>
              </button>
            </div>
          </div>
        </template>

        <!-- —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–ª–æ—É -->
        <template x-if="onb.statsOpen">
          <div class="space-y-4">
            <!-- —Ñ–∏–ª—å—Ç—Ä—ã -->
            <div class="card p-4">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs" style="color:var(--sj-muted-text)">–û–∫–Ω–æ (–¥–Ω–µ–π)</label>
                  <select class="select mt-1" x-model.number="onb.statsDays" @change="loadFlowStats(onb.activeFlow.id); loadFlowSessions(onb.activeFlow.id, 1)">
                    <option :value="7">7</option>
                    <option :value="14">14</option>
                    <option :value="30">30</option>
                    <option :value="90">90</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs" style="color:var(--sj-muted-text)">–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</label>
                  <input class="input mt-1" placeholder="–∏–º—è –∏–ª–∏ email"
                         x-model.debounce.400ms="onb.sessionsQuery"
                         @input="debouncedLoadSessions()">
                </div>
              </div>
            </div>

            <!-- KPI -->
            <div class="grid grid-cols-3 gap-3">
              <div class="card p-4">
                <div class="text-sm" style="color:var(--sj-muted-text)">–ù–∞—á–∞–ª–∏</div>
                <div class="text-2xl font-bold" x-text="onb.stats?.started ?? 0"></div>
              </div>
              <div class="card p-4">
                <div class="text-sm" style="color:var(--sj-muted-text)">–ó–∞–≤–µ—Ä—à–∏–ª–∏</div>
                <div class="text-2xl font-bold" x-text="onb.stats?.completed ?? 0"></div>
              </div>
              <div class="card p-4">
                <div class="text-sm" style="color:var(--sj-muted-text)">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</div>
                <div class="text-2xl font-bold" x-text="(onb.stats?.completion_rate ?? 0) + '%'"></div>
              </div>
            </div>

            <div class="card p-4">
              <div class="text-sm mb-2" style="color:var(--sj-muted-text)">–û—Ç—Ç–æ–∫ –ø–æ —à–∞–≥–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π —à–∞–≥ —É –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö; -1 = –¥–æ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞)</div>
              <table class="w-full text-sm">
                <thead>
                  <tr>
                    <th class="text-left py-2">–®–∞–≥</th>
                    <th class="text-left py-2">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th class="text-right py-2">–û—Ç—Ç–æ–∫</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="row in (onb.stats?.funnel || [])" :key="row.order_index">
                    <tr>
                      <td class="py-2">#<span x-text="row.order_index"></span></td>
                      <td class="py-2" x-text="row.title || row.type || '‚Äî'"></td>
                      <td class="py-2 text-right" x-text="row.drop_count"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
              <div class="text-xs mt-2" style="color:var(--sj-muted-text)">
                –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:
                <b x-text="Math.round((onb.stats?.avg_time_to_complete_sec||0)/60) + ' –º–∏–Ω'"></b>
              </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π -->
            <div class="card p-4">
              <div class="flex items-center justify-between mb-2">
                <div class="font-semibold">–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</div>
                <div class="flex items-center gap-2">
                  <label class="text-xs flex items-center gap-1" style="color:var(--sj-muted-text)">
                    <input type="checkbox" class="rounded" x-model="onb.onlyActive" @change="loadFlowSessions(onb.activeFlow.id, 1)"> –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
                  </label>
                  <label class="text-xs flex items-center gap-1" style="color:var(--sj-muted-text)">
                    <input type="checkbox" class="rounded" x-model="onb.onlyCompleted" @change="loadFlowSessions(onb.activeFlow.id, 1)"> –¢–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ
                  </label>
                </div>
              </div>

              <div class="space-y-2">
                <template x-for="it in onb.sessions?.items || []" :key="it.session_id">
                  <div class="rounded-xl border border-[var(--sj-border)] bg-[color-mix(in_ol, var(--sj-muted)_60%, transparent)] p-3">
                    <div class="flex items-center justify-between gap-3">
                      <div class="min-w-0">
                        <div class="font-medium truncate" x-text="(it.user?.display_name || it.user?.email || ('–°–µ—Å—Å–∏—è #' + it.session_id))"></div>
                        <div class="text-xs" style="color:var(--sj-muted-text)">
                          <span>–°—Ç–∞—Ä—Ç: <span x-text="it.started_at ? new Date(it.started_at).toLocaleString() : '‚Äî'"></span></span>
                          <span class="mx-2">‚Ä¢</span>
                          <span>–°—Ç–∞—Ç—É—Å: <b x-text="it.state"></b></span>
                          <template x-if="it.finished_at">
                            <span>
                              <span class="mx-2">‚Ä¢</span> –§–∏–Ω–∏—à:
                              <span x-text="new Date(it.finished_at).toLocaleString()"></span>
                            </span>
                          </template>
                        </div>
                      </div>
                      <div class="shrink-0 text-right">
                        <div class="text-sm">–ü—Ä–æ–≥—Ä–µ—Å—Å: <b x-text="(it.progress?.percent ?? 0) + '%'"></b></div>
                        <div class="w-40 h-2 rounded bg-[color-mix(in_ol, var(--sj-muted)_80%, transparent)] mt-1 overflow-hidden">
                          <div class="h-2 bg-emerald-400" :style="`width:${Math.max(0, Math.min(100, it.progress?.percent||0))}%`"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>

                <div x-show="!onb.sessions?.items?.length" class="text-sm" style="color:var(--sj-muted-text)">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</div>
              </div>

              <!-- –ø–∞–≥–∏–Ω–∞—Ü–∏—è -->
              <div class="flex items-center justify-between mt-3" x-show="(onb.sessions?.total||0) > (onb.sessions?.per_page||20)">
                <button class="btn btn-ghost text-sm py-1.5" :disabled="onb.sessions?.page<=1" @click="loadFlowSessions(onb.activeFlow.id, onb.sessions.page-1)">‚Üê –ù–∞–∑–∞–¥</button>
                <div class="text-xs" style="color:var(--sj-muted-text)">
                  –°—Ç—Ä. <b x-text="onb.sessions?.page||1"></b> / <b x-text="Math.ceil((onb.sessions?.total||0)/(onb.sessions?.per_page||20))"></b>
                </div>
                <button class="btn btn-ghost text-sm py-1.5"
                        :disabled="(onb.sessions?.page||1) >= Math.ceil((onb.sessions?.total||0)/(onb.sessions?.per_page||20))"
                        @click="loadFlowSessions(onb.activeFlow.id, onb.sessions.page+1)">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
              </div>
            </div>
          </div>
        </template>

        <div x-show="!onb.statsOpen && !onb.optEditor" class="text-sm" style="color:var(--sj-muted-text)">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ.</div>
      </div>
    </aside>
  </div>

</section>
{% endblock %}

{% block scripts %}
<script>
/* ========= API client with safe fallbacks ========= */
function createApi(){
  const withCreds = { credentials:'same-origin' };
  async function parse(r){
    let j=null; try{ j=await r.json(); }catch(_){}
    if(!r.ok){ throw new Error(j?.description || j?.detail || j?.message || `HTTP ${r.status}`); }
    return j ?? {};
  }
  async function get(u){ return parse(await fetch(u, withCreds)); }
  async function del(u){ return parse(await fetch(u, {...withCreds, method:'DELETE'})); }
  async function post(u, body){
    const opts={...withCreds, method:'POST'};
    if(body instanceof FormData){ opts.body=body; }
    else { opts.headers={'Content-Type':'application/json'}; opts.body=JSON.stringify(body||{}); }
    return parse(await fetch(u, opts));
  }
  async function put(u, body){
    const opts={...withCreds, method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{})};
    return parse(await fetch(u, opts));
  }
  return {get, post, put, del};
}
const API = createApi();

/* ========= helpers ========= */
function normFlowList(raw){
  const arr = raw?.flows || raw?.data || raw || [];
  return Array.isArray(arr) ? arr.map(f => ({ id:f.id, name:f.name??'', is_active:!!(f.is_active??f.active), final_bonus_coins:Number(f.final_bonus_coins??f.bonus??0) })) : [];
}
function normStepsPayload(j){
  const flow = (j?.flow || j?.data?.flow || j);
  const stepsRaw = (j?.steps || j?.data?.steps || []);
  const links = (j?.links||j?.data?.links||[]).map(l=>({id:l.id, slug:l.slug, uses_count:l.uses_count||0, max_uses:l.max_uses??null, expires_at:l.expires_at||null}));

  const steps = stepsRaw.map(s => {
    const options = (s.options || []).map(o => {
      const id = o.id ?? o.option_id ?? o.pk ?? o.uuid ?? o.option?.id ?? o.option?.option_id ?? null;
      const key = o.key ?? o.option?.key ?? o.slug ?? '';
      return { id, key, title: o.title ?? o.option?.title ?? '', body_md: o.body_md ?? o.option?.body_md ?? '', media_url: o.media_url ?? o.option?.media_url ?? null, step_id: s.id };
    });
    return {
      id: s.id, type: s.type, title: s.title || '', ask_field: s.ask_field || null,
      body_md: s.body_md || null, media_url: s.media_url || null,
      coins_award: Number(s.coins_award || 0), xp_award: Number(s.xp_award || 0),
      order_index: Number(s.order_index || 0), is_active: !!(s.is_active ?? true),
      is_immutable: !!s.is_immutable, config: s.config || {}, options
    };
  }).sort((a,b)=>a.order_index-b.order_index);

  return {flow: flow ? { id:flow.id, name:flow.name??'', is_active:!!(flow.is_active??flow.active), final_bonus_coins:Number(flow.final_bonus_coins??flow.bonus??0)} : null, steps, links};
}

/* ========= App ========= */
window.partnerCompanyPage = function(initialCompanyId){
  return {
    /* ===== base ===== */
    companyId: initialCompanyId, company:null, kpi:{}, feed:[], tasks:[], leaderboard:[], tab:'feed',
    canPost:false, canCreateTasks:false, saving:false,

    newPost:'', newPinned:false, newPostFile:null, newPostPreview:'',
    inviteModal:false, invite:null,

    adminModal:{ open:false, form:{ email:'', password:'', display_name:'' } },
    storeModal:{ open:false, mode:'create', id:null, form:{ type:'skin', title:'', cost_coins:0, min_level:0, stock:'', payload:'' } },

    taskModal:{ open:false, mode:'create', taskId:null,
      form:{ title:'', description:'', points_xp:20, coins:5, due_at:'', priority:'normal', require_proof:true, reward_achievement_id:null, _due_date:'' },
      query:'', members:[], selectedIds:[], _byId:Object.create(null)
    },

    people:{ items:[], page:1, per_page:20, total:0, query:'' },

    onbDrawer:{ open:false },
    optDrawer:{ open:false },

    onb:{ flows:[], activeFlow:null, steps:[], links:[],
      tmpOpt:{key:'', title:'', body_md:''},
      optEditor:null,
      statsOpen:false, stats:null, statsDays:30, sessions:null, sessionsQuery:'', onlyActive:false, onlyCompleted:false
    },
    onbLoading:false,

    addStepDialog:false, editStepDialog:false,
    formStep:{ id:null, type:'intro_page', title:'', ask_field:'', coins_award:0, xp_award:0, body_md:'', media_url:'', cfg_date_time:'', cfg_location:'', cfg_message:'', cfg_select_limit:1, is_immutable:false },

    store:{ items:[] },

    get headerSubtitle(){ return this.company ? `${this.company.name} (${this.company.slug})` : '–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π' },

    /* ===== utilities ===== */
    toLocalInputDate(iso){ if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; },
    isoFromLocalDateEnd(s){ if(!s) return null; const dt=new Date(`${s}T23:59:59`); return dt.toISOString(); },
    youtubeEmbed(u){ try{ if(!u) return ''; const m1=u.match(/youtu\.be\/([\w-]+)/); const m2=u.match(/[?&]v=([\w-]+)/); const id=(m1&&m1[1])||(m2&&m2[1])||''; return id?`https://www.youtube.com/embed/${id}`:u; }catch(e){ return u; } },
    toast(msg, emoji='‚ÑπÔ∏è'){ const s=Alpine.store?.('toasts'); if(s?.push) s.push({title:String(msg), emoji}); else alert(msg); },
    copy(v){ navigator.clipboard?.writeText(v).then(()=> Alpine.store('toasts')?.push?.({title:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', emoji:'üìã'})); },

    /* ===== feed/tasks ===== */
    async submitProof(taskId, ev){
      const input=ev.target; const file=input.files?.[0]; if(!file) return;
      const fd=new FormData(); fd.append('photo', file);
      try{
        const r=await fetch(`/api/company/tasks/${taskId}/submit`, {method:'POST', body:fd, credentials:'same-origin'});
        if(!r.ok){ let err=null; try{ err=await r.json(); }catch(_){ } this.toast(err?.description||'–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç','‚õî'); return; }
        this.toast('–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω','üì§'); input.value=''; await this.loadDashboard();
      }catch(_e){ this.toast('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞','‚õî'); }
    },
    openTaskModal(mode, task=null){
      this.taskModal.open=true; document.body.style.overflow='hidden';
      this.taskModal.mode=mode; this.taskModal.taskId=null;
      this.taskModal.form={ title:'', description:'', points_xp:20, coins:5, due_at:'', priority:'normal', require_proof:true, reward_achievement_id:null, _due_date:'' };
      this.taskModal.selectedIds=[]; this.taskModal.query=''; this.taskModal.members=[]; this.taskModal._byId=Object.create(null);
      if(mode==='edit' && task){
        this.taskModal.taskId=task.id;
        this.taskModal.form={ title:task.title||'', description:task.description||'', points_xp:task.points_xp??20, coins:task.coins??5, due_at:task.due_at||'', _due_date:task.due_at?this.toLocalInputDate(task.due_at):'', priority:task.priority||'normal', require_proof:!!task.require_proof, reward_achievement_id:task.reward_achievement_id??null };
        const preset=this.extractAssignedIds(task); this.taskModal.selectedIds=preset.length?preset:[]; if(!preset.length) this.tryFetchAssignees(task.id);
      }
      this.tmFetchMembers();
    },
    closeTaskModal(){ this.taskModal.open=false; document.body.style.overflow=''; this.taskModal.taskId=null; },
    extractAssignedIds(task){
      const out=[]; if(task){
        if(Array.isArray(task.assigned_user_ids)) out.push(...task.assigned_user_ids);
        else if(Array.isArray(task.assignees)) out.push(...task.assignees.map(a=> (typeof a==='object' ? (a.id??a.user_id) : a)));
        else if(Array.isArray(task.assigned)) out.push(...task.assigned);
        else if(Array.isArray(task.assigned_ids)) out.push(...task.assigned_ids);
      }
      return out.map(x=>String(x));
    },
    async tryFetchAssignees(taskId){
      const cid=this.companyId;
      const urls=[
        `/api/partners/company/${cid}/tasks/${taskId}/assign`,
        `/api/partners/company/${cid}/tasks/${taskId}/assignees`,
        `/api/partners/company/${cid}/tasks/${taskId}?with=assignees=1`,
      ];
      for(const u of urls){
        try{
          const j=await API.get(u);
          const ids= Array.isArray(j?.assigned_user_ids)?j.assigned_user_ids
            : Array.isArray(j?.assignees)? j.assignees.map(a=>a.id??a.user_id??a)
            : Array.isArray(j)? j.map(a=>a.id??a.user_id??a) : null;
          if(ids && ids.length){ this.taskModal.selectedIds=ids.map(x=>String(x)); break; }
        }catch(_e){}
      }
    },
    async tmFetchMembers(){
      try{
        const q=this.taskModal.query?`?query=${encodeURIComponent(this.taskModal.query)}`:'';
        const d=await API.get(`/api/partners/company/${this.companyId}/members${q}`);
        this.taskModal.members=d.members||d.items||[]; this.taskModal._byId=Object.create(null);
        for(const m of this.taskModal.members){ this.taskModal._byId[String(m.id)]=m; }
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    tmSearchMembers(){ clearTimeout(this._tmTimer); this._tmTimer=setTimeout(()=>this.tmFetchMembers(), 250); },
    tmToggleSelect(id){ id=String(id); const i=this.taskModal.selectedIds.indexOf(id); if(i===-1) this.taskModal.selectedIds.push(id); else this.taskModal.selectedIds.splice(i,1); },
    tmUnselect(id){ id=String(id); const i=this.taskModal.selectedIds.indexOf(id); if(i!==-1) this.taskModal.selectedIds.splice(i,1); },
    nameById(id){ id=String(id); return this.taskModal._byId[id]?.display_name || `#${id}`; },
    async saveTask(){
      const cid=this.companyId; const body={...this.taskModal.form};
      body.due_at = (body._due_date && body._due_date.trim()) ? this.isoFromLocalDateEnd(body._due_date.trim()) : null; delete body._due_date;
      try{
        if(this.taskModal.mode==='create'){
          const created=await API.post(`/api/partners/company/${cid}/tasks`, body);
          const taskId=created?.task_id || created?.id;
          if(taskId && this.taskModal.selectedIds.length){
            try{ await API.post(`/api/partners/company/${cid}/tasks/${taskId}/assign`, { user_ids:this.taskModal.selectedIds.map(Number), replace:true }); }
            catch(e){ this.toast('–°–æ–∑–¥–∞–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤','‚ö†Ô∏è'); }
          }
          this.toast('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞','‚úÖ');
        }else{
          const taskId=this.taskModal.taskId; if(!taskId) return;
          await API.put(`/api/partners/company/${cid}/tasks/${taskId}`, body);
          try{ await API.post(`/api/partners/company/${cid}/tasks/${taskId}/assign`, { user_ids:this.taskModal.selectedIds.map(Number), replace:true }); }
          catch(e){ this.toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è','‚ö†Ô∏è'); }
          this.toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã','üíæ');
        }
      }catch(e){ this.toast(e.message,'‚õî'); }
      this.closeTaskModal(); await this.loadDashboard();
    },

    /* ===== people ===== */
    async loadPeople(page=1){
      try{
        const params = new URLSearchParams();
        params.set('page', String(page)); params.set('per_page', String(this.people.per_page));
        if(this.people.query?.trim()) params.set('query', this.people.query.trim());
        const r = await API.get(`/api/partners/company/${this.companyId}/members?`+params.toString());
        this.people.items = r.members || r.items || r.data || [];
        this.people.page = r.page || page;
        this.people.per_page = r.per_page || r.limit || 20;
        this.people.total = r.total || r.count || this.people.items.length;
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    async setCompanyAdmin(userId, makeAdmin){
      const cid=this.companyId;
      const tries = makeAdmin
        ? [
            [`/api/partners/company/${cid}/admins`, 'POST', { user_id:userId }],
            [`/api/partners/company/${cid}/members/${userId}/admin`, 'PUT', { is_admin:true }],
            [`/api/partners/company/${cid}/admin/${userId}`, 'POST', {}],
          ]
        : [
            [`/api/partners/company/${cid}/admins/${userId}`, 'DELETE', {}],
            [`/api/partners/company/${cid}/members/${userId}/admin`, 'PUT', { is_admin:false }],
            [`/api/partners/company/${cid}/admin/${userId}`, 'DELETE', {}],
          ];
      let ok=false, err=null;
      for(const [u,m,b] of tries){
        try{
          if(m==='POST') await API.post(u,b);
          else if(m==='PUT') await API.put(u,b);
          else await API.del(u);
          ok=true; break;
        }catch(e){ err=e; }
      }
      if(ok){ this.toast(makeAdmin?'–ù–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–æ–º':'–°–Ω—è—Ç —Å –∞–¥–º–∏–Ω–æ–≤','‚úÖ'); this.loadPeople(this.people.page); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å','‚õî'); }
    },
    async removeFromCompany(userId){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏?')) return;
      const cid=this.companyId;
      const tries = [
        `/api/partners/company/${cid}/members/${userId}`,
        `/api/partners/company/${cid}/member/${userId}`,
        `/api/partners/company/${cid}/users/${userId}`,
      ];
      let ok=false, err=null;
      for(const u of tries){
        try{ await API.del(u); ok=true; break; }catch(e){ err=e; }
      }
      if(ok){ this.toast('–£–¥–∞–ª—ë–Ω','üóëÔ∏è'); this.loadPeople(this.people.page); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å','‚õî'); }
    },
    openCreateAdmin(){ this.adminModal.open=true; },
    closeAdminModal(){ this.adminModal.open=false; this.adminModal.form={ email:'', password:'', display_name:'' }; },
    async createCompanyAdmin(){
      const cid=this.companyId; const b={...this.adminModal.form};
      const tries = [
        () => API.post(`/api/partners/company/${cid}/admins`, b),
        () => API.post(`/api/partners/company/${cid}/admin`, b),
      ];
      let ok=false, err=null;
      for(const fn of tries){ try{ await fn(); ok=true; break; }catch(e){ err=e; } }
      if(ok){ this.toast('–ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω','‚ú®'); this.closeAdminModal(); this.loadPeople(); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞','‚õî'); }
    },

    /* ===== store ===== */
    async loadStore(){
      try{
        const r = await API.get(`/api/partners/company/${this.companyId}/store`);
        this.store.items = r.items || r.store || r.data || r || [];
      }catch(e){
        // fallback
        try{
          const r2 = await API.get(`/api/partners/company/${this.companyId}/shop`);
          this.store.items = r2.items || r2.store || r2.data || r2 || [];
        }catch(err){ this.toast(err.message,'‚õî'); }
      }
    },
    openStoreModal(mode, item=null){
      this.storeModal.open=true; this.storeModal.mode=mode; this.storeModal.id=null;
      this.storeModal.form={ type:'skin', title:'', cost_coins:0, min_level:0, stock:'', payload:'' };
      if(mode==='edit' && item){
        this.storeModal.id=item.id;
        this.storeModal.form={ type:item.type||'skin', title:item.title||'', cost_coins:Number(item.cost_coins||0), min_level:Number(item.min_level||0), stock:item.stock??'', payload:(typeof item.payload==='string'?item.payload: JSON.stringify(item.payload||{})) };
      }
    },
    closeStoreModal(){ this.storeModal.open=false; this.storeModal.id=null; },
    async saveStoreItem(){
      const cid=this.companyId; const b={...this.storeModal.form};
      if(b.payload && typeof b.payload==='string'){ try{ b.payload_json = JSON.parse(b.payload); }catch(_){ b.payload_json=null; } }
      const payload = { type:b.type, title:b.title, cost_coins:Number(b.cost_coins||0), min_level:Number(b.min_level||0), stock: b.stock===''? null : b.stock, payload: b.payload_json ?? b.payload ?? null };
      try{
        if(this.storeModal.mode==='create'){
          await API.post(`/api/partners/company/${cid}/store`, payload);
          this.toast('–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω','‚úÖ');
        }else{
          const id = this.storeModal.id;
          await API.put(`/api/partners/company/${cid}/store/${id}`, payload);
          this.toast('–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω','üíæ');
        }
        this.closeStoreModal(); this.loadStore();
      }catch(e){
        // fallback endpoints
        try{
          if(this.storeModal.mode==='create'){
            await API.post(`/api/partners/company/${cid}/shop/items`, payload);
          }else{
            await API.put(`/api/partners/company/${cid}/shop/items/${this.storeModal.id}`, payload);
          }
          this.toast(this.storeModal.mode==='create'?'–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω':'–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω','‚úÖ');
          this.closeStoreModal(); this.loadStore();
        }catch(err){ this.toast(err.message,'‚õî'); }
      }
    },
    async toggleStoreItem(item){
      const cid=this.companyId; const id=item.id; const next=!item.is_active;
      const bodies=[{is_active:next},{active:next}];
      let ok=false, err=null;
      for(const b of bodies){
        try{ await API.put(`/api/partners/company/${cid}/store/${id}`, b); ok=true; break; }catch(e){ err=e; }
      }
      if(!ok){
        try{ await API.put(`/api/partners/company/${cid}/shop/items/${id}`, {is_active:next}); ok=true; }catch(e){ err=e; }
      }
      if(ok){ item.is_active=next; this.toast(next?'–í–∫–ª—é—á–µ–Ω–æ':'–í—ã–∫–ª—é—á–µ–Ω–æ','üîÅ'); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å','‚õî'); }
    },
    async deleteStoreItem(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
      const cid=this.companyId;
      const tries = [
        `/api/partners/company/${cid}/store/${id}`,
        `/api/partners/company/${cid}/shop/items/${id}`
      ];
      let ok=false, err=null;
      for(const u of tries){ try{ await API.del(u); ok=true; break; }catch(e){ err=e; } }
      if(ok){ this.toast('–£–¥–∞–ª–µ–Ω–æ','üóëÔ∏è'); this.loadStore(); }
      else { this.toast(err?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å','‚õî'); }
    },

    /* ===== invites ===== */
    async openInviteModal(){ this.inviteModal=true; try{ this.invite = await API.get(`/api/partners/company/${this.companyId}/invite`);}catch(e){ this.toast(e.message,'‚õî'); } },
    async regenerateInvite(){ try{ this.invite = await API.post(`/api/partners/company/${this.companyId}/invite/regenerate`,{});}catch(e){ this.toast(e.message,'‚õî'); } },
    async deactivateInvite(){ try{ this.invite = await API.post(`/api/partners/company/${this.companyId}/invite/deactivate`,{});}catch(e){ this.toast(e.message,'‚õî'); } },

    /* ===== onboarding core ===== */
    openOnbDrawer(){ this.onbDrawer.open=true; document.body.style.overflow='hidden'; if(!this.onb.flows.length) this.loadFlows(); },
    closeOnbDrawer(){ this.onbDrawer.open=false; document.body.style.overflow=''; },

    async loadFlows(){
      if(!this.companyId) return;
      this.onbLoading=true;
      try{
        const j=await API.get(`/api/partners/company/${this.companyId}/onboarding/flows`);
        this.onb.flows=normFlowList(j);
        if(!this.onb.activeFlow && this.onb.flows.length){ await this.openFlow(this.onb.flows[0].id); }
      }catch(e){ this.toast(e.message,'‚õî'); }
      finally{ this.onbLoading=false; }
    },
    async createFlow(){
      const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–ª–æ—É', '–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞'); if(!name) return;
      try{
        const flow=await API.post(`/api/partners/company/${this.companyId}/onboarding/flows`, { name, final_bonus_coins:50, is_active:true });
        await this.ensureRegistrationStep(flow.id, true);
        this.toast('–§–ª–æ—É —Å–æ–∑–¥–∞–Ω','‚ú®'); await this.loadFlows(); await this.openFlow(flow.id);
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    async createFlowQuick(){
      const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–ª–æ—É','–û–Ω–±–æ—Ä–¥–∏–Ω–≥ (–±—ã—Å—Ç—Ä—ã–π)'); if(!name) return;
      try{
        const flow=await API.post(`/api/partners/company/${this.companyId}/onboarding/flows`, { name, final_bonus_coins:50, is_active:true });
        const flowId=flow.id;
        const steps=[
          {type:'intro_page', title:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', body_md:'–ö–æ—Ä–æ—Ç–∫–æ —Ä–∞—Å—Å–∫–∞–∂–µ–º, —á—Ç–æ –¥–∞–ª—å—à–µ.', is_required:false, coins_award:5, xp_award:5, order_index:0, config:{}, media_url:null},
          /* —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 1 */
          {type:'choice_one', title:'–ü–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è —Å –∫–æ–º–ø–∞–Ω–∏–µ–π?', body_md:'–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ –∫–æ–º–ø–∞–Ω–∏–∏ —Å–µ–π—á–∞—Å –∏–ª–∏ –ø–æ–∑–∂–µ.', is_required:false, coins_award:5, xp_award:5, order_index:2, config:{}, media_url:null},
          {type:'reward_shop', title:'–§–∏–Ω–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å', body_md:'–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏–∑.', is_required:false, coins_award:0, xp_award:0, order_index:3, config:{}, media_url:null}
        ];
        for(const s of steps){ await API.post(`/api/partners/onboarding/flows/${flowId}/steps`, s); }
        await this.ensureRegistrationStep(flowId, true);
        this.toast('–§–ª–æ—É —Å–æ–∑–¥–∞–Ω','‚ú®'); await this.loadFlows(); await this.openFlow(flowId);
      }catch(e){ this.toast(e.message,'‚õî'); }
    },

    async openFlow(flowId){
      try{
        const j=await API.get(`/api/partners/onboarding/flows/${flowId}/steps`);
        const {flow, steps, links}=normStepsPayload(j);
        this.onb.activeFlow=flow; this.onb.steps=steps; this.onb.links=links;
        await this.ensureRegistrationStep(flowId, false); // –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏—è/–ø–æ—á–∏–Ω–∫–∞ –ø–æ—Ä—è–¥–∫–∞
        if(this.onb.statsOpen){ this.loadFlowStats(flowId); this.loadFlowSessions(flowId, 1); }
      }catch(e){ this.toast(e.message,'‚õî'); }
    },

    /* === —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è: –≤—Å–µ–≥–¥–∞ 2-—è –∏ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–∞—è === */
    async ensureRegistrationStep(flowId, createIfMissing){
      // 1) –µ—Å—Ç—å –ª–∏ —É–∂–µ?
      let reg = this.onb.steps.find(s => s.type === 'registration_section');
      if(!reg && createIfMissing){
        // —Å–æ–∑–¥–∞—ë–º —à–∞–≥
        try{
          reg = await API.post(`/api/partners/onboarding/flows/${flowId}/steps`, {
            type:'registration_section', title:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', body_md:'–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.', is_required:true,
            coins_award:5, xp_award:5, order_index:1, config:{}
          });
        }catch(e){ this.toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é','‚õî'); }
      }
      // —Ä–µ—Ñ—Ä–µ—à
      try{
        const j=await API.get(`/api/partners/onboarding/flows/${flowId}/steps?ts=${Date.now()}`);
        const {steps}=normStepsPayload(j); this.onb.steps=steps;
      }catch(_){}

      // 2) –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å index=1
      const idxReg = this.onb.steps.findIndex(s => s.type==='registration_section');
      if(idxReg === -1) return; // –Ω–µ—Ç –ø—Ä–∞–≤/—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏–º
      // –ø–æ–º–µ—á–∞–µ–º –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–º
      this.onb.steps[idxReg].is_immutable = true;

      // –µ—Å–ª–∏ –Ω–µ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 1 ‚Äî –ø–µ—Ä–µ—Å—Ç–∞–≤–∏–º –ª–æ–∫–∞–ª—å–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–∏–º reorder
      if(this.onb.steps[idxReg].order_index !== 1 || idxReg !== 1){
        const reordered = [...this.onb.steps];
        const regStep = reordered.splice(idxReg,1)[0];
        reordered.splice(1,0,regStep);
        reordered.forEach((s,i)=> s.order_index=i);
        this.onb.steps = reordered;

        // –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Ä—è–¥–∫–∞
        try{
          await API.post(`/api/partners/onboarding/flows/${flowId}/reorder`, { order: this.onb.steps.map(s=>s.id) });
        }catch(_){}
      }
    },

    moveStep(idx, delta){
      const a=this.onb.steps[idx], b=this.onb.steps[idx+delta];
      if(!a || !b) return;
      if(a.is_immutable || b.is_immutable) return; // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞—â–∏—â–µ–Ω–∞
      [this.onb.steps[idx], this.onb.steps[idx+delta]]=[b,a];
      this.onb.steps.forEach((s,i)=> s.order_index=i);
    },
    async saveOrder(){
      if(!this.onb.activeFlow) return; this.saving=true;
      // –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 1
      const idxReg = this.onb.steps.findIndex(s => s.type==='registration_section');
      if(idxReg>-1 && idxReg!==1){
        const reg = this.onb.steps.splice(idxReg,1)[0];
        this.onb.steps.splice(1,0,reg);
      }
      this.onb.steps.forEach((s,i)=> s.order_index=i);
      try{ await API.post(`/api/partners/onboarding/flows/${this.onb.activeFlow.id}/reorder`, { order:this.onb.steps.map(s=>s.id) }); this.toast('–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω','‚úÖ'); }
      catch(e){ this.toast(e.message,'‚õî'); }
      finally{ this.saving=false; }
    },
    async deleteFlow(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–ª–æ—É —Ü–µ–ª–∏–∫–æ–º? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
      try{
        await API.del(`/api/partners/onboarding/flows/${id}`);
        this.toast('–§–ª–æ—É —É–¥–∞–ª—ë–Ω','üóëÔ∏è'); await this.loadFlows();
        if(this.onb.activeFlow?.id===id){ this.onb.activeFlow=null; this.onb.steps=[]; this.onb.links=[]; }
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    editStep(s){
      this.addStepDialog = false;
      this.formStep = {
        id: s.id, type: s.type, title: s.title || '', ask_field: s.ask_field || '',
        coins_award: s.coins_award || 0, xp_award: s.xp_award || 0,
        body_md: s.body_md || '', media_url: s.media_url || '',
        cfg_date_time: (s.config && s.config.date_time) ? s.config.date_time : '',
        cfg_location: (s.config && s.config.location) ? s.config.location : '',
        cfg_message: (s.config && s.config.message) ? s.config.message : '',
        cfg_select_limit: (s.config && s.config.select_limit) ? s.config.select_limit : 1,
        is_immutable: (s.is_immutable || s.type==='registration_section')
      };
      this.editStepDialog = true;
      this.$nextTick(() => {
        const el = this.$root.querySelector('#edit-step-panel');
        el && el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    },
    async updateStep(){
      const id=this.formStep.id; if(!id) return; this.saving=true;
      try{
        const cfg=this.formStep.type==='interview_invite' ? { date_time:this.formStep.cfg_date_time||null, location:this.formStep.cfg_location||null, message:this.formStep.cfg_message||null }
                   : this.formStep.type==='interest_selector' ? { select_limit:Number(this.formStep.cfg_select_limit||1) } : {};
        const body={ type:this.formStep.type, title:this.formStep.title, ask_field:this.formStep.ask_field||null, body_md:this.formStep.body_md||null, media_url:this.formStep.media_url||null, coins_award:Number(this.formStep.coins_award||0), xp_award:Number(this.formStep.xp_award||0), config:cfg };
        if(this.formStep.type==='registration_section'){ delete body.type; } // —Ç–∏–ø –Ω–µ–ª—å–∑—è
        await API.put(`/api/partners/onboarding/steps/${id}`, body);
        this.editStepDialog=false; await this.openFlow(this.onb.activeFlow.id);
      }catch(e){ this.toast(e.message,'‚õî'); }
      finally{ this.saving=false; }
    },
    async toggleStepActive(s, checked){
      const prev=!!s.is_active; s.is_active=!!checked;
      try{
        await API.put(`/api/partners/onboarding/steps/${s.id}`, { is_active:!!checked });
        // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é –Ω–µ –¥–∞—ë–º –≤—ã–∫–ª—é—á–∞—Ç—å:
        if(s.type==='registration_section' && !checked){ s.is_active=true; await API.put(`/api/partners/onboarding/steps/${s.id}`, { is_active:true }); this.toast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∫–ª—é—á–µ–Ω–∞','‚ö†Ô∏è'); }
      }catch(e){ s.is_active=prev; this.toast(e.message,'‚õî'); }
    },
    async deleteStep(stepId){
      const s=this.onb.steps.find(x=>x.id===stepId);
      if(s?.type==='registration_section'){ this.toast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é —É–¥–∞–ª—è—Ç—å –Ω–µ–ª—å–∑—è','‚õî'); return; }
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–≥?')) return;
      try{ await API.del(`/api/partners/onboarding/steps/${stepId}`); await this.openFlow(this.onb.activeFlow.id); }
      catch(e){ this.toast(e.message,'‚õî'); }
    },

    /* === LEFT option editor & stats === */
    async editOption(o, stepId){
      this.onb.statsOpen = false;
      this.optDrawer.open = true;

      const optId = (o.id ?? o.option_id ?? o.pk ?? o.option?.id ?? o.option?.option_id ?? null);

      this.onb.optEditor = {
        step_id: stepId,
        id: optId,
        key: o.key ?? o.option?.key ?? o.slug ?? '',
        title: o.title ?? o.option?.title ?? '',
        body_md: o.body_md ?? o.option?.body_md ?? '',
        media_url: o.media_url ?? o.option?.media_url ?? ''
      };

      if (!this.onb.optEditor.id && this.onb.optEditor.key) {
        const rid = await this.ensureOptionId(stepId, this.onb.optEditor.key);
        if (rid) this.onb.optEditor.id = rid;
      }
    },
    openFlowStats(flowId){
      if(!flowId) return;
      this.onb.statsOpen = true;
      this.onb.optEditor = null;
      this.optDrawer.open = true;
      this.loadFlowStats(flowId);
      this.loadFlowSessions(flowId, 1);
    },
    closeOptDrawer(){
      this.optDrawer.open = false;
      this.onb.optEditor = null;
      this.onb.statsOpen = false;
    },
    async loadFlowStats(flowId){
      try{
        const days = this.onb.statsDays || 30;
        this.onb.stats = await API.get(`/api/partners/onboarding/flows/${flowId}/stats?days=${days}`);
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    async loadFlowSessions(flowId, page=1){
      try{
        const params = new URLSearchParams();
        params.set('days', String(this.onb.statsDays||30));
        params.set('page', String(page||1));
        params.set('per_page', '20');
        if(this.onb.sessionsQuery?.trim()) params.set('q', this.onb.sessionsQuery.trim());
        if(this.onb.onlyActive && !this.onb.onlyCompleted) params.set('only_active','1');
        if(this.onb.onlyCompleted && !this.onb.onlyActive) params.set('only_completed','1');
        this.onb.sessions = await API.get(`/api/partners/onboarding/flows/${flowId}/sessions?`+params.toString());
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    debouncedLoadSessions(){ clearTimeout(this._debSess); this._debSess = setTimeout(()=>{ if(this.onb.activeFlow?.id) this.loadFlowSessions(this.onb.activeFlow.id, 1); }, 350); },

    async ensureOptionId(stepId, key){
      const norm = v => String(v ?? '').trim().toLowerCase();
      const isEq  = (a,b) => String(a) === String(b);

      const fromLocal = () => {
        const step = this.onb.steps.find(s => isEq(s.id, stepId));
        const hit  = step?.options?.find(o => norm(o.key ?? o.slug) === norm(key));
        return hit?.id ?? hit?.option_id ?? hit?.pk ?? hit?.uuid ?? null;
      };

      // 1) –ª–æ–∫–∞–ª—å–Ω–æ
      let id = fromLocal();
      if(id) return id;

      // 2) –±—ã—Å—Ç—Ä—ã–π —Ä–µ—Ñ—Ä–µ—à
      try{
        const j = await API.get(`/api/partners/onboarding/flows/${this.onb.activeFlow.id}/steps?ts=${Date.now()}`);
        const {steps} = normStepsPayload(j); this.onb.steps = steps;
        id = fromLocal(); if(id) return id;
      }catch(_){}

      // 3) —Ç–æ—á–µ—á–Ω–æ
      const tryGet = async (u) => { try{ return await API.get(u); }catch(_){ return null; } };
      const cand = [
        `/api/partners/onboarding/steps/${stepId}?ts=${Date.now()}`,
        `/api/partners/onboarding/steps/${stepId}/options?ts=${Date.now()}`
      ];

      for(const u of cand){
        const j = await tryGet(u);
        const rawOpts = j?.options || j?.choices || j?.variants || (Array.isArray(j)?j:[]);
        const hit = (rawOpts || []).find(o => norm(o.key ?? o.option?.key ?? o.slug) === norm(key));
        const got = hit?.id ?? hit?.option_id ?? hit?.pk ?? hit?.uuid ?? hit?.option?.id ?? hit?.option?.option_id ?? hit?.option?.pk ?? hit?.option?.uuid ?? null;
        if(got){
          const step = this.onb.steps.find(s => isEq(s.id, stepId));
          if(step){
            const loc = step.options?.find(o => norm(o.key ?? o.slug) === norm(key));
            if(loc) loc.id = got;
          }
          return got;
        }
      }
      return null;
    },
    async saveOption(){
      const e = this.onb.optEditor;
      if(!e){ this.toast('–†–µ–¥–∞–∫—Ç–æ—Ä –æ–ø—Ü–∏–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω','‚õî'); return; }
      if(!e.id && e.step_id && e.key){ e.id = await this.ensureOptionId(e.step_id, e.key); }
      if(!e.id){ this.toast('–ù–µ —Å–º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å ID –æ–ø—Ü–∏–∏. –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª—å.','‚õî'); return; }

      const payload = { title: e.title, body_md: e.body_md || null, media_url: e.media_url || null };
      const flowId = this.onb?.activeFlow?.id;
      const companyId = this.companyId;
      const updUrls = [
        `/api/partners/onboarding/options/${e.id}`,
        `/api/partners/onboarding/steps/${e.step_id}/options/${e.id}`,
        flowId    ? `/api/partners/onboarding/flows/${flowId}/steps/${e.step_id}/options/${e.id}` : null,
        companyId ? `/api/partners/company/${companyId}/onboarding/options/${e.id}` : null,
        companyId ? `/api/partners/company/${companyId}/onboarding/steps/${e.step_id}/options/${e.id}` : null,
      ].filter(Boolean);

      this.saving = true;
      try{
        let ok=false;
        for(const u of updUrls){ try{ await API.put(u, payload); ok=true; break; }catch{} }
        if(!ok){ for(const u of updUrls){ try{ await API.post(u, payload); ok=true; break; }catch{} } }
        if(!ok) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–∏ –ø–æ id');

        this.toast('–û–ø—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞','üíæ'); await this.openFlow(flowId); this.closeOptDrawer();
      }catch(err){ this.toast(err?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø—Ü–∏—é','‚õî'); }
      finally{ this.saving = false; }
    },
    async addOption(stepId){
      const o=this.onb.tmpOpt; if(!o.key || !o.title){ this.toast('–£–∫–∞–∂–∏—Ç–µ key –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','‚ö†Ô∏è'); return; }
      try{
        const res = await API.post(`/api/partners/onboarding/steps/${stepId}/options`, { key:o.key, title:o.title, body_md:o.body_md||null });
        this.onb.tmpOpt={key:'', title:'', body_md:''};
        await this.openFlow(this.onb.activeFlow.id);
        const createdId = res?.id || res?.option_id;
        const step = this.onb.steps.find(x=>x.id===stepId);
        const opt = step?.options?.find(x=>x.id===createdId) || step?.options?.find(x=>x.key===o.key);
        if(opt){ this.editOption(opt, stepId); }
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    async deleteOption(o){
      if(!o?.id){ this.toast('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ–ø—Ü–∏—è','‚ö†Ô∏è'); return; }
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø—Ü–∏—é?')) return;
      try{
        await API.del(`/api/partners/onboarding/options/${o.id}`);
        if(this.onb.optEditor && this.onb.optEditor.id===o.id){ this.closeOptDrawer(); }
        await this.openFlow(this.onb.activeFlow.id);
      }catch(e){ this.toast(e.message,'‚õî'); }
    },

    /* ===== dashboard ===== */
    async init(){ if(!this.companyId) return; await this.loadDashboard(); this.loadFlows().catch(()=>{}); this.loadPeople().catch(()=>{}); this.loadStore().catch(()=>{}); },
    async loadDashboard(){
      try{
        const d=await API.get(`/api/partners/company/${this.companyId}/dashboard`);
        const dd=d.dashboard || d.data || d;
        this.company=dd.company || dd.company_info || null;
        this.kpi=dd.kpi || dd.stats || {};
        this.feed=dd.feed || dd.company_feed || dd.posts || [];
        this.tasks=dd.tasks || dd.company_tasks || [];
        this.leaderboard=dd.leaderboard || dd.top || [];
        const perms=dd.permissions || dd.perms || {};
        this.canPost=!!(perms.can_create_feed ?? perms.can_manage ?? false);
        this.canCreateTasks=!!(perms.can_create_tasks ?? perms.can_manage ?? false);
      }catch(e){ this.toast(e.message,'‚õî'); }
    },

    /* ===== new post helpers ===== */
    async createPost(){
      if(!this.newPost.trim() && !this.newPostFile) return;
      try{
        if(this.newPostFile){
          const fd=new FormData(); fd.append('text', this.newPost||''); fd.append('pinned', this.newPinned ? '1':'0'); fd.append('photo', this.newPostFile);
          await API.post(`/api/partners/company/${this.companyId}/feed`, fd);
        }else{
          await API.post(`/api/partners/company/${this.companyId}/feed`, {text:this.newPost, pinned:this.newPinned});
        }
        this.newPost=''; this.newPinned=false; this.clearNewPostFile(); await this.loadDashboard();
      }catch(e){ this.toast(e.message,'‚õî'); }
    },
    onNewPostFile(ev){ const f=ev.target.files?.[0]; if(!f){ this.clearNewPostFile(); return; } if(this.newPostPreview) URL.revokeObjectURL(this.newPostPreview); this.newPostFile=f; this.newPostPreview=URL.createObjectURL(f); },
    clearNewPostFile(){ this.newPostFile=null; if(this.newPostPreview){ URL.revokeObjectURL(this.newPostPreview); this.newPostPreview=''; } this.$refs?.newPostImageInput && (this.$refs.newPostImageInput.value=''); }
  }
}
</script>

<script>
  window.SJ_COMPANY_ID = {{ company_id|default('null') }};
  window.SJ_COMPANY_SLUG = {{ company_slug|tojson|safe }};
</script>
{% endblock %}
