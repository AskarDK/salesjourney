<!DOCTYPE html>
<html lang="ru" x-data>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{{ title or "Sales Journey" }}</title>
  <meta name="theme-color" content="#0b1220" id="themeColorMeta">
   <script>
  // –ó–∞–¥–µ—Ä–∂–∏–≤–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ Alpine, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  window.deferLoadingAlpine = (start) => { window._startAlpine = start }
</script>
  <script>
    (function(){
      try{
        const KEY='sj_theme';
        const saved = localStorage.getItem(KEY);
        // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±—Ä–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫, —á—Ç–æ–±—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞
        const mode = saved || 'dark';
        const root = document.documentElement;
        root.classList.toggle('dark', mode==='dark');
        root.dataset.theme = mode;
        const meta = document.getElementById('themeColorMeta');
        if (meta) meta.setAttribute('content', mode==='dark' ? '#0b1220' : '#ffffff');
        window.__setTheme = function(m){
          const dark = m==='dark';
          root.classList.toggle('dark', dark);
          root.dataset.theme = m;
          localStorage.setItem(KEY, m);
          if (meta) meta.setAttribute('content', dark ? '#0b1220' : '#ffffff');
          window.dispatchEvent(new CustomEvent('sj:theme', { detail:{ mode:m } }));
        };
      }catch(e){}
    })();
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { brand: '#4F46E5' },
          boxShadow: {
            soft: '0 10px 30px -12px rgba(0,0,0,.20)',
            'inner-soft': 'inset 0 1px 0 rgba(255,255,255,.04), inset 0 -1px 0 rgba(0,0,0,.08)'
          },
          transitionTimingFunction: {
            'swift': 'cubic-bezier(.2,.8,.2,1)'
          }
        }
      }
    };
  </script>

  <style>
    [x-cloak]{display:none!important}

    /* Skeleton shimmer */
    .skeleton{
      position:relative; overflow:hidden; background:linear-gradient(90deg, rgba(148,163,184,.15), rgba(148,163,184,.08), rgba(148,163,184,.15));
      background-size:200% 100%; animation:sk 1.4s linear infinite;
    }
    @keyframes sk { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* –ú–∏–∫—Ä–æ—ç—Ñ—Ñ–µ–∫—Ç—ã */
    .hover-lift{ transition:transform .25s var(--swift, cubic-bezier(.2,.8,.2,1)), box-shadow .25s var(--swift, cubic-bezier(.2,.8,.2,1)); }
    .hover-lift:hover{ transform:translateY(-2px); box-shadow:var(--shadow, 0 10px 20px -12px rgba(0,0,0,.25)); }

    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–¥ —à–∞–ø–∫–æ–π */
    .grad-anim { background: linear-gradient(90deg,#22d3ee,#6366f1,#22c55e,#f59e0b,#22d3ee); background-size: 300% 100%; animation: shift 12s ease infinite; }
    @keyframes shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ "–≤–≤–µ—Ä—Ö" */
    .float { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-6px) } }

    /* –£–º–µ–Ω—å—à–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è reduce-motion */
    @media (prefers-reduced-motion: reduce){
      * { animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; scroll-behavior: auto !important; }
    }

    /* === SPA –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ === */
    #spa-bar{position:fixed;left:0;top:0;height:3px;width:0;z-index:9999;transition:width .25s ease; background:linear-gradient(90deg,#6366f1,#22d3ee,#22c55e)}
    .spa-fade-enter{opacity:0;transform:translateY(4px)}
    .spa-fade-enter-active{transition:opacity .18s ease, transform .18s ease;opacity:1;transform:none}
  </style>

  <script defer src="{{ url_for('static', filename='admin.js') }}"></script>

  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="{{ url_for('static', filename='app.js') }}"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif}
    .glow { box-shadow: 0 0 30px rgba(59,130,246,.35), inset 0 0 15px rgba(99,102,241,.25); }
    .sparkle { position:relative; }
    .sparkle:after{ content:""; position:absolute; inset:-2px; border-radius:14px; background: radial-gradient(white,rgba(255,255,255,0)) center/150% 150% no-repeat; filter: blur(8px); opacity:.15; }
    .link-underline{ position:relative; }
    .link-underline:after{ content:""; position:absolute; left:0; right:0; bottom:-2px; height:2px; background: currentColor; opacity:.2; transition:opacity .2s; }
    .link-underline:hover:after{ opacity:.55; }
  </style>
</head>

<body class="min-h-screen bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <div id="spa-bar" aria-hidden="true"></div>

  <header x-data="headerUI()" class="sticky top-0 z-40 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 transition-shadow">
    <div class="h-0-5 grad-anim"></div>
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">

      <div class="flex items-center gap-3">
        <button class="md:hidden p-2 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800"
                @click="toggleMobile()" :aria-expanded="mobileOpen.toString()" aria-controls="mobileNav" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
            <svg x-show="!mobileOpen" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
            <svg x-show="mobileOpen" x-cloak class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <a href="/" class="text-xl font-extrabold tracking-tight hover:opacity-90 transition">
          <span class="bg-gradient-to-r from-indigo-400 via-cyan-400 to-emerald-400 text-transparent bg-clip-text">
            Sales Journey
          </span>
        </a>
      </div>

      {% set is_user = current_user is not none %}
      {% set is_partner = current_partner is not none %}
      {% set is_admin = current_admin is not none %}

      <nav class="hidden md:flex items-center gap-3">
        {% if is_user %}
          <a href="{{ url_for('page_training_list') }}" class="px-3 py-2 rounded-xl border border-transparent hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift link-underline">–ö—É—Ä—Å—ã</a>
          <a href="/contests" class="px-3 py-2 rounded-xl border border-transparent hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift link-underline">–ö–æ–Ω–∫—É—Ä—Å—ã</a>
          <a href="/store" class="px-3 py-2 rounded-xl border border-transparent hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift link-underline">–ú–∞–≥–∞–∑–∏–Ω</a>
          {% if current_user.company and is_manager(current_user.company.id) %}
            <a href="/company/requests" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift">–ó–∞—è–≤–∫–∏</a>
            <a href="/partner/reports" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
            <a href="/training/create" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold hover-lift">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
          {% endif %}
        {% endif %}

        {% if is_partner %}
          <a href="/partner/company" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</a>
          <a href="/partner/training/create" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold hover-lift">–ö—É—Ä—Å –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</a>
        {% endif %}

        {% if is_admin %}
          <a href="/partner/requests" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift">–ó–∞—è–≤–∫–∏</a>
          <a href="/partner/reports" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 hover-lift">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
          <a href="{{ url_for('page_admin_dashboard') }}" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold hover-lift">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
        {% endif %}
      </nav>

      <div class="flex items-center gap-3" data-nav-auth data-auth-slot>
        <button class="rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-1.5 hover:bg-slate-100 dark:hover:bg-slate-800"
                @click="toggleTheme()" aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          <span class="dark:hidden">üåô –¢—ë–º–Ω–∞—è</span>
          <span class="hidden dark:inline">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</span>
        </button>

        {% if is_user %}
          <div class="relative" x-data="notifMenu()" @keydown.escape="open=false">
            <button @click="toggle()"
                    class="relative rounded-xl border border-slate-300 dark:border-slate-700 px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800"
                    aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
              üîî
              <span x-show="unreadCount"
                    class="absolute -top-1 -right-1 text-[10px] px-1 rounded bg-rose-600 text-white animate-pulse"
                    x-text="unreadCount"></span>
            </button>

            <div x-show="open" x-transition
                 class="absolute right-0 mt-2 w-80 max-w-[90vw] z-50
                        rounded-xl border border-slate-200 dark:border-slate-700
                        bg-white dark:bg-slate-900 p-2 shadow-soft"
                 @click.outside="open=false" x-cloak>

              <div class="text-sm text-slate-500 dark:text-slate-400 px-2 py-1">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>

              <div class="flex flex-wrap items-center gap-1.5 px-2 py-1">
                <button class="px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 text-xs whitespace-nowrap hover:bg-slate-100 dark:hover:bg-slate-800"
                        :class="{'bg-slate-100 dark:bg-slate-800': tab==='all'}" @click="tab='all'">–í—Å–µ</button>
                <button class="px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 text-xs whitespace-nowrap hover:bg-slate-100 dark:hover:bg-slate-800"
                        :class="{'bg-slate-100 dark:bg-slate-800': tab==='system'}" @click="tab='system'">–°–∏—Å—Ç–µ–º–Ω—ã–µ</button>
                <button class="px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 text-xs whitespace-nowrap hover:bg-slate-100 dark:hover:bg-slate-800"
                        :class="{'bg-slate-100 dark:bg-slate-800': tab==='review'}" @click="tab='review'">–ü—Ä–æ–≤–µ—Ä–∫–∏</button>
                <button class="px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 text-xs whitespace-nowrap hover:bg-slate-100 dark:hover:bg-slate-800"
                        :class="{'bg-slate-100 dark:bg-slate-800': tab==='achievement'}" @click="tab='achievement'">–ê—á–∏–≤–∫–∏</button>
                <button class="px-2 py-1 rounded-lg border border-slate-200 dark:border-slate-700 text-xs whitespace-nowrap hover:bg-slate-100 dark:hover:bg-slate-800"
                        :class="{'bg-slate-100 dark:bg-slate-800': tab==='purchase'}" @click="tab='purchase'">–ü–æ–∫—É–ø–∫–∏</button>
              </div>

              <template x-if="loading">
                <div class="p-2 space-y-2">
                  <div class="skeleton h-10 rounded-lg"></div>
                  <div class="skeleton h-10 rounded-lg"></div>
                </div>
              </template>

              <div class="px-2 py-3 text-sm text-slate-500 dark:text-slate-400"
                   x-show="!loading && filtered.length===0">
                –ü–æ–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç.
              </div>

              <div class="overflow-y-auto max-h-[60vh] pr-1">
                <template x-for="n in filtered" :key="n.id">
                  <div class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <div class="text-sm font-semibold" x-text="n.title"></div>
                    <div class="text-xs text-slate-500 dark:text-slate-400" x-text="n.body"></div>
                  </div>
                </template>
              </div>

              <div class="flex justify-end" x-show="!loading && filtered.length">
                <button class="text-xs text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white px-2 py-1"
                        @click="markAllRead()">–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å—ë –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º</button>
              </div>
            </div>
          </div>

          <div class="relative" x-data="{open:false}" @keydown.escape="open=false">
            <button class="flex items-center gap-3 group" @click="open=!open" :aria-expanded="open.toString()" aria-haspopup="menu">
              <img src="{{ url_for('avatar_svg', user_id=current_user.id) }}?part=head&t={{ (current_user.updated_at.timestamp()|int) if current_user.updated_at else 0 }}"
                   alt="avatar" class="w-9 h-9 rounded-full ring-2 ring-slate-200 dark:ring-slate-700 transition group-hover:ring-indigo-400">
              <span class="font-semibold">{{ current_user.display_name }}</span>
            </button>
            <div x-show="open" x-transition
                 class="absolute right-0 mt-2 w-52 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-2 shadow-soft"
                 @click.outside="open=false" x-cloak role="menu">
              <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="/profile" role="menuitem">–ü—Ä–æ—Ñ–∏–ª—å</a>
              {% if current_user.company and is_manager(current_user.company.id) %}
              <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="/company/requests" role="menuitem">–ó–∞—è–≤–∫–∏</a>
              <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="/partner/reports" role="menuitem">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
              {% endif %}
              <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
                      onclick="fetch('/api/auth/logout',{method:'POST'}).then(()=>window.dispatchEvent(new CustomEvent('spa:goto',{detail:{url:'/login'}})))" role="menuitem">
                –í—ã–π—Ç–∏
              </button>
            </div>
          </div>

        {% elif is_partner %}
          <div class="relative" x-data="{open:false}" @keydown.escape="open=false">
            <button class="flex items-center gap-3 group" @click="open=!open" :aria-expanded="open.toString()" aria-haspopup="menu">
              <div class="w-9 h-9 grid place-items-center rounded-full ring-2 ring-slate-200 dark:ring-slate-700 bg-indigo-500/10">ü§ù</div>
              <span class="font-semibold">{{ current_partner.email }}</span>
            </button>
            <div x-show="open" x-transition
                 class="absolute right-0 mt-2 w-56 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 p-2 shadow-soft"
                 @click.outside="open=false" x-cloak role="menu">
              <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="/partner/company" role="menuitem">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</a>
              <a class="block px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800" href="/partner/training/create" role="menuitem">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
              <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
                onclick="fetch('/api/partners/auth/logout',{method:'POST'}).then(()=>window.dispatchEvent(new CustomEvent('spa:goto',{detail:{url:'/partner/login'}})))" role="menuitem">
                –í—ã–π—Ç–∏ (–ø–∞—Ä—Ç–Ω—ë—Ä)
              </button>
            </div>
          </div>

        {% elif is_admin %}
          <form onsubmit="event.preventDefault(); fetch('/api/admin/logout',{method:'POST'}).then(()=>window.dispatchEvent(new CustomEvent('spa:goto',{detail:{url:'/admin/login'}})))">
            <button class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">–í—ã–π—Ç–∏ (–∞–¥–º–∏–Ω)</button>
          </form>

        {% else %}
          <a href="/login" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 hidden sm:inline-block">–í–æ–π—Ç–∏</a>
          <a href="/register" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold hidden sm:inline-block">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
          <a href="{{ url_for('page_admin_login') }}" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 hidden md:inline-block">–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞</a>
          <a href="/partner/login" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 hidden md:inline-block">–í—Ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</a>
        {% endif %}
      </div>
    </div>

    <div x-cloak x-show="mobileOpen" x-transition.opacity class="fixed inset-0 z-40 bg-black/40 backdrop-blur-sm md:hidden" @click="closeMobile()" aria-hidden="true"></div>
    <!-- –û–≤–µ—Ä–ª–µ–π –æ—Å—Ç–∞—ë—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å –≤—ã—à–µ -->

<aside id="mobileNav" x-cloak x-show="mobileOpen"
       x-transition:enter="transition transform ease-out duration-200"
       x-transition:enter-start="-translate-x-full"
       x-transition:enter-end="translate-x-0"
       x-transition:leave="transition transform ease-in duration-150"
       x-transition:leave-start="translate-x-0"
       x-transition:leave-end="-translate-x-full"
       class="fixed inset-0 z-50 w-screen max-w-none bg-white dark:bg-slate-900 shadow-soft md:hidden overscroll-contain">
  <div class="h-full flex flex-col">
    <div class="p-4 flex items-center justify-between border-b border-slate-200 dark:border-slate-800">
      <span class="text-lg font-extrabold">–ù–∞–≤–∏–≥–∞—Ü–∏—è</span>
      <button class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
              @click="closeMobile()" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- –∫–æ–Ω—Ç–µ–Ω—Ç —Ç—è–Ω–µ—Ç—Å—è –∏ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è, —à–∏—Ä–∏–Ω–∞ 100% -->
    <nav class="p-3 flex-1 overflow-y-auto flex flex-col gap-2 text-sm">
      {% if is_user %}
        <a href="{{ url_for('page_training_list') }}" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–ö—É—Ä—Å—ã</a>
        <a href="/contests" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–ö–æ–Ω–∫—É—Ä—Å—ã</a>
        <a href="/store" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–ú–∞–≥–∞–∑–∏–Ω</a>
        {% if current_user.company and is_manager(current_user.company.id) %}
          <a href="/company/requests" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–ó–∞—è–≤–∫–∏</a>
          <a href="/partner/reports" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
          <a href="/training/create" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-semibold">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
        {% endif %}
        <hr class="my-2 border-slate-200 dark:border-slate-800">
        <a href="/profile" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <button class="text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
                onclick="fetch('/api/auth/logout',{method:'POST'}).then(()=>window.dispatchEvent(new CustomEvent('spa:goto',{detail:{url:'/login'}})))">
          –í—ã–π—Ç–∏
        </button>
      {% elif is_partner %}
        <a href="/partner/company" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</a>
        <a href="/partner/training/create" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-semibold">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
        <hr class="my-2 border-slate-200 dark:border-slate-800">
        <button class="text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
                onclick="fetch('/api/partners/auth/logout',{method:'POST'}).then(()=>window.dispatchEvent(new CustomEvent('spa:goto',{detail:{url:'/partner/login'}})))">
          –í—ã–π—Ç–∏ (–ø–∞—Ä—Ç–Ω—ë—Ä)
        </button>
      {% elif is_admin %}
        <a href="/partner/requests" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–ó–∞—è–≤–∫–∏</a>
        <a href="/partner/reports" class="px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
        <a href="{{ url_for('page_admin_dashboard') }}" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-semibold">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
        <hr class="my-2 border-slate-200 dark:border-slate-800">
        <button class="text-left px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
                onclick="fetch('/api/admin/logout',{method:'POST'}).then(()=>window.dispatchEvent(new CustomEvent('spa:goto',{detail:{url:'/admin/login'}})))">
          –í—ã–π—Ç–∏ (–∞–¥–º–∏–Ω)
        </button>
      {% else %}
        <a href="/login" class="px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700">–í–æ–π—Ç–∏</a>
        <a href="/register" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        <hr class="my-2 border-slate-200 dark:border-slate-800">
        <a href="{{ url_for('page_admin_login') }}" class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞</a>
        <a href="/partner/login" class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">–í—Ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</a>
      {% endif %}
    </nav>

    <div class="p-3 border-t border-slate-200 dark:border-slate-800">
      <button class="w-full rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2 hover:bg-slate-100 dark:hover:bg-slate-800"
              @click="toggleTheme()">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
    </div>
  </div>
</aside>

  </header>

  <main id="pjax-root" data-pjax-root class="min-h-[80vh]">
    {% block content %}{% endblock %}
  </main>

  <footer class="border-t border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-8 grid sm:grid-cols-3 gap-6 text-sm text-slate-500 dark:text-slate-400">
      <div>¬© 2025 Sales Journey</div>
      <div class="sm:text-center">–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ—Ç —Ü–∏—Ñ—Ä—ã</div>
      <div class="sm:text-right">hello@salesjourney.app</div>
    </div>
  </footer>

  <div class="fixed top-3 right-3 z-[100] space-y-3 w-[92vw] max-w-80" aria-live="polite">
    <template x-for="t in $store.toasts?.items || []" :key="t.id">
      <div x-show="t.show" x-transition.opacity.duration.200ms
           class="rounded-xl border border-slate-200 dark:border-slate-700 shadow-xl bg-white dark:bg-slate-800 p-4 flex gap-3">
        <div class="text-2xl" x-text="t.emoji || '‚ú®'"></div>
        <div class="flex-1">
          <div class="font-semibold text-slate-800 dark:text-slate-100" x-text="t.title"></div>
          <div class="text-sm text-slate-600 dark:text-slate-300" x-text="t.text"></div>
        </div>
        <button class="text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200" @click="$store.toasts.dismiss(t.id)">‚úï</button>
      </div>
    </template>
  </div>

  <canvas id="confetti" class="pointer-events-none fixed inset-0 z-[90]"></canvas>

  <button x-data="scrollTopBtn()" x-show="visible" x-transition.opacity
          @click="go()" aria-label="–ù–∞–≤–µ—Ä—Ö"
          class="fixed bottom-[max(1rem,env(safe-area-inset-bottom))] right-[max(1rem,env(safe-area-inset-right))] z-40
                 rounded-full p-3 bg-indigo-600 hover:bg-indigo-500 text-white shadow-soft float">
    ‚Üë
  </button>

  {% block scripts %}{% endblock %}

  <script>
    // Header logic: shadow on scroll, mobile drawer, theme toggle
    function headerUI(){
      return {
        mobileOpen:false,
        toggleMobile(){ this.mobileOpen = !this.mobileOpen },
        closeMobile(){ this.mobileOpen = false },
        toggleTheme(){ window.__setTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark') }
      }
    }

    // Sticky header shadow on scroll
    (function(){
      const hdr = document.querySelector('header.sticky');
      if(!hdr) return;
      const onScroll = () => {
        const sc = window.scrollY || document.documentElement.scrollTop;
        hdr.style.boxShadow = sc > 4 ? '0 8px 24px -18px rgba(0,0,0,.25)' : 'none';
      };
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    })();

    // "–ù–∞–≤–µ—Ä—Ö" btn
    function scrollTopBtn(){
      return {
        visible:false,
        init(){
          const onScroll = () => { this.visible = (window.scrollY || document.documentElement.scrollTop) > 400; };
          window.addEventListener('scroll', onScroll, { passive: true });
          onScroll();
        },
        go(){ window.scrollTo({top:0, behavior:'smooth'}); }
      }
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function notifMenu(){ return {
      open:false, items:[], unreadCount:0, loading:false, tab:'all',
      get filtered(){
        if (this.tab==='all') return this.items;
        const key = this.tab;
        return this.items.filter(n => (n.type||n.category||'').toLowerCase() === key);
      },
      async toggle(){ this.open=!this.open; if(this.open){ await this.load(); } },
      async load(){
        this.loading = true;
        try{
          const r = await fetch('/api/notifications'); if(!r.ok) return;
          const d = await r.json();
          this.items = d.notifications || [];
          this.unreadCount = this.items.filter(x=>!x.is_read).length;
        } finally {
          this.loading = false;
        }
      },
      async markAllRead(){ await fetch('/api/notifications/read',{method:'POST'}); await this.load(); }
    }}

    /* ======================= SPA (PJAX) –ù–ê–í–ò–ì–ê–¶–ò–Ø (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ======================== */
    (()=>{
      const PJAX_SELECTOR='[data-pjax-root]';
      const AUTH_SLOT_SELECTOR='[data-auth-slot]';
      const bar=document.getElementById('spa-bar');

      function startBar(){ if(bar){ bar.style.width='20%'; requestAnimationFrame(()=>bar.style.width='60%'); } }
      function finishBar(){ if(bar){ bar.style.width='100%'; setTimeout(()=>{ bar.style.width='0'; },180);} }

      function sameOrigin(url){
        try{ const u=new URL(url, location.href); return u.origin===location.origin; }catch(_){return false;}
      }

      function extract(html){
        const doc=new DOMParser().parseFromString(html,'text/html');
        const next=doc.querySelector(PJAX_SELECTOR);
        const title=doc.querySelector('title');
        return { next, titleText: title ? title.textContent : document.title, doc };
      }

      function executeScripts(el){
        const scripts=el.querySelectorAll('script');
        scripts.forEach(s=>{
          const n=document.createElement('script');
          if(s.src){ n.src=s.src; n.defer=s.defer; n.async=s.async; }
          else{ n.textContent=s.textContent; }
          for(const a of s.attributes) n.setAttribute(a.name,a.value);
          s.replaceWith(n);
        });
      }

      async function pjaxNavigate(url, push=true){
        try{
          startBar();
          const res=await fetch(url,{ headers:{ 'X-Requested-With':'SPAFetch' }});
          if(res.redirected) return pjaxNavigate(res.url, push);
          const text=await res.text();
          const { next, titleText }=extract(text);
          const root=document.querySelector(PJAX_SELECTOR);
          if(!next || !root){ location.href=url; return; }

          next.classList.add('spa-fade-enter');
          root.replaceWith(next);
          requestAnimationFrame(()=>next.classList.add('spa-fade-enter-active'));
          setTimeout(()=>next.classList.remove('spa-fade-enter','spa-fade-enter-active'), 200);

          executeScripts(next);
          try{ if(window.Alpine) Alpine.initTree(next); }catch(_){}
          document.title=titleText;
          if(push) history.pushState({url},'',url);

          window.dispatchEvent(new CustomEvent('spa:navigated',{ detail:{ url } }));
        }catch(e){
          console.error('SPA nav error', e);
          location.href=url;
        }finally{ finishBar(); }
      }

      window.addEventListener('spa:goto',(e)=>{
        const url=e.detail?.url||'/';
        pjaxNavigate(url,true);
      });

      document.addEventListener('click', (e)=>{
        const a=e.target.closest('a');
        if(!a) return;
        if(a.hasAttribute('download') || a.target==='_blank' || a.getAttribute('rel')==='external' || a.dataset.noSpa!==undefined) return;
        const href=a.getAttribute('href');
        if(!href || href.startsWith('#')) return;
        if(!sameOrigin(href)) return;

        e.preventDefault();
        const url=new URL(href, location.href).href;
        pjaxNavigate(url, true);
      }, { capture:true });

      document.addEventListener('submit', async (e)=>{
        const form=e.target;
        if(!(form instanceof HTMLFormElement)) return;
        if(!form.closest(PJAX_SELECTOR)) return;
        if(!form.hasAttribute('data-ajax')) return;

        e.preventDefault();
        startBar();

        const url=form.action || location.href;
        const method=(form.method || 'POST').toUpperCase();
        const enctype=form.enctype || 'application/x-www-form-urlencoded';
        let body, headers={'X-Requested-With':'SPAFetch'};

        if(enctype.includes('multipart/form-data')){
          body=new FormData(form);
        }else{
          body=new URLSearchParams(new FormData(form));
          headers['Content-Type']='application/x-www-form-urlencoded;charset=UTF-8';
        }

        try{
          const res=await fetch(url,{ method, body, headers, redirect:'follow' });
          const ctype=res.headers.get('Content-Type')||'';
          if(ctype.includes('application/json')){
            const j=await res.json();
            if(j.user && window.Alpine?.store('auth')) Alpine.store('auth').setUser(j.user);
            if(j.redirect){ await pjaxNavigate(j.redirect,true); return; }
            return;
          }
          const html=await res.text();
          const { next, titleText }=extract(html);
          const root=document.querySelector(PJAX_SELECTOR);
          if(next && root){
            next.classList.add('spa-fade-enter');
            root.replaceWith(next);
            requestAnimationFrame(()=>next.classList.add('spa-fade-enter-active'));
            setTimeout(()=>next.classList.remove('spa-fade-enter','spa-fade-enter-active'), 200);
            executeScripts(next);
            try{ if(window.Alpine) Alpine.initTree(next); }catch(_){}
            document.title=titleText;
            history.pushState({url},'',url);
            window.dispatchEvent(new CustomEvent('spa:navigated',{ detail:{ url } }));
          }else{
            location.href=url;
          }
        }catch(err){
          console.error('SPA form error', err);
          location.href=url;
        }finally{ finishBar(); }
      });

      window.addEventListener('popstate',(e)=>{
        const url=(e.state && e.state.url) ? e.state.url : location.href;
        pjaxNavigate(url, false);
      });

    })();
  </script>
</body>
</html>