{% extends "base.html" %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-10">
  <div class="grid md:grid-cols-[300px,1fr] gap-8">

    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-6">
      <div class="flex flex-col items-center">
        <div class="relative">
          <img src="/avatar_svg/{{ user.id }}" alt="avatar"
               class="w-44 h-44 rounded-2xl ring-1 ring-white/10 transition-all duration-300">
        </div>

        <div class="mt-4 text-center">
          <div class="text-xl font-bold">{{ user.display_name }}</div>
          <div class="text-sm text-slate-400 mt-1">–£—Ä–æ–≤–µ–Ω—å {{ user.level }}</div>

          <div class="w-64 h-2 bg-white/10 rounded-full mt-3 overflow-hidden">
            {% set pct = (user.xp / user_next_xp * 100) | round(1) %}
            <div class="h-full bg-gradient-to-r from-indigo-400 via-cyan-300 to-emerald-300"
                 style="width: {{ pct }}%"></div>
          </div>
          <div class="text-xs text-slate-400 mt-1">
            XP: <span class="font-semibold">{{ user.xp }}</span> / {{ user_next_xp }}
          </div>
        </div>
      </div>

      <div class="mt-6 grid grid-cols-3 gap-3 text-center">
        <div class="rounded-xl bg-black/30 border border-white/10 p-3">
          <div class="text-2xl">ü™ô</div>
          <div class="text-lg font-bold">{{ user.coins }}</div>
          <div class="text-[11px] text-slate-400">coins</div>
        </div>
        <a href="/achievements" class="rounded-2xl bg-black/30 border border-white/10 p-3 hover:bg-white/5">
          <div class="text-2xl">üèÜ</div>
          <div class="text-lg font-bold">ACH</div>
          <div class="text-[11px] text-slate-400">üëÅÔ∏è</div>
        </a>
        <a href="/contests" class="rounded-2xl bg-black/30 border border-white/10 p-3 hover:bg-white/5">
          <div class="text-2xl">üèÅ</div>
          <div class="text-lg font-bold">Tour.</div>
          <div class="text-[11px] text-slate-400">üëÅÔ∏è</div>
        </a>
      </div>

      <a class="mt-6 block w-full text-center px-4 py-3 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10"
         href="/achievements">
        –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏ (XP/–∫–æ–∏–Ω—ã/–∞—á–∏–≤–∫–∏)
      </a>

      <!-- –í–≤–æ–¥ –∫–æ–¥–∞ –∫–æ–º–ø–∞–Ω–∏–∏ -->
      <!-- –ö–æ–º–ø–∞–Ω–∏—è / –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ -->
<div class="mt-6 rounded-2xl border border-white/10 bg-black/30 p-4" x-data="companyJoin()" x-init="init()">
  <!-- –°–æ—Å—Ç–æ–∏—Ç –≤ –∫–æ–º–ø–∞–Ω–∏–∏ -->
  <template x-if="member">
    <div>
      <div class="text-sm font-semibold">–í—ã —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–æ–º–ø–∞–Ω–∏–∏</div>
      <div class="mt-1 text-slate-200 font-semibold" x-text="company_name"></div>
      <a href="/partner/company"
         class="mt-3 inline-block px-4 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10">
        –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏
      </a>
    </div>
  </template>

  <!-- –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ -->
  <template x-if="!member && pending">
    <div>
      <div class="text-sm font-semibold">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
      <div class="mt-1 text-slate-200">–ö–æ–º–ø–∞–Ω–∏—è: <span class="font-semibold" x-text="company_name"></span></div>
      <div class="text-xs text-slate-400 mt-1">–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è. –ù–æ–≤—É—é –∑–∞—è–≤–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–ª—å–∑—è.</div>
      <div class="mt-3 flex gap-2">
        <button @click="cancel"
                class="px-4 py-2 rounded-xl border border-white/10 hover:bg-white/5">
          –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
        </button>
      </div>
      <div class="text-xs text-slate-400 mt-2" x-text="status"></div>
    </div>
  </template>

  <!-- –ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –Ω–µ—Ç –∑–∞—è–≤–∫–∏ ‚Äî —Ñ–æ—Ä–º–∞ –ø–æ–¥–∞—á–∏ -->
  <template x-if="!member && !pending">
    <div>
      <div class="text-sm font-semibold">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∫–æ–¥—É</div>
      <div class="mt-2 flex gap-2">
        <input x-model="code" class="flex-1 rounded-xl bg-black/40 border border-white/10 px-3 py-2"
               placeholder="–ù–∞–ø—Ä. 9F3A2C1B">
        <button @click="submit"
                class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold"
                :disabled="!code.trim()">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
      </div>
      <div class="text-xs text-slate-400 mt-2" x-text="status"></div>
    </div>
  </template>
</div>

    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-6">
      <h2 class="text-2xl font-bold">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.display_name }}!</h2>
      <p class="text-slate-300 mt-2">
        –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–≤–æ–∏ –∫–≤–µ—Å—Ç—ã, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
        –ó–∞–≥–ª—è–Ω–∏ –≤ <a href="/training" class="text-indigo-400 hover:underline">–¢—Ä–µ–Ω–∏–Ω–≥</a>,
        <a href="/achievements" class="text-indigo-400 hover:underline">–∞—á–∏–≤–∫–∏</a> –∏–ª–∏
        –ø—Ä–æ–≤–µ—Ä—å <a href="/contests" class="text-indigo-400 hover:underline">–∫–æ–Ω–∫—É—Ä—Å—ã</a>.
      </p>

      <div class="mt-6 grid md:grid-cols-2 gap-4">
        <a href="/store" class="group rounded-2xl border border-white/10 p-5 bg-gradient-to-br from-white/0 to-white/[0.03] hover:to-white/[0.06]">
          <div class="text-3xl mb-2">üõí</div>
          <div class="font-semibold">–ú–∞–≥–∞–∑–∏–Ω</div>
          <div class="text-sm text-slate-400">–¢—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã –Ω–∞ —Å–∫–∏–Ω—ã –∏ –±–æ–Ω—É—Å—ã</div>
        </a>
        <a href="/partner/company" class="group rounded-2xl border border-white/10 p-5 bg-gradient-to-br from-white/0 to-white/[0.03] hover:to-white/[0.06]">
          <div class="text-3xl mb-2">üìä</div>
          <div class="font-semibold">–ö–æ–º–ø–∞–Ω–∏—è</div>
          <div class="text-sm text-slate-400">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è –∏ —Å–≤–æ–¥–∫–∏ –ø–æ –æ—Ç–¥–µ–ª—É</div>
        </a>
      </div>

      <div class="mt-6">
        <div class="text-sm uppercase tracking-wide text-slate-400 mb-2">–ü–æ—Å–ª–µ–¥–Ω–µ–µ</div>
        <div class="rounded-xl border border-white/10 bg-black/30 p-4">
          <div class="text-slate-400 text-sm">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è.</div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- –ú–æ–¥–∞–ª: –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div x-data="xpHistoryModal()" @open-xp-history.window="open()" x-cloak>
  <div x-show="openModal" x-transition.opacity class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm"></div>
  <div x-show="openModal" x-transition class="fixed z-50 inset-0 grid place-items-center p-4">
    <div class="w-full max-w-3xl rounded-2xl border border-white/10 bg-slate-900/95 p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏</h3>
        <button class="text-slate-400 hover:text-slate-200" @click="close()">‚úï</button>
      </div>
      <div class="mt-4 flex flex-wrap gap-2 text-sm">
        <button :class="tabBtn('all')" @click="filter='all'">–í—Å–µ</button>
        <button :class="tabBtn('achievement')" @click="filter='achievement'">–ê—á–∏–≤–∫–∏</button>
        <button :class="tabBtn('events')" @click="filter='events'">–°–æ–±—ã—Ç–∏—è</button>
      </div>
      <div class="mt-4 max-h-[65vh] overflow-auto space-y-3 pr-1">
        <template x-for="row in filtered" :key="row.key">
          <div class="flex items-start gap-3 rounded-xl border border-white/10 bg-black/30 p-3">
            <div class="text-2xl" x-text="row.emoji"></div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div class="font-semibold" x-text="row.title"></div>
                <div class="text-xs text-slate-400" x-text="row.when"></div>
              </div>
              <div class="text-sm text-slate-300" x-text="row.subtitle"></div>
              <div class="mt-1 text-xs text-slate-400" x-show="row.meta" x-text="row.meta"></div>
            </div>
            <div class="text-right">
              <div class="text-emerald-400 font-semibold" x-show="row.points">+<span x-text="row.points"></span> XP</div>
              <div class="text-amber-300 font-semibold" x-show="row.coins">+<span x-text="row.coins"></span> ü™ô</div>
            </div>
          </div>
        </template>

        <div class="text-sm text-slate-400 text-center py-6" x-show="!loading && filtered.length===0">
          –ü—É—Å—Ç–æ. –°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –∫–≤–µ—Å—Ç –∏–ª–∏ –ø–æ–ª—É—á–∏ –∞—á–∏–≤–∫—É!
        </div>
        <div class="text-sm text-slate-300" x-show="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function companyJoin(){
  return {
    code: '',
    status: '',
    member: false,        // —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –∫–æ–º–ø–∞–Ω–∏–∏
    pending: false,       // –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞
    company_name: '',     // –∏–º—è –∫–æ–º–ø–∞–Ω–∏–∏ (–¥–ª—è member/pending)

    async init(){
      try{
        const r = await fetch('/api/company/join/status', { credentials: 'same-origin' });
        // 404 ‚Äî –∑–Ω–∞—á–∏—Ç –Ω–∞ –±—ç–∫–µ –Ω–µ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞, –º–æ–ª—á–∞ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ—Ç
        if (r.status === 404) { this.member=false; this.pending=false; this.company_name=''; this.status=''; return; }
        if (!r.ok) return;
        const j = await r.json().catch(()=>({}));
        this.member = !!j.member;
        this.pending = !!j.pending;
        this.company_name = j.company_name || j.company?.name || '';
        this.status = j.message || '';
      }catch(_e){}
    },

    async submit(){
      if (this.member || this.pending) return; // –∑–∞–ø—Ä–µ—Ç –≤—Ç–æ—Ä–æ–π –∑–∞—è–≤–∫–∏
      try{
        const r = await fetch('/api/company/join', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({ code: this.code.trim() })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok){
          // —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞
          if (r.status === 409 || j.pending_exists){
            this.pending = true;
            this.company_name = j.company_name || j.company?.name || this.company_name;
            this.status = j.description || '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è.';
            Alpine.store('toasts').push({title:'–ó–∞—è–≤–∫–∞', text:this.status, emoji:'‚è≥'});
            return;
          }
          throw new Error(j.error || j.description || '–û—à–∏–±–∫–∞');
        }
        // —É—Å–ø–µ—Ö: –ª–∏–±–æ —Å—Ä–∞–∑—É —É—á–∞—Å—Ç–Ω–∏–∫, –ª–∏–±–æ –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
        if (j.already_member || j.member){
          this.member = true; this.pending = false;
          this.company_name = j.company_name || j.company?.name || this.company_name;
          this.status = '–í—ã —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏.';
          Alpine.store('toasts').push({title:'–ö–æ–º–ø–∞–Ω–∏—è', text:'–í—ã –≤ –∫–æ–º–ø–∞–Ω–∏–∏', emoji:'üè¢'});
        } else {
          this.pending = true;
          this.company_name = j.company_name || j.company?.name || this.company_name;
          this.status = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è.';
          Alpine.store('toasts').push({title:'–ó–∞—è–≤–∫–∞', text:'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ', emoji:'üì®'});
        }
      }catch(e){
        this.status = e.message;
        Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:e.message, emoji:'‚ö†Ô∏è'});
      }
    },

    async cancel(){
      if(!this.pending || this.member) return;
      try{
        const r = await fetch('/api/company/join/cancel', {
          method:'POST',
          credentials:'same-origin',
          headers:{'Content-Type':'application/json'}
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(j.error || j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É');

        this.pending = false;
        this.company_name = '';
        this.status = '–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.';
        Alpine.store('toasts').push({title:'–ó–∞—è–≤–∫–∞', text:'–û—Ç–º–µ–Ω–µ–Ω–∞', emoji:'üóëÔ∏è'});
      }catch(e){
        this.status = e.message;
        Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:e.message, emoji:'‚ö†Ô∏è'});
      }
    }
  }
}

function xpHistoryModal(){
  return {
    openModal: false,
    filter: 'all',
    loading: false,
    items: [],

    tabBtn(kind){
      return `px-3 py-1 rounded-lg border ${this.filter===kind ? 'bg-white/10 border-white/20' : 'border-white/10 hover:bg-white/5'}`;
    },

    get filtered(){
      if (this.filter === 'all') return this.items;
      return this.items.filter(x => x.type === this.filter); // 'achievement' | 'events'
    },

    open(){
      this.openModal = true;
      if (!this.items.length) this.load();
    },
    close(){ this.openModal = false; },

    async load(){
      this.loading = true;
      try{
        // ‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –±—ç–∫–∞
        const r = await fetch('/api/user/xp_history', { credentials: 'same-origin' });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) return;

        const events = Array.isArray(j.events) ? j.events : [];

        const emojiBySource = {
          achievement: 'üèÜ',
          task: '‚úÖ',
          training: 'üéì',
          sale: 'üíº',
          contest: 'üèÅ',
          bonus: '‚ú®',
        };

        this.items = events.map(ev => {
          const m = ev.meta || {};
          const src = ev.source || 'events';
          const type = src === 'achievement' ? 'achievement' : 'events';
          const when = ev.created_at ? new Date(ev.created_at).toLocaleString() : '';
          const emoji = emojiBySource[src] || 'üìå';

          let title = '–°–æ–±—ã—Ç–∏–µ';
          let subtitle = '';

          switch (src) {
            case 'achievement':
              title = ev.achievement_title || '–ê—á–∏–≤–∫–∞';
              subtitle = m.code ? `–ö–æ–¥: ${m.code}` : '';
              break;
            case 'task':
              title = '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞';
              subtitle = m.title || '';
              break;
            case 'training':
              title = '–¢—Ä–µ–Ω–∏–Ω–≥ –ø—Ä–æ–π–¥–µ–Ω';
              subtitle = m.title ? `${m.title}${m.score!=null ? ` (${m.score}%)` : ''}` : '';
              break;
            case 'contest':
              title = '–ö–æ–Ω–∫—É—Ä—Å';
              subtitle = m.title || '';
              break;
            case 'sale':
              title = '–ü—Ä–æ–¥–∞–∂–∞';
              subtitle = m.title || '';
              break;
            default:
              title = '–°–æ–±—ã—Ç–∏–µ';
              subtitle = m.title || '';
          }

          return {
            key: ev.id,
            emoji,
            title,
            when,
            subtitle,
            meta: '',
            points: ev.points,
            coins: ev.coins,
            type
          };
        });
      } finally {
        this.loading = false;
      }
    }
  }
}

</script>


{% endblock %}
