{% extends "base.html" %}
{% block content %}
<section class="max-w-3xl mx-auto px-4 py-10" x-data="contestPage({{ contest_id }})">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold" x-text="contest?.title || 'Конкурс'"></h1>
    <button class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold"
            @click="join()">Участвовать</button>
  </div>
  <p class="text-slate-300 mt-2" x-text="contest?.description"></p>
  <div class="text-xs text-slate-500 mt-2" x-show="contest">
    Приз: <span x-text="contest.prize || '—'"></span> · Мин. уровень: <span x-text="contest.min_rating || 1"></span>
  </div>

  <h2 class="text-lg font-semibold mt-8">Лидерборд</h2>
  <div class="mt-3 space-y-2">
    <template x-for="row in leaderboard" :key="row.user.id">
      <div class="flex items-center justify-between rounded-xl border border-white/10 bg-slate-900/60 p-3">
        <div class="flex items-center gap-3">
          <img :src="`/avatar_svg/${row.user.id}`" class="w-10 h-10 rounded-lg ring-1 ring-white/10">
          <div>
            <div class="font-semibold" x-text="row.user.display_name"></div>
            <div class="text-xs text-slate-400">lvl <span x-text="row.user.level"></span></div>
          </div>
        </div>
        <div class="text-lg font-bold" x-text="row.score"></div>
      </div>
    </template>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script>
function contestPage(id){
  return {
    contest:null, leaderboard:[],
    async init(){
      const c = await fetch(`/api/contests/${id}`).then(r=>r.json()); this.contest = c.contest;
      await this.loadLb();
    },
    async loadLb(){
      const lb = await fetch(`/api/contests/${this.contest.id}/leaderboard`).then(r=>r.json());
      this.leaderboard = lb.leaderboard || [];
    },
    async join(){
      const r = await fetch(`/api/contests/${this.contest.id}/join`, {method:'POST'});
      if(r.ok){ await this.loadLb(); alert('Вы участвуете!'); }
      else { const e = await r.json().catch(()=>({})); alert(e.description || 'Ошибка'); }
    }
  }
}
</script>
{% endblock %}
