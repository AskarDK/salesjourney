{% extends "base.html" %}
{% set title = "–ó–∞—è–≤–∫–∏ –≤ –∫–æ–º–ø–∞–Ω–∏—é" %}
{% block content %}

<section class="max-w-5xl mx-auto px-4 py-12" x-data="companyRequests()">
  <h1 class="text-3xl font-extrabold">–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h1>
  <p class="text-slate-300 mt-2">–£–∫–∞–∂–∏—Ç–µ ID –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∑–∞—è–≤–∫–∏.</p>

  <div class="mt-4 flex gap-2">
    <input x-model.number="companyId" type="number" placeholder="company_id"
           class="rounded-xl bg-black/40 border border-white/10 px-3 py-2">
    <button @click="load" class="px-4 py-2 rounded-xl border border-white/10 hover:bg-white/5">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>

  <div class="mt-6 rounded-2xl border border-white/10 bg-slate-900/60">
    <div class="p-4 border-b border-white/10 text-sm text-slate-400">–û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
    <div class="divide-y divide-white/10">
      <template x-for="r in rows" :key="r.id">
        <div class="p-4 flex items-center justify-between">
          <div>
            <div class="font-semibold" x-text="r.user.display_name"></div>
            <div class="text-xs text-slate-400" x-text="r.user.email"></div>
          </div>
          <div class="flex gap-2">
            <button @click="approve(r.id)" class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm">–û–¥–æ–±—Ä–∏—Ç—å</button>
            <button @click="reject(r.id)" class="px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-500 text-sm">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>
        </div>
      </template>
      <div class="p-4 text-sm text-slate-400" x-show="rows.length===0">–ù–µ—Ç –∑–∞—è–≤–æ–∫.</div>
    </div>
  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
function companyRequests(){
  return {
    companyId: '',
    rows: [],
    async load(){
      try{
        const r = await fetch(`/api/company/join/requests?company_id=${this.companyId}`);
        const j = await r.json();
        if(!r.ok) throw new Error(j.description || '–û—à–∏–±–∫–∞');
        this.rows = j.requests || [];
      }catch(e){
        Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:e.message, emoji:'‚ö†Ô∏è'});
      }
    },
    async approve(id){
      const r = await fetch(`/api/company/join/approve/${id}`, {method:'POST'});
      const j = await r.json().catch(()=>({}));
      if(!r.ok){ Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:(j.description||'–û—à–∏–±–∫–∞'), emoji:'‚ö†Ô∏è'}); return; }
      this.rows = this.rows.filter(x=>x.id!==id);
      Alpine.store('toasts').push({title:'–û–¥–æ–±—Ä–µ–Ω–æ', text:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω', emoji:'‚úÖ'});
    },
    async reject(id){
      const r = await fetch(`/api/company/join/reject/${id}`, {method:'POST'});
      const j = await r.json().catch(()=>({}));
      if(!r.ok){ Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:(j.description||'–û—à–∏–±–∫–∞'), emoji:'‚ö†Ô∏è'}); return; }
      this.rows = this.rows.filter(x=>x.id!==id);
      Alpine.store('toasts').push({title:'–û—Ç–∫–ª–æ–Ω–µ–Ω–æ', text:'–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', emoji:'üö´'});
    }
  }
}
</script>
{% endblock %}
