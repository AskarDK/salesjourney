{% extends "base.html" %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-10" aria-labelledby="profile-title">
  <h1 id="profile-title" class="sr-only">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>

  <div class="grid md:grid-cols-[320px,1fr] lg:grid-cols-[320px,1fr,320px] gap-8 items-start">

    <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –∫–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <aside class="relative rounded-2xl border border-slate-300 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6"
           aria-label="–ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è">

      <!-- –ö–Ω–æ–ø–∫–∞-–∫–∞—Ä–∞–Ω–¥–∞—à (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
      <button type="button"
              class="absolute top-3 right-3 inline-flex items-center justify-center w-8 h-8 rounded-lg
                     border border-slate-300 dark:border-white/10
                     hover:bg-black/5 dark:hover:bg-white/10
                     focus:outline-none focus:ring focus:ring-indigo-500/30"
              aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å"
              @click="$dispatch('open-profile-editor')"
              @keydown.enter.prevent="$dispatch('open-profile-editor')">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16.862 3.487a2.25 2.25 0 013.182 3.182L7.5 19.313l-4.25.567.567-4.25L16.862 3.487z" />
        </svg>
      </button>

      <!-- –ê–≤–∞—Ç–∞—Ä + –∏–º—è/—É—Ä–æ–≤–µ–Ω—å -->
      <div class="flex flex-col items-center">
        <div class="relative">
          <img src="/avatar_svg/{{ user.id }}" alt="–ê–≤–∞—Ç–∞—Ä"
               class="w-44 h-44 rounded-2xl ring-1 ring-slate-300 dark:ring-white/10 transition-all duration-300">
        </div>

        <div class="mt-4 text-center">
          <div class="text-xl font-bold text-slate-900 dark:text-slate-100" data-profile-name>
            {{ user.display_name }}
          </div>
          <div class="text-sm text-slate-600 dark:text-slate-400 mt-1">–£—Ä–æ–≤–µ–Ω—å {{ user.level }}</div>

          <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å XP -->
          {% set pct = (user.xp / user_next_xp * 100) | round(1) %}
          <div class="mt-3 w-full max-w-xs" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–ø—ã—Ç–∞">
            <div class="w-full h-2 bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden"
                 role="progressbar"
                 aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ pct }}"
                 aria-valuetext="{{ pct }}%">
              <div class="h-full bg-gradient-to-r from-indigo-400 via-cyan-300 to-emerald-300"
                   style="width: {{ pct }}%"></div>
            </div>
            <div class="text-xs text-slate-600 dark:text-slate-400 mt-1">
              XP: <span class="font-semibold">{{ user.xp }}</span> / {{ user_next_xp }} ({{ pct }}%)
            </div>
          </div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç—ã –∏ –±—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ -->
      <div class="mt-6 grid grid-cols-3 gap-3 text-center" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è">
        <div class="rounded-xl bg-white/70 dark:bg-black/30 border border-slate-300 dark:border-white/10 p-3">
          <div class="text-2xl">ü™ô</div>
          <div class="text-lg font-bold text-slate-900 dark:text-slate-100">{{ user.coins }}</div>
          <div class="text-[11px] text-slate-600 dark:text-slate-400">Coins</div>
        </div>
        <a href="/achievements"
           class="rounded-2xl bg-white/70 dark:bg-black/30 border border-slate-300 dark:border-white/10 p-3 hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30"
           aria-label="–ê—á–∏–≤–∫–∏">
          <div class="text-2xl">üèÜ</div>
          <div class="text-lg font-bold text-slate-900 dark:text-slate-100">ACH</div>
          <div class="text-[11px] text-slate-600 dark:text-slate-400">–û—Ç–∫—Ä—ã—Ç—å</div>
        </a>
        <a href="/contests"
           class="rounded-2xl bg-white/70 dark:bg-black/30 border border-slate-300 dark:border-white/10 p-3 hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30"
           aria-label="–ö–æ–Ω–∫—É—Ä—Å—ã">
          <div class="text-2xl">üèÅ</div>
          <div class="text-lg font-bold text-slate-900 dark:text-slate-100">Tour</div>
          <div class="text-[11px] text-slate-600 dark:text-slate-400">–û—Ç–∫—Ä—ã—Ç—å</div>
        </a>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏ -->
      <button type="button"
              class="mt-6 w-full text-center px-4 py-3 rounded-xl border border-slate-300 dark:border-white/10 bg-white/70 dark:bg-white/5 hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30"
              @click="$dispatch('open-xp-history')">
        –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏ (XP / coins / –∞—á–∏–≤–∫–∏)
      </button>

      <!-- –ë–ª–æ–∫ –∫–æ–º–ø–∞–Ω–∏–∏ -->
      <section class="mt-6 rounded-2xl border border-slate-300 dark:border-white/10 bg-white/80 dark:bg-black/30 p-4"
               x-data="companyJoin()" x-init="init()" aria-labelledby="company-title">
        <h2 id="company-title" class="text-sm font-semibold text-slate-800 dark:text-slate-200">–ö–æ–º–ø–∞–Ω–∏—è</h2>

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫ -->
        <template x-if="member">
          <div class="mt-2">
            <div class="text-sm text-slate-700 dark:text-slate-300">–í—ã —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–æ–º–ø–∞–Ω–∏–∏</div>
            <div class="mt-1 text-slate-900 dark:text-slate-100 font-semibold" x-text="company_name"></div>
            <a href="/partner/company"
               class="mt-3 inline-block px-4 py-2 rounded-xl border border-slate-300 dark:border-white/10 bg-white/70 dark:bg-white/5 hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30">
              –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏
            </a>
          </div>
        </template>

        <!-- –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ -->
        <template x-if="!member && pending">
          <div class="mt-2">
            <div class="text-sm font-semibold text-slate-800 dark:text-slate-200">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
            <div class="mt-1 text-slate-700 dark:text-slate-300">–ö–æ–º–ø–∞–Ω–∏—è: <span class="font-semibold" x-text="company_name"></span></div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è. –ù–æ–≤—É—é –∑–∞—è–≤–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–ª—å–∑—è.</div>
            <div class="mt-3 flex gap-2">
              <button type="button" @click="cancel"
                      class="px-4 py-2 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30">
                –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
              </button>
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-2" x-text="status" aria-live="polite"></div>
          </div>
        </template>

        <!-- –ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –Ω–µ—Ç –∑–∞—è–≤–∫–∏ ‚Äî —Ñ–æ—Ä–º–∞ -->
        <template x-if="!member && !pending">
          <form class="mt-2" @submit.prevent="submit" aria-label="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∫–æ–¥—É">
            <label class="block text-sm text-slate-700 dark:text-slate-300 mb-1">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –ø–æ –∫–æ–¥—É</label>
            <div class="flex gap-2">
              <input x-model="code"
                     inputmode="latin" autocomplete="off" autocapitalize="characters" maxlength="16"
                     class="flex-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-slate-900/60
                            text-slate-900 dark:text-slate-100 px-3 py-2 outline-none
                            focus:ring focus:ring-indigo-500/30"
                     placeholder="–ù–∞–ø—Ä. 9F3A2C1B" aria-label="–ö–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏">
              <button type="submit"
                      class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold focus:outline-none focus:ring focus:ring-indigo-500/30"
                      :disabled="!code.trim()">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
              </button>
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-2" x-text="status" aria-live="polite"></div>
          </form>
        </template>
      </section>
    </aside>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
    <div class="space-y-6">

      <!-- –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å -->
      <section class="rounded-2xl border border-slate-300 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6"
               aria-labelledby="welcome-title">
        <h2 id="welcome-title" class="text-2xl font-bold text-slate-900 dark:text-slate-100">
          –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span data-profile-name>{{ user.display_name }}</span>!
        </h2>
        <p class="text-slate-700 dark:text-slate-300 mt-2">
          –ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–≤–æ–∏ –∫–≤–µ—Å—Ç—ã, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
          –ó–∞–≥–ª—è–Ω–∏ –≤ <a href="/training" class="text-indigo-600 dark:text-indigo-400 underline-offset-2 hover:underline">–¢—Ä–µ–Ω–∏–Ω–≥</a>,
          <a href="/achievements" class="text-indigo-600 dark:text-indigo-400 underline-offset-2 hover:underline">–∞—á–∏–≤–∫–∏</a> –∏–ª–∏
          –ø—Ä–æ–≤–µ—Ä—å <a href="/contests" class="text-indigo-600 dark:text-indigo-400 underline-offset-2 hover:underline">–∫–æ–Ω–∫—É—Ä—Å—ã</a>.
        </p>
      </section>

      <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
      <section class="grid md:grid-cols-2 gap-4" aria-label="–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è">
        <a href="/store"
           class="group rounded-2xl border border-slate-300 dark:border-white/10 p-5
                  bg-gradient-to-br from-white/40 dark:from-white/0 to-white/80 dark:to-white/[0.03]
                  hover:to-white/90 dark:hover:to-white/[0.06] focus:outline-none focus:ring focus:ring-indigo-500/30">
          <div class="text-3xl mb-2" aria-hidden="true">üõí</div>
          <div class="font-semibold text-slate-900 dark:text-slate-100">–ú–∞–≥–∞–∑–∏–Ω</div>
          <div class="text-sm text-slate-700 dark:text-slate-400">–¢—Ä–∞—Ç—å –º–æ–Ω–µ—Ç—ã –Ω–∞ —Å–∫–∏–Ω—ã –∏ –±–æ–Ω—É—Å—ã</div>
        </a>
        <a href="/partner/company"
           class="group rounded-2xl border border-slate-300 dark:border-white/10 p-5
                  bg-gradient-to-br from-white/40 dark:from-white/0 to-white/80 dark:to-white/[0.03]
                  hover:to-white/90 dark:hover:to-white/[0.06] focus:outline-none focus:ring focus:ring-indigo-500/30">
          <div class="text-3xl mb-2" aria-hidden="true">üìä</div>
          <div class="font-semibold text-slate-900 dark:text-slate-100">–ö–æ–º–ø–∞–Ω–∏—è</div>
          <div class="text-sm text-slate-700 dark:text-slate-400">–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è –∏ —Å–≤–æ–¥–∫–∏ –ø–æ –æ—Ç–¥–µ–ª—É</div>
        </a>
      </section>

      <!-- –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
      <section class="rounded-2xl border border-slate-300 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6"
               aria-labelledby="activity-title">
        <h2 id="activity-title" class="text-sm uppercase tracking-wide text-slate-600 dark:text-slate-400 mb-2">–ü–æ—Å–ª–µ–¥–Ω–µ–µ</h2>
        <div class="rounded-xl border border-slate-300 dark:border-white/10 bg-white/70 dark:bg-black/30 p-4">
          <div class="text-slate-700 dark:text-slate-400 text-sm">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è.</div>
        </div>
      </section>

    </div>
  </div>
</section>

<!-- Slide-over: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
<div x-data="profileEditor({{ user.display_name|tojson }}, {{ user.email|tojson }})"
     @open-profile-editor.window="open()" x-cloak>
  <!-- overlay -->
  <div x-show="openModal" x-transition.opacity
       class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm"
       @click="close()" aria-hidden="true"></div>

  <!-- panel -->
  <div x-show="openModal" x-transition
       class="fixed inset-y-0 right-0 z-50 w-full max-w-md
              bg-white/95 dark:bg-slate-900/95
              border-l border-slate-200 dark:border-white/10
              p-6 shadow-xl"
       role="dialog" aria-modal="true" aria-labelledby="edit-title">
    <div class="flex items-center justify-between mb-4">
      <h2 id="edit-title" class="text-lg font-bold text-slate-900 dark:text-slate-100">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
      <button class="text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white focus:outline-none"
              @click="close()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-sm text-slate-700 dark:text-slate-400 mb-1" for="name">–ò–º—è</label>
        <input id="name" type="text" x-model="name" minlength="2" required
               class="w-full rounded-xl border border-slate-300 dark:border-white/10
                      bg-white dark:bg-slate-900/60 text-slate-900 dark:text-slate-100
                      px-3 py-2 outline-none focus:ring focus:ring-indigo-500/30"
               placeholder="–í–∞—à–µ –∏–º—è">
      </div>
      <div>
        <label class="block text-sm text-slate-700 dark:text-slate-400 mb-1" for="email">E-mail</label>
        <input id="email" type="email" x-model="email" required
               class="w-full rounded-xl border border-slate-300 dark:border-white/10
                      bg-white dark:bg-slate-900/60 text-slate-900 dark:text-slate-100
                      px-3 py-2 outline-none focus:ring focus:ring-indigo-500/30"
               placeholder="you@example.com">
      </div>

      <p class="text-sm text-rose-600 dark:text-rose-400" x-text="error" x-show="error" aria-live="assertive"></p>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button"
                class="px-4 py-2 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30"
                @click="close()" :disabled="saving">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn-primary" @click="save()" :disabled="saving">
          <span x-show="saving" class="btn-spinner"></span>
          <span x-text="saving ? '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏ -->
<div x-data="xpHistoryModal()" @open-xp-history.window="open()" x-cloak>
  <div x-show="openModal" x-transition.opacity class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm" aria-hidden="true"></div>
  <div x-show="openModal" x-transition class="fixed z-50 inset-0 grid place-items-center p-4" role="dialog" aria-modal="true" aria-labelledby="xp-title">
    <div class="w-full max-w-3xl rounded-2xl border border-slate-300 dark:border-white/10 bg-white/95 dark:bg-slate-900/95 p-5">
      <div class="flex items-center justify-between">
        <h2 id="xp-title" class="text-xl font-bold text-slate-900 dark:text-slate-100">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏</h2>
        <button class="text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white" @click="close()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
      <div class="mt-4 flex flex-wrap gap-2 text-sm">
        <button :class="tabBtn('all')" @click="filter='all'">–í—Å–µ</button>
        <button :class="tabBtn('achievement')" @click="filter='achievement'">–ê—á–∏–≤–∫–∏</button>
        <button :class="tabBtn('events')" @click="filter='events'">–°–æ–±—ã—Ç–∏—è</button>
      </div>
      <div class="mt-4 max-h-[65vh] overflow-auto space-y-3 pr-1">
        <template x-for="row in filtered" :key="row.key">
          <article class="flex items-start gap-3 rounded-xl border border-slate-300 dark:border-white/10 bg-white/70 dark:bg-black/30 p-3">
            <div class="text-2xl" x-text="row.emoji" aria-hidden="true"></div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-slate-900 dark:text-slate-100" x-text="row.title"></h3>
                <time class="text-xs text-slate-600 dark:text-slate-400" x-text="row.when"></time>
              </div>
              <p class="text-sm text-slate-700 dark:text-slate-300" x-text="row.subtitle"></p>
              <div class="mt-1 text-xs text-slate-600 dark:text-slate-400" x-show="row.meta" x-text="row.meta"></div>
            </div>
            <div class="text-right shrink-0">
              <div class="text-emerald-600 dark:text-emerald-400 font-semibold" x-show="row.points">+<span x-text="row.points"></span> XP</div>
              <div class="text-amber-600 dark:text-amber-300 font-semibold" x-show="row.coins">+<span x-text="row.coins"></span> ü™ô</div>
            </div>
          </article>
        </template>

        <div class="text-sm text-slate-600 dark:text-slate-400 text-center py-6" x-show="!loading && filtered.length===0" aria-live="polite">
          –ü—É—Å—Ç–æ. –°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –∫–≤–µ—Å—Ç –∏–ª–∏ –ø–æ–ª—É—á–∏ –∞—á–∏–≤–∫—É!
        </div>
        <div class="text-sm text-slate-700 dark:text-slate-300" x-show="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* --- Company join block --- */
function companyJoin(){
  return {
    code: '',
    status: '',
    member: false,
    pending: false,
    company_name: '',

    async init(){
      try{
        const r = await fetch('/api/company/join/status', { credentials: 'same-origin' });
        if (r.status === 404) { this.member=false; this.pending=false; this.company_name=''; this.status=''; return; }
        if (!r.ok) return;
        const j = await r.json().catch(()=>({}));
        this.member = !!j.member;
        this.pending = !!j.pending;
        this.company_name = j.company_name || j.company?.name || '';
        this.status = j.message || '';
      }catch(_e){}
    },

    async submit(){
      if (this.member || this.pending) return;
      const code = (this.code||'').trim().toUpperCase();
      if (!code){ this.status='–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏'; return; }

      try{
        const r = await fetch('/api/company/join', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({ code })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok){
          if (r.status === 409 || j.pending_exists){
            this.pending = true;
            this.company_name = j.company_name || j.company?.name || this.company_name;
            this.status = j.description || '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è.';
            Alpine.store('toasts').push({title:'–ó–∞—è–≤–∫–∞', text:this.status, emoji:'‚è≥'});
            return;
          }
          throw new Error(j.error || j.description || '–û—à–∏–±–∫–∞');
        }
        if (j.already_member || j.member){
          this.member = true; this.pending = false;
          this.company_name = j.company_name || j.company?.name || this.company_name;
          this.status = '–í—ã —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏.';
          Alpine.store('toasts').push({title:'–ö–æ–º–ø–∞–Ω–∏—è', text:'–í—ã –≤ –∫–æ–º–ø–∞–Ω–∏–∏', emoji:'üè¢'});
        } else {
          this.pending = true;
          this.company_name = j.company_name || j.company?.name || this.company_name;
          this.status = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è.';
          Alpine.store('toasts').push({title:'–ó–∞—è–≤–∫–∞', text:'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ', emoji:'üì®'});
        }
      }catch(e){
        this.status = e.message || '–û—à–∏–±–∫–∞';
        Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:this.status, emoji:'‚ö†Ô∏è'});
      }
    },

    async cancel(){
      if(!this.pending || this.member) return;
      try{
        const r = await fetch('/api/company/join/cancel', {
          method:'POST',
          credentials:'same-origin',
          headers:{'Content-Type':'application/json'}
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(j.error || j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É');

        this.pending = false;
        this.company_name = '';
        this.status = '–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.';
        Alpine.store('toasts').push({title:'–ó–∞—è–≤–∫–∞', text:'–û—Ç–º–µ–Ω–µ–Ω–∞', emoji:'üóëÔ∏è'});
      }catch(e){
        this.status = e.message || '–û—à–∏–±–∫–∞';
        Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:this.status, emoji:'‚ö†Ô∏è'});
      }
    }
  }
}

/* --- Slide-over: profile editor --- */
function profileEditor(initName, initEmail){
  return {
    openModal: false,
    name: initName || '',
    email: initEmail || '',
    saving: false,
    error: '',

    open(){ this.error=''; this.openModal = true; },
    close(){ if(!this.saving) this.openModal = false; },

    async save(){
      if ((this.name||'').trim().length < 2){ this.error = '–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ'; return; }
      if (!/.+@.+\..+/.test(this.email||'')){ this.error = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail'; return; }

      this.saving = true; this.error = '';
      try{
        const r = await fetch('/api/me/profile', {
          method:'POST',
          credentials:'same-origin',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name:this.name.trim(), email:this.email.trim() })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || j.ok === false){
          const msg = j.error || j.description || (r.status===409 ? 'E-mail —É–∂–µ –∑–∞–Ω—è—Ç' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
          throw new Error(msg);
        }
        Alpine.store('toasts').push({title:'–ü—Ä–æ—Ñ–∏–ª—å', text:'–û–±–Ω–æ–≤–ª—ë–Ω', emoji:'‚úÖ'});

        // –û–±–Ω–æ–≤–∏–º –∏–º—è –≤ –∫–∞—Ä—Ç–æ—á–∫–µ (–≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å data-profile-name)
        document.querySelectorAll('[data-profile-name]').forEach(el => el.textContent = this.name);

        this.close();
      }catch(e){
        this.error = e.message || '–û—à–∏–±–∫–∞';
        Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:this.error, emoji:'‚ö†Ô∏è'});
      }finally{
        this.saving = false;
      }
    }
  }
}

/* --- XP history modal --- */
function xpHistoryModal(){
  return {
    openModal: false,
    filter: 'all',
    loading: false,
    items: [],

    tabBtn(kind){
      const active = this.filter===kind;
      return `px-3 py-1 rounded-lg border ${active ? 'bg-white/10 border-white/20' : 'border-slate-300 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/10'}`;
    },

    get filtered(){
      if (this.filter === 'all') return this.items;
      return this.items.filter(x => x.type === this.filter); // 'achievement' | 'events'
    },

    open(){ this.openModal = true; if (!this.items.length) this.load(); },
    close(){ this.openModal = false; },

    async load(){
      this.loading = true;
      try{
        const r = await fetch('/api/user/xp_history', { credentials: 'same-origin' });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) return;

        const events = Array.isArray(j.events) ? j.events : [];
        const emojiBySource = { achievement:'üèÜ', task:'‚úÖ', training:'üéì', sale:'üíº', contest:'üèÅ', bonus:'‚ú®' };

        this.items = events.map(ev => {
          const m = ev.meta || {};
          const src = ev.source || 'events';
          const type = src === 'achievement' ? 'achievement' : 'events';
          const when = ev.created_at ? new Date(ev.created_at).toLocaleString() : '';
          const emoji = emojiBySource[src] || 'üìå';

          let title = '–°–æ–±—ã—Ç–∏–µ', subtitle = '';
          switch (src) {
            case 'achievement': title = ev.achievement_title || '–ê—á–∏–≤–∫–∞'; subtitle = m.code ? `–ö–æ–¥: ${m.code}` : ''; break;
            case 'task':       title = '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'; subtitle = m.title || ''; break;
            case 'training':   title = '–¢—Ä–µ–Ω–∏–Ω–≥ –ø—Ä–æ–π–¥–µ–Ω'; subtitle = m.title ? `${m.title}${m.score!=null ? ` (${m.score}%)` : ''}` : ''; break;
            case 'contest':    title = '–ö–æ–Ω–∫—É—Ä—Å'; subtitle = m.title || ''; break;
            case 'sale':       title = '–ü—Ä–æ–¥–∞–∂–∞'; subtitle = m.title || ''; break;
          }

          return { key: ev.id, emoji, title, when, subtitle, meta: '', points: ev.points, coins: ev.coins, type };
        });
      } finally {
        this.loading = false;
      }
    }
  }
}
</script>
{% endblock %}
