{% extends "base.html" %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-10" aria-labelledby="profile-title">
  <h1 id="profile-title" class="sr-only">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>

  <!-- HERO -->
  <div class="relative mb-8 overflow-hidden rounded-3xl border border-slate-200 dark:border-white/10">
    <div class="absolute inset-0 bg-[radial-gradient(1200px_500px_at_0%_0%,rgba(99,102,241,.20),transparent_50%),radial-gradient(800px_400px_at_100%_100%,rgba(16,185,129,.18),transparent_50%)]"></div>
    <div class="relative px-6 py-8 md:px-10">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div class="flex items-center gap-5">
          <img src="/avatar_svg/{{ user.id }}" alt="–ê–≤–∞—Ç–∞—Ä"
               class="w-20 h-20 md:w-24 md:h-24 rounded-2xl ring-1 ring-black/10 dark:ring-white/10 bg-white/60 dark:bg-slate-900/60 backdrop-blur">
          <div>
            <div class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white" data-profile-name>
              {{ user.display_name }}
            </div>
            <div class="mt-1 text-slate-600 dark:text-slate-300">
              –£—Ä–æ–≤–µ–Ω—å <b>{{ user.level }}</b> ‚Ä¢ ID #{{ user.id }}
            </div>
          </div>
        </div>

        <!-- KPI pills -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <div class="group rounded-2xl border border-slate-200/80 dark:border-white/10 bg-white/70 dark:bg-slate-900/50 px-4 py-3 backdrop-blur transition hover:shadow-md">
            <div class="text-sm text-slate-500 dark:text-slate-400">–û–ø—ã—Ç</div>
            {% set pct = (user.xp / user_next_xp * 100) | round(1) %}
            <div class="mt-1 flex items-baseline gap-2">
              <div class="text-xl font-bold">{{ user.xp }}</div>
              <div class="text-xs text-slate-500">/ {{ user_next_xp }}</div>
            </div>
            <div class="mt-2 h-2 rounded-full bg-slate-200 dark:bg-white/10 overflow-hidden" role="progressbar"
                 aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ pct }}" aria-valuetext="{{ pct }}%">
              <div class="h-full w-0 bg-gradient-to-r from-indigo-500 via-cyan-400 to-emerald-400 transition-[width] duration-1000 ease-out will-change-[width]"
                   style="width: {{ pct }}%"></div>
            </div>
          </div>
          <div class="group rounded-2xl border border-slate-200/80 dark:border-white/10 bg-white/70 dark:bg-slate-900/50 px-4 py-3 backdrop-blur transition hover:shadow-md">
            <div class="text-sm text-slate-500 dark:text-slate-400">Coins</div>
            <div class="mt-1 text-xl font-bold">{{ user.coins }}</div>
            <div class="text-xs text-slate-500">–ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤</div>
          </div>
          <a href="/achievements"
             class="rounded-2xl border border-slate-200/80 dark:border-white/10 bg-white/70 dark:bg-slate-900/50 px-4 py-3 backdrop-blur transition hover:shadow-md focus:outline-none focus:ring focus:ring-indigo-500/30">
            <div class="text-sm text-slate-500 dark:text-slate-400">–ê—á–∏–≤–∫–∏</div>
            <div class="mt-1 text-xl font-bold">–û—Ç–∫—Ä—ã—Ç—å üèÜ</div>
            <div class="text-xs text-slate-500">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- –¢–†–ò –ö–û–õ–û–ù–ö–ò -->
  <div class="grid md:grid-cols-[320px,1fr] lg:grid-cols-[320px,1fr,360px] gap-8 items-start">

    <!-- –õ–ï–í–ê–Ø: –ø—Ä–æ—Ñ–∏–ª—å + –∫–æ–º–ø–∞–Ω–∏—è + –∞–∫–∫–∞—É–Ω—Ç -->
    <aside class="space-y-6">

      <!-- –ü—Ä–æ—Ñ–∏–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
      <section class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 backdrop-blur">
        <header class="flex items-center justify-between">
          <h2 class="text-lg font-bold">–ü—Ä–æ—Ñ–∏–ª—å</h2>
          <button type="button"
                  class="inline-flex items-center gap-2 rounded-xl border border-slate-300 dark:border-white/10 px-3 py-1.5 text-sm hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30"
                  aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å"
                  @click="$dispatch('open-profile-editor')">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.862 3.487a2.25 2.25 0 013.182 3.182L7.5 19.313l-4.25.567.567-4.25L16.862 3.487z"/></svg>
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </header>

        <div class="mt-4 grid grid-cols-3 gap-3 text-center">
          <a href="/store"
             class="group rounded-2xl border border-slate-300 dark:border-white/10 bg-white/70 dark:bg-black/30 p-3 hover:shadow-md transition">
            <div class="text-2xl">üõí</div>
            <div class="text-sm font-semibold mt-1">–ú–∞–≥–∞–∑–∏–Ω</div>
            <div class="text-[11px] text-slate-500">–ë—É—Å—Ç—ã –∏ —Å–∫–∏–Ω—ã</div>
          </a>
          <a href="/training"
             class="group rounded-2xl border border-slate-300 dark:border-white/10 bg-white/70 dark:bg-black/30 p-3 hover:shadow-md transition">
            <div class="text-2xl">üéì</div>
            <div class="text-sm font-semibold mt-1">–¢—Ä–µ–Ω–∏–Ω–≥</div>
            <div class="text-[11px] text-slate-500">–ö—É—Ä—Å—ã –∏ —Ç–µ—Å—Ç—ã</div>
          </a>
          <a href="/contests"
             class="group rounded-2xl border border-slate-300 dark:border-white/10 bg-white/70 dark:bg-black/30 p-3 hover:shadow-md transition">
            <div class="text-2xl">üèÅ</div>
            <div class="text-sm font-semibold mt-1">–ö–æ–Ω–∫—É—Ä—Å—ã</div>
            <div class="text-[11px] text-slate-500">–õ–∏–¥–µ—Ä—ã –∏ —Ç—É—Ä—ã</div>
          </a>
        </div>
      </section>

      <!-- –ö–æ–º–ø–∞–Ω–∏—è -->
      <section class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 backdrop-blur"
               x-data="companyJoin()" x-init="init()" aria-labelledby="company-title">
        <h2 id="company-title" class="text-lg font-bold">–ö–æ–º–ø–∞–Ω–∏—è</h2>

        <!-- –£—á–∞—Å—Ç–Ω–∏–∫ -->
        <template x-if="member">
          <div class="mt-3">
            <div class="rounded-xl bg-emerald-50/70 dark:bg-emerald-900/20 border border-emerald-200/70 dark:border-emerald-500/20 p-4">
              <div class="text-sm text-emerald-900 dark:text-emerald-200">–í—ã —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–æ–º–ø–∞–Ω–∏–∏</div>
              <div class="mt-1 font-semibold" x-text="company_name"></div>
              <a href="/partner/company"
                 class="mt-3 inline-flex items-center gap-2 rounded-xl border border-emerald-300/60 px-3 py-2 text-sm text-emerald-800 dark:text-emerald-200 hover:bg-emerald-100/60 dark:hover:bg-emerald-800/30">
                –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
              </a>
            </div>
          </div>
        </template>

        <!-- –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ -->
        <template x-if="!member && pending">
          <div class="mt-3 rounded-xl border border-amber-300/60 bg-amber-50/70 dark:bg-amber-900/20 p-4">
            <div class="text-sm font-semibold text-amber-800 dark:text-amber-200">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
            <div class="text-sm mt-1 text-slate-700 dark:text-slate-300">–ö–æ–º–ø–∞–Ω–∏—è: <span class="font-semibold" x-text="company_name"></span></div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">–û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è. –ù–æ–≤—É—é –∑–∞—è–≤–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–ª—å–∑—è.</div>
            <div class="mt-3 flex gap-2">
              <button type="button" @click="cancel"
                      class="px-3 py-2 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/10 text-sm">
                –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
              </button>
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-2" x-text="status" aria-live="polite"></div>
          </div>
        </template>

        <!-- –§–æ—Ä–º–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
        <template x-if="!member && !pending">
          <form class="mt-3 space-y-2" @submit.prevent="submit" aria-label="–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∫–æ–¥—É">
            <label class="block text-sm text-slate-600 dark:text-slate-300">–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
            <div class="flex gap-2">
              <input x-model="code" inputmode="latin" autocomplete="off" autocapitalize="characters" maxlength="16"
                     class="flex-1 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-slate-900/60
                            text-slate-900 dark:text-slate-100 px-3 py-2 outline-none focus:ring focus:ring-indigo-500/30"
                     placeholder="–ù–∞–ø—Ä. 9F3A2C1B">
              <button type="submit"
                      class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold focus:outline-none focus:ring focus:ring-indigo-500/30"
                      :disabled="!code.trim()">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
              </button>
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400" x-text="status" aria-live="polite"></div>
          </form>
        </template>
      </section>

      <!-- –ê–∫–∫–∞—É–Ω—Ç -->
      <section class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 backdrop-blur"
               aria-labelledby="account-title">
        <h2 id="account-title" class="text-lg font-bold">–ê–∫–∫–∞—É–Ω—Ç</h2>
        <dl class="mt-3 text-sm space-y-1">
          <div class="flex justify-between gap-3"><dt class="text-slate-600 dark:text-slate-400">E-mail</dt><dd class="font-medium">{{ user.email }}</dd></div>
          <div class="flex justify-between gap-3"><dt class="text-slate-600 dark:text-slate-400">–°–æ–∑–¥–∞–Ω</dt><dd class="font-medium">{{ user.created_at }}</dd></div>
        </dl>
      </section>
    </aside>

    <!-- –¶–ï–ù–¢–†: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="space-y-6">

      <!-- –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å -->
      <section class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 backdrop-blur">
        <h2 class="text-xl md:text-2xl font-bold">
          –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span data-profile-name>{{ user.display_name }}</span>!
        </h2>
        <p class="text-slate-700 dark:text-slate-300 mt-2">
          –ó–¥–µ—Å—å —Ç–≤–æ–∏ –∫–≤–µ—Å—Ç—ã, –∞—á–∏–≤–∫–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –ó–∞–≥–ª—è–Ω–∏ –≤
          <a href="/training" class="text-indigo-600 dark:text-indigo-400 underline-offset-2 hover:underline">–¢—Ä–µ–Ω–∏–Ω–≥</a>,
          <a href="/achievements" class="text-indigo-600 dark:text-indigo-400 underline-offset-2 hover:underline">–ê—á–∏–≤–∫–∏</a>,
          <a href="/contests" class="text-indigo-600 dark:text-indigo-400 underline-offset-2 hover:underline">–ö–æ–Ω–∫—É—Ä—Å—ã</a>.
        </p>
      </section>

      <!-- –õ–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
      <section class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 backdrop-blur"
               aria-labelledby="activity-title" x-data="xpHistoryModal()" x-init="open()">
        <div class="flex items-center justify-between gap-4">
          <h2 id="activity-title" class="text-sm uppercase tracking-wide text-slate-600 dark:text-slate-400">–ü–æ—Å–ª–µ–¥–Ω–µ–µ</h2>
          <div class="flex flex-wrap gap-2 text-sm">
            <button :class="tabBtn('all')" @click="filter='all'">–í—Å–µ</button>
            <button :class="tabBtn('achievement')" @click="filter='achievement'">–ê—á–∏–≤–∫–∏</button>
            <button :class="tabBtn('events')" @click="filter='events'">–°–æ–±—ã—Ç–∏—è</button>
          </div>
        </div>

        <!-- skeleton -->
        <div class="mt-4 grid gap-3" x-show="loading" x-cloak>
          <div class="animate-pulse h-16 rounded-xl bg-slate-200/60 dark:bg-white/10"></div>
          <div class="animate-pulse h-16 rounded-xl bg-slate-200/60 dark:bg-white/10"></div>
          <div class="animate-pulse h-16 rounded-xl bg-slate-200/60 dark:bg-white/10"></div>
        </div>

        <div class="mt-4 max-h-[65vh] overflow-auto space-y-3 pr-1">
          <template x-for="row in filtered" :key="row.key">
            <article class="group flex items-start gap-3 rounded-xl border border-slate-200 dark:border-white/10 bg-white/70 dark:bg-black/30 p-3 transition hover:shadow-md">
              <div class="text-2xl" x-text="row.emoji" aria-hidden="true"></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h3 class="font-semibold text-slate-900 dark:text-slate-100" x-text="row.title"></h3>
                  <time class="text-xs text-slate-600 dark:text-slate-400" x-text="row.when"></time>
                </div>
                <p class="text-sm text-slate-700 dark:text-slate-300" x-text="row.subtitle"></p>
                <div class="mt-1 text-xs text-slate-600 dark:text-slate-400" x-show="row.meta" x-text="row.meta"></div>
              </div>
              <div class="text-right shrink-0">
                <div class="text-emerald-600 dark:text-emerald-400 font-semibold" x-show="row.points">+<span x-text="row.points"></span> XP</div>
                <div class="text-amber-600 dark:text-amber-300 font-semibold" x-show="row.coins">+<span x-text="row.coins"></span> ü™ô</div>
              </div>
            </article>
          </template>

          <div class="text-sm text-slate-600 dark:text-slate-400 text-center py-6" x-show="!loading && filtered.length===0" aria-live="polite">
            –ü—É—Å—Ç–æ. –°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –∫–≤–µ—Å—Ç –∏–ª–∏ –ø–æ–ª—É—á–∏ –∞—á–∏–≤–∫—É!
          </div>
        </div>
      </section>
    </div>

    <!-- –ü–†–ê–í–ê–Ø: Telegram, –ø–æ–¥—Å–∫–∞–∑–∫–∏ (sticky) -->
    <div class="space-y-6 lg:sticky lg:top-6">

      <!-- Telegram linking -->
      <section
        x-data="tgLinker()"
        x-init="init()"
        :class="state.linked ? 'border-emerald-300/70 bg-emerald-50/60 dark:bg-emerald-900/20' : 'border-slate-200 dark:border-white/10 bg-white/80 dark:bg-slate-900/60'"
        class="rounded-2xl border p-6 backdrop-blur transition-colors">

        <header class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold">–ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h2>
          <span class="inline-flex items-center gap-2"
                :class="state.linked ? 'text-emerald-700 dark:text-emerald-300' : 'text-amber-600'">
            <span class="w-2 h-2 rounded-full" :class="state.linked ? 'bg-emerald-500' : 'bg-amber-500'"></span>
            <span x-text="state.linked ? '–ü—Ä–∏–≤—è–∑–∞–Ω' : '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω'"></span>
          </span>
        </header>

        <!-- –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω -->
        <template x-if="!state.linked">
          <div class="space-y-3">
            <p class="text-sm text-slate-600 dark:text-slate-300">
              –°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–¥. –ó–∞—Ç–µ–º —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –±–æ—Ç—É.
            </p>

            <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ -->
            <button @click="generate()"
                    class="w-full px-4 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold shadow-sm hover:shadow focus:outline-none focus:ring focus:ring-indigo-500/30"
                    :disabled="loading">
              <span x-show="!loading">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</span>
              <span x-show="loading">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º‚Ä¶</span>
            </button>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
            <div x-show="state.code"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-2 scale-[.98]"
                 x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="mt-3 space-y-3">

              <div class="flex items-center gap-2">
                <div class="font-mono px-2 py-1 rounded-lg bg-black/5 dark:bg-white/10 text-sm" x-text="state.code"></div>
                <button @click="copyCode()"
                        class="px-2 py-1 rounded-lg border text-sm hover:bg-black/5 dark:hover:bg-white/10">
                  –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
              </div>

              <a :href="botDeepLink()" target="_blank" rel="noopener"
                 class="inline-flex items-center justify-center w-full px-4 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –±–æ—Ç—É
              </a>

              <p class="text-xs text-slate-500 dark:text-slate-400">
                –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è. –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –±–æ—Ç—É –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ.
              </p>
            </div>
          </div>
        </template>

        <!-- –ü—Ä–∏–≤—è–∑–∞–Ω -->
        <template x-if="state.linked">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-sm text-emerald-800 dark:text-emerald-200 font-medium">
                ‚úÖ –í—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ Telegram.
              </div>
              <div class="mt-1 text-xs text-slate-600 dark:text-slate-400">
                Chat ID: <span class="font-mono" x-text="state.chat_id"></span>
              </div>
            </div>
            <button @click="resetLink()"
                    class="px-3 py-1.5 rounded-md border border-emerald-300/60 text-emerald-800 dark:text-emerald-200 hover:bg-emerald-100/60 dark:hover:bg-emerald-800/30 text-xs"
                    :disabled="loading">
              –°–±—Ä–æ—Å–∏—Ç—å
            </button>
          </div>
        </template>
      </section>

      <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
      <section class="rounded-2xl border border-slate-200 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 backdrop-blur">
        <h2 class="text-sm uppercase tracking-wide text-slate-600 dark:text-slate-400 mb-2">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h2>
        <ul class="space-y-2 text-sm list-disc pl-5 text-slate-700 dark:text-slate-300">
          <li>–í–∫–ª—é—á–∏ Telegram ‚Äî –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —á–∞—Ç.</li>
          <li>–°–ª–µ–¥–∏ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –≤ –ª–µ–Ω—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –∞—á–∏–≤–∫–∞—Ö.</li>
          <li>–ó–∞–≥–ª—è–Ω–∏ –≤ ¬´–ú–∞–≥–∞–∑–∏–Ω¬ª –∑–∞ –±—É—Å—Ç–∞–º–∏.</li>
        </ul>
      </section>
    </div>
  </div>
</section>

<!-- Slide-over: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è -->
<div x-data="profileEditor({{ user.display_name|tojson }}, {{ user.email|tojson }})"
     @open-profile-editor.window="open()" x-cloak>
  <!-- overlay -->
  <div x-show="openModal" x-transition.opacity
       class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm"
       @click="close()" aria-hidden="true"></div>

  <!-- panel -->
  <div x-show="openModal" x-transition
       class="fixed inset-y-0 right-0 z-50 w-full max-w-md
              bg-white/95 dark:bg-slate-900/95
              border-l border-slate-200 dark:border-white/10
              p-6 shadow-xl"
       role="dialog" aria-modal="true" aria-labelledby="edit-title">
    <div class="flex items-center justify-between mb-4">
      <h2 id="edit-title" class="text-lg font-bold text-slate-900 dark:text-slate-100">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h2>
      <button class="text-slate-700 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white focus:outline-none"
              @click="close()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-sm text-slate-700 dark:text-slate-400 mb-1" for="name">–ò–º—è</label>
        <input id="name" type="text" x-model="name" minlength="2" required
               class="w-full rounded-xl border border-slate-300 dark:border-white/10
                      bg-white dark:bg-slate-900/60 text-slate-900 dark:text-slate-100
                      px-3 py-2 outline-none focus:ring focus:ring-indigo-500/30"
               placeholder="–í–∞—à–µ –∏–º—è">
      </div>
      <div>
        <label class="block text-sm text-slate-700 dark:text-slate-400 mb-1" for="email">E-mail</label>
        <input id="email" type="email" x-model="email" required
               class="w-full rounded-xl border border-slate-300 dark:border-white/10
                      bg-white dark:bg-slate-900/60 text-slate-900 dark:text-slate-100
                      px-3 py-2 outline-none focus:ring focus:ring-indigo-500/30"
               placeholder="you@example.com">
      </div>

      <p class="text-sm text-rose-600 dark:text-rose-400" x-text="error" x-show="error" aria-live="assertive"></p>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button"
                class="px-4 py-2 rounded-xl border border-slate-300 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/10 focus:outline-none focus:ring focus:ring-indigo-500/30"
                @click="close()" :disabled="saving">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold focus:outline-none focus:ring focus:ring-indigo-500/30"
                @click="save()" :disabled="saving">
          <span x-show="saving" class="inline-block w-4 h-4 mr-2 align-[-2px] rounded-full border-2 border-white/60 border-r-transparent animate-spin"></span>
          <span x-text="saving ? '–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'"></span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- –∏–º—è –±–æ—Ç–∞ –≤ –∫–ª–∏–µ–Ω—Ç (–¥–ª—è deep-link) -->
<script>window.TELEGRAM_BOT_USERNAME = "{{ TELEGRAM_BOT_USERNAME }}";</script>

<script>
/* --- Company join block --- */
function companyJoin(){
  return {
    code: '',
    status: '',
    member: false,
    pending: false,
    company_name: '',

    async init(){
      try{
        const r = await fetch('/api/company/join/status', { credentials: 'same-origin' });
        if (r.status === 404) { this.member=false; this.pending=false; this.company_name=''; this.status=''; return; }
        if (!r.ok) return;
        const j = await r.json().catch(()=>({}));
        this.member = !!j.member;
        this.pending = !!j.pending;
        this.company_name = j.company_name || j.company?.name || '';
        this.status = j.message || '';
      }catch(_e){}
    },

    async submit(){
      if (this.member || this.pending) return;
      const code = (this.code||'').trim().toUpperCase();
      if (!code){ this.status='–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏'; return; }

      try{
        const r = await fetch('/api/company/join', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({ code })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok){
          if (r.status === 409 || j.pending_exists){
            this.pending = true;
            this.company_name = j.company_name || j.company?.name || this.company_name;
            this.status = j.description || '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è.';
            Alpine.store('toasts')?.push({title:'–ó–∞—è–≤–∫–∞', text:this.status, emoji:'‚è≥'});
            return;
          }
          throw new Error(j.error || j.description || '–û—à–∏–±–∫–∞');
        }
        if (j.already_member || j.member){
          this.member = true; this.pending = false;
          this.company_name = j.company_name || j.company?.name || this.company_name;
          this.status = '–í—ã —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏.';
          Alpine.store('toasts')?.push({title:'–ö–æ–º–ø–∞–Ω–∏—è', text:'–í—ã –≤ –∫–æ–º–ø–∞–Ω–∏–∏', emoji:'üè¢'});
        } else {
          this.pending = true;
          this.company_name = j.company_name || j.company?.name || this.company_name;
          this.status = '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è.';
          Alpine.store('toasts')?.push({title:'–ó–∞—è–≤–∫–∞', text:'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –æ–¥–æ–±—Ä–µ–Ω–∏–µ', emoji:'üì®'});
        }
      }catch(e){
        this.status = e.message || '–û—à–∏–±–∫–∞';
        Alpine.store('toasts')?.push({title:'–û—à–∏–±–∫–∞', text:this.status, emoji:'‚ö†Ô∏è'});
      }
    },

    async cancel(){
      if(!this.pending || this.member) return;
      try{
        const r = await fetch('/api/company/join/cancel', {
          method:'POST',
          credentials:'same-origin',
          headers:{'Content-Type':'application/json'}
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(j.error || j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É');

        this.pending = false;
        this.company_name = '';
        this.status = '–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.';
        Alpine.store('toasts')?.push({title:'–ó–∞—è–≤–∫–∞', text:'–û—Ç–º–µ–Ω–µ–Ω–∞', emoji:'üóëÔ∏è'});
      }catch(e){
        this.status = e.message || '–û—à–∏–±–∫–∞';
        Alpine.store('toasts')?.push({title:'–û—à–∏–±–∫–∞', text:this.status, emoji:'‚ö†Ô∏è'});
      }
    }
  }
}

/* --- Slide-over: profile editor --- */
function profileEditor(initName, initEmail){
  return {
    openModal: false,
    name: initName || '',
    email: initEmail || '',
    saving: false,
    error: '',

    open(){ this.error=''; this.openModal = true; },
    close(){ if(!this.saving) this.openModal = false; },

    async save(){
      if ((this.name||'').trim().length < 2){ this.error = '–ò–º—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ'; return; }
      if (!/.+@.+\..+/.test(this.email||'')){ this.error = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π e-mail'; return; }

      this.saving = true; this.error = '';
      try{
        const r = await fetch('/api/me/profile', {
          method:'POST',
          credentials:'same-origin',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name:this.name.trim(), email:this.email.trim() })
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || j.ok === false){
          const msg = j.error || j.description || (r.status===409 ? 'E-mail —É–∂–µ –∑–∞–Ω—è—Ç' : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
          throw new Error(msg);
        }
        Alpine.store('toasts')?.push({title:'–ü—Ä–æ—Ñ–∏–ª—å', text:'–û–±–Ω–æ–≤–ª—ë–Ω', emoji:'‚úÖ'});

        document.querySelectorAll('[data-profile-name]').forEach(el => el.textContent = this.name);
        this.close();
      }catch(e){
        this.error = e.message || '–û—à–∏–±–∫–∞';
        Alpine.store('toasts')?.push({title:'–û—à–∏–±–∫–∞', text:this.error, emoji:'‚ö†Ô∏è'});
      }finally{
        this.saving = false;
      }
    }
  }
}

/* --- XP history modal (–∫–∞–∫ –±–ª–æ–∫) --- */
function xpHistoryModal(){
  return {
    openModal: false,
    filter: 'all',
    loading: false,
    items: [],

    tabBtn(kind){
      const active = this.filter===kind;
      return `px-3 py-1 rounded-lg border ${active ? 'bg-white/10 border-white/20' : 'border-slate-300 dark:border-white/10 hover:bg-black/5 dark:hover:bg-white/10'}`;
    },

    get filtered(){
      if (this.filter === 'all') return this.items;
      return this.items.filter(x => x.type === this.filter);
    },

    open(){ this.openModal = true; if (!this.items.length) this.load(); },
    close(){ this.openModal = false; },

    async load(){
      this.loading = true;
      try{
        const r = await fetch('/api/user/xp_history', { credentials: 'same-origin' });
        const j = await r.json().catch(()=>({}));
        if (!r.ok) return;

        const events = Array.isArray(j.events) ? j.events : [];
        const emojiBySource = { achievement:'üèÜ', task:'‚úÖ', training:'üéì', sale:'üíº', contest:'üèÅ', bonus:'‚ú®' };

        this.items = events.map(ev => {
          const m = ev.meta || {};
          const src = ev.source || 'events';
          const type = src === 'achievement' ? 'achievement' : 'events';
          const when = ev.created_at ? new Date(ev.created_at).toLocaleString() : '';
          const emoji = emojiBySource[src] || 'üìå';

          let title = '–°–æ–±—ã—Ç–∏–µ', subtitle = '';
          switch (src) {
            case 'achievement': title = ev.achievement_title || '–ê—á–∏–≤–∫–∞'; subtitle = m.code ? `–ö–æ–¥: ${m.code}` : ''; break;
            case 'task':       title = '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'; subtitle = m.title || ''; break;
            case 'training':   title = '–¢—Ä–µ–Ω–∏–Ω–≥ –ø—Ä–æ–π–¥–µ–Ω'; subtitle = m.title ? `${m.title}${m.score!=null ? ` (${m.score}%)` : ''}` : ''; break;
            case 'contest':    title = '–ö–æ–Ω–∫—É—Ä—Å'; subtitle = m.title || ''; break;
            case 'sale':       title = '–ü—Ä–æ–¥–∞–∂–∞'; subtitle = m.title || ''; break;
          }

          return { key: ev.id, emoji, title, when, subtitle, meta: '', points: ev.points, coins: ev.coins, type };
        });
      } finally {
        this.loading = false;
      }
    }
  }
}

/* --- Alpine registration for Telegram linker (if provided globally) --- */
document.addEventListener('alpine:init', () => {
  if (typeof window.tgLinker === 'function') {
    Alpine.data('tgLinker', window.tgLinker);
  }
});
</script>
<script defer>
(() => {
  'use strict';

  // ---- Toasts (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–æ—Ä) ----
  document.addEventListener('alpine:init', () => {
    if (!Alpine.store('toasts')) {
      Alpine.store('toasts', {
        id: 1,
        items: [],
        push(t) { // {title, text, emoji}
          const id = this.id++;
          const item = { id, ...(t || {}), show: true };
          this.items.push(item);
          setTimeout(() => this.dismiss(id), 4000);
        },
        dismiss(id) {
          const it = this.items.find(x => x.id === id);
          if (!it) return;
          it.show = false;
          setTimeout(() => {
            this.items = this.items.filter(x => x.id !== id);
          }, 200);
        }
      });
    }
  });

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π fallback-—Ç–æ—Å—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ)
  window.toast = function (msg, opts) {
    try {
      Alpine.store('toasts')?.push({
        title: (opts && opts.title) || '–°–æ–æ–±—â–µ–Ω–∏–µ',
        text: msg,
        emoji: (opts && opts.emoji) || undefined
      });
    } catch (_) {
      try { alert(msg); } catch (_) {}
    }
  };

  // ---- Telegram linker: –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ–∞–±—Ä–∏–∫–∞ ----
  // –†–∞–±–æ—Ç–∞–µ—Ç –∏ –∫–∞–∫ window.tgLinker() –∏ –∫–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π x-data="tgLinker"
  window.tgLinker = function () {
    return {
      state: {
        linked: false,
        chat_id: null,
        code: null,
        bot_username: (typeof window.TELEGRAM_BOT_USERNAME !== 'undefined' && window.TELEGRAM_BOT_USERNAME) ? window.TELEGRAM_BOT_USERNAME : null
      },
      loading: false,
      _pollTimer: null,
      _pollUntil: 0,

      init() { // x-init="init()"
        this.fetchStatus();
      },

      async fetchStatus() {
        try {
          const r = await fetch('/api/telegram/status', { credentials: 'same-origin' });
          const j = await r.json().catch(() => ({}));
          if (r.ok && j && j.ok) {
            this.state.linked = !!(j.data && j.data.linked);
            this.state.chat_id = (j.data && j.data.chat_id) || null;
            this.state.bot_username = (j.data && j.data.bot_username) || this.state.bot_username;
            if (this.state.linked) this._stopPolling();
          }
        } catch (_) { /* –º–æ–ª—á–∞ */ }
      },

      botDeepLink() {
        const u = this.state.bot_username || (typeof window.TELEGRAM_BOT_USERNAME !== 'undefined' ? window.TELEGRAM_BOT_USERNAME : '');
        const code = this.state.code ? encodeURIComponent(this.state.code) : '';
        return u ? `https://t.me/${u}${code ? `?start=${code}` : ''}` : 'https://t.me/';
      },

      async generate() {
        if (this.loading) return;
        this.loading = true;
        try {
          const r = await fetch('/api/telegram/generate', { method: 'POST', credentials: 'same-origin' });
          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok) throw new Error(j.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥');
          this.state.code = j.code || null;
          // –∑–∞–ø—É—Å–∫–∞–µ–º –æ–ø—Ä–æ—Å –Ω–∞ –º–∏–Ω—É—Ç—É —Ä–∞–∑ –≤ 3—Å
          this._startPolling(60_000, 3000);
        } catch (e) {
          window.toast(e.message || '–û—à–∏–±–∫–∞', { title: 'Telegram', emoji: '‚ö†Ô∏è' });
        } finally {
          this.loading = false;
        }
      },

      async copyCode() {
        try {
          if (!this.state.code) return;
          await navigator.clipboard.writeText(this.state.code);
          Alpine.store('toasts')?.push({ title: 'Telegram', text: '–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', emoji: 'üìã' });
        } catch (_) { /* –∏–≥–Ω–æ—Ä */ }
      },

      async resetLink() {
        if (this.loading) return;
        if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É Telegram?')) return;
        this.loading = true;
        try {
          const r = await fetch('/api/telegram/reset', { method: 'POST', credentials: 'same-origin' });
          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok) throw new Error(j.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É');
          this.state.linked = false;
          this.state.chat_id = null;
          this.state.code = null;
          Alpine.store('toasts')?.push({ title: 'Telegram', text: '–ü—Ä–∏–≤—è–∑–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞', emoji: '‚ÑπÔ∏è' });
        } catch (e) {
          Alpine.store('toasts')?.push({ title: 'Telegram', text: e.message || '–û—à–∏–±–∫–∞', emoji: '‚ö†Ô∏è' });
        } finally {
          this.loading = false;
          this._stopPolling();
        }
      },

      _startPolling(totalMs = 60000, stepMs = 3000) {
        this._stopPolling();
        this._pollUntil = Date.now() + totalMs;
        this._pollTimer = setInterval(async () => {
          await this.fetchStatus();
          if (this.state.linked || Date.now() > this._pollUntil) {
            this._stopPolling();
          }
        }, stepMs);
      },

      _stopPolling() {
        if (this._pollTimer) {
          clearInterval(this._pollTimer);
          this._pollTimer = null;
        }
      }
    };
  };

  // ---- Alpine registration (–¥–ª—è x-data="tgLinker") ----
  document.addEventListener('alpine:init', () => {
    Alpine.data('tgLinker', window.tgLinker);
  });
})();
</script>

{% endblock %}
