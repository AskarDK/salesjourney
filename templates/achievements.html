{% extends "base.html" %}
{% set title = "–ú–æ–∏ –∞—á–∏–≤–∫–∏ ‚Äî Sales Journey" %}
{% block content %}
<section class="max-w-5xl mx-auto px-4 py-12">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-4xl font-extrabold">–ú–æ–∏ –∞—á–∏–≤–∫–∏</h1>
      <p class="text-slate-300 mt-1">–°–æ–±–∏—Ä–∞–π —Å–µ—Ç ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–π —Ä–µ–¥–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã</p>
    </div>
    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4 text-right cursor-pointer hover:bg-white/5 transition"
     x-data @click="$dispatch('open-xp-history')">
  <div class="text-sm text-slate-300">–£—Ä–æ–≤–µ–Ω—å</div>
  <div class="text-2xl font-bold">{{ user.level }}</div>
  <div class="text-xs text-slate-400 mt-1">XP: {{ user.xp }} / {{ user_next_xp }}</div>
  <div class="w-40 h-2 bg-white/10 rounded-full mt-2 overflow-hidden">
    <div class="h-full grad-anim" style="width: {{ (user.xp / user_next_xp * 100)|round(1) }}%"></div>
  </div>
  <div class="text-[11px] text-slate-400 mt-2">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
</div>

  </div>

  <div class="mt-8 grid sm:grid-cols-2 lg:grid-cols-3 gap-5">
    {% for a in achievements %}
    <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-5 hover:translate-y-[-2px] transition">
      <div class="text-3xl">{{ 'üåü' if a.rarity!='common' else '‚ú®' }}</div>
      <div class="font-semibold mt-2">{{ a.title }}</div>
      <div class="text-sm text-slate-300 mt-1">{{ a.description or '' }}</div>
      <div class="mt-3 text-xs text-slate-400">+{{ a.points }} XP ‚Ä¢ {{ a.rarity }}</div>
      {% if a.code in owned_codes %}
        <div class="mt-3 inline-flex items-center gap-2 text-emerald-400 text-sm font-semibold">‚úî –ü–æ–ª—É—á–µ–Ω–æ</div>
      {% else %}
        <div class="mt-3 inline-flex items-center gap-2 text-slate-400 text-sm">‚úñ –ù–µ –ø–æ–ª—É—á–µ–Ω–æ</div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</section>
<!-- XP/Coins History Modal -->
<div x-data="xpHistoryModal()" @open-xp-history.window="open()" x-cloak>
  <div x-show="openModal" x-transition.opacity
       class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm"></div>

  <div x-show="openModal" x-transition
       class="fixed z-50 inset-0 grid place-items-center p-4">
    <div class="w-full max-w-2xl rounded-2xl border border-white/10 bg-slate-900/90 p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–∫–∞—á–∫–∏</h3>
        <button class="text-slate-400 hover:text-slate-200" @click="close()">‚úï</button>
      </div>

      <!-- —Ñ–∏–ª—å—Ç—Ä—ã -->
      <div class="mt-4 flex flex-wrap gap-2 text-sm">
        <button :class="tabBtn('all')" @click="filter='all'">–í—Å–µ</button>
        <button :class="tabBtn('achievement')" @click="filter='achievement'">–ê—á–∏–≤–∫–∏</button>
        <button :class="tabBtn('events')" @click="filter='events'">–°–æ–±—ã—Ç–∏—è</button>
      </div>

      <!-- —Å–ø–∏—Å–æ–∫ -->
      <div class="mt-4 max-h-[60vh] overflow-auto space-y-3 pr-1">
        <template x-for="row in filtered" :key="row.key">
          <div class="flex items-start gap-3 rounded-xl border border-white/10 bg-black/30 p-3">
            <div class="text-2xl" x-text="row.emoji"></div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <div class="font-semibold" x-text="row.title"></div>
                <div class="text-xs text-slate-400" x-text="row.when"></div>
              </div>
              <div class="text-sm text-slate-300" x-text="row.subtitle"></div>
              <div class="mt-1 text-xs text-slate-400" x-show="row.meta" x-text="row.meta"></div>
            </div>
            <div class="text-right">
              <div class="text-emerald-400 font-semibold" x-show="row.points">+<span x-text="row.points"></span> XP</div>
              <div class="text-amber-300 font-semibold" x-show="row.coins">+<span x-text="row.coins"></span> ü™ô</div>
            </div>
          </div>
        </template>

        <div class="text-sm text-slate-400 text-center py-6" x-show="!loading && filtered.length===0">
          –ü—É—Å—Ç–æ. –°–¥–µ–ª–∞–π –ø–µ—Ä–≤—ã–π –∫–≤–µ—Å—Ç –∏–ª–∏ –ø–æ–ª—É—á–∏ –∞—á–∏–≤–∫—É!
        </div>
        <div class="text-sm text-slate-300" x-show="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>
  </div>
</div>

<script>
function xpHistoryModal(){
  return {
    openModal: false,
    loading: false,
    rows: [],
    filter: 'all', // all | achievement | events

    tabBtn(kind){
      return `px-3 py-1 rounded-lg border ${this.filter===kind ? 'bg-white/10 border-white/20' : 'border-white/10 hover:bg-white/5'}`;
    },

    get filtered(){
      if(this.filter==='all') return this.rows;
      if(this.filter==='achievement') return this.rows.filter(r => r.type==='achievement');
      return this.rows.filter(r => r.type==='event');
    },

    open(){ this.openModal = true; this.fetchData(); },
    close(){ this.openModal = false; },

    async fetchData(){
      if(this.rows.length){ return; }
      try{
        this.loading = true;
        const [evr, ar] = await Promise.all([
          fetch('/api/user/xp_history').then(r=>r.json()),
          fetch('/api/user/achievements/history').then(r=>r.json())
        ]);

        // events
        const evRows = (evr.events || []).map(e => {
          const dt = new Date(e.created_at);
          const when = dt.toLocaleString();
          const isAch = e.source === 'achievement';
          const title = isAch ? (e.achievement_title || '–ê—á–∏–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞') : srcTitle(e.source);
          const subtitle = isAch ? (e.achievement_code ? `–ö–æ–¥: ${e.achievement_code}` : '') : metaBrief(e.meta);
          return {
            key: `e_${e.id}`,
            type: isAch ? 'achievement' : 'event',
            emoji: isAch ? 'üèÜ' : sourceEmoji(e.source),
            title, subtitle,
            when, points: e.points, coins: e.coins,
            meta: isAch ? null : metaLine(e.meta)
          };
        });

        // achievements (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω–µ –≤—Å—ë –æ—Ç—Ä–∞–∂–µ–Ω–æ –≤ score_events)
        const achRows = (ar.achievements || []).map((a, idx) => {
          const dt = new Date(a.awarded_at);
          return {
            key: `a_${idx}_${a.code}`,
            type: 'achievement',
            emoji: a.rarity!=='common' ? 'üåü' : '‚ú®',
            title: a.title,
            subtitle: `–†–µ–¥–∫–æ—Å—Ç—å: ${a.rarity}`,
            when: dt.toLocaleString(),
            points: a.points,
            coins: null,
            meta: `–ö–æ–¥: ${a.code}`
          };
        });

        // –æ–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (—É –Ω–∞—Å —Å—Ç—Ä–æ–∫–∏ already –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –≤–æ–∑—å–º—ë–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö)
        this.rows = [...evRows, ...achRows].sort((a,b) => {
          // –≥—Ä—É–±–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –≤—ã—Ç—è–Ω–µ–º ISO –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Å—ã—Ä—Ü–æ–≤ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
          // events —É –Ω–∞—Å —É–∂–µ –ø–æ –¥–∞—Ç–µ, achievements ‚Äî —Ç–æ–∂–µ, —Ç–∞–∫ —á—Ç–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
          return 0;
        });

      }catch(e){
        Alpine.store('toasts').push({title:'–û—à–∏–±–∫–∞', text:'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é', emoji:'‚ö†Ô∏è'});
      }finally{
        this.loading = false;
      }

      function srcTitle(src){
        return ({
          sale: '–°–¥–µ–ª–∫–∞',
          task: '–ó–∞–¥–∞–Ω–∏–µ',
          contest: '–ö–æ–Ω–∫—É—Ä—Å',
          bonus: '–ë–æ–Ω—É—Å',
        })[src] || '–°–æ–±—ã—Ç–∏–µ';
      }
      function sourceEmoji(src){
        return ({
          sale: 'üíº',
          task: 'üß©',
          contest: 'üèÅ',
          bonus: 'üéÅ',
        })[src] || 'üìå';
      }
      function metaBrief(meta){
        if(!meta) return '';
        if(meta.step) return `–®–∞–≥: ${meta.step}`;
        if(meta.role) return `–†–æ–ª—å: ${meta.role}`;
        if(meta.score_delta) return `–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${meta.score_delta}`;
        return '';
      }
      function metaLine(meta){
        if(!meta) return null;
        try{
          const keys = Object.keys(meta);
          if(!keys.length) return null;
          return keys.map(k=>`${k}: ${meta[k]}`).join(', ');
        }catch(_){ return null; }
      }
    }
  }
}
</script>

{% endblock %}
