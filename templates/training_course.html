{% extends "base.html" %}
{% set title = "–ö—É—Ä—Å ‚Äî —Ç—Ä–µ–Ω–∏–Ω–≥" %}
{% block content %}

<section class="max-w-5xl mx-auto px-4 py-10"
         x-data="trainingCourse({{ course_id }})"
         x-init="load(); loadProgress(); restoreLock()">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ + –º–µ—Ç–∞ -->
  <div class="flex items-center justify-between">
    <h1 class="text-3xl font-extrabold" x-text="course?.title || '–ö—É—Ä—Å'"></h1>
    <div class="text-sm text-slate-400" x-show="course">
      –ü–æ—Ä–æ–≥: <span x-text="course.pass_score"></span>% ‚Ä¢ XP: <span x-text="course.xp_reward"></span>
    </div>
  </div>

  <!-- –°—Ç—É–ø–µ–Ω–∏ -->
  <div class="mt-6">
    <div class="inline-flex rounded-2xl border border-white/10 bg-slate-900/60 p-1">
      <button type="button"
              class="px-4 py-2 rounded-xl text-sm font-semibold"
              :class="stage===1 ? 'bg-white/10' : 'hover:bg-white/5'"
              @click="go(1)">
        1. –ú–∞—Ç–µ—Ä–∏–∞–ª
      </button>
      <button type="button"
              class="px-4 py-2 rounded-xl text-sm font-semibold"
              :class="stage===2 ? 'bg-white/10' : 'hover:bg-white/5'"
              @click="go(2)">
        2. –ö–≤–∏–∑
      </button>
    </div>
    <template x-if="locked && stage===2">
      <div class="mt-2 text-xs text-amber-300">–í–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–≤–∏–∑–∞ –≤–æ–∑–≤—Ä–∞—Ç –∫ –º–∞—Ç–µ—Ä–∏–∞–ª—É –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.</template>
  </div>

  <!-- –≠—Ç–∞–ø 1: –ú–∞—Ç–µ—Ä–∏–∞–ª -->
  <div x-show="stage===1" x-transition>
    <div class="mt-6 rounded-2xl border border-white/10 bg-slate-900/60 p-5">
      <div class="prose prose-invert max-w-none" x-html="renderMd(course?.content_md || '–ú–∞—Ç–µ—Ä–∏–∞–ª —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç‚Ä¶')"></div>

      <div class="mt-4" x-show="course?.youtube_url">
        <div class="rounded-xl overflow-hidden border border-white/10">
          <iframe
            class="w-full aspect-video"
            :src="youtubeEmbed(course.youtube_url)"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <div class="text-xs text-slate-400">
          –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span x-text="progress"></span>%
        </div>
        <button type="button"
                class="px-5 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-semibold"
                @click="beginQuiz()">
          –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–≤–∏–∑—É
        </button>
      </div>
    </div>
  </div>

  <!-- –≠—Ç–∞–ø 2: –ö–≤–∏–∑ -->
  <div x-show="stage===2" x-transition>
    <div class="mt-6 rounded-2xl border border-white/10 bg-slate-900/60 p-5">
      <div class="flex items-center justify-between">
        <div class="text-xl font-semibold">–ö–≤–∏–∑ –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É</div>
        <div class="text-sm text-slate-400" x-show="limits">
          –ü–æ–ø—ã—Ç–æ–∫: <span x-text="limits.left"></span> / <span x-text="limits.total"></span>
        </div>
      </div>

      <template x-if="!questions.length">
        <div class="text-sm text-slate-400 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </template>

      <form class="mt-4 space-y-4" @submit.prevent="submit()">
        <template x-for="q in questions" :key="q.id">
          <div class="rounded-xl border border-white/10 bg-black/30 p-3">
            <div class="font-semibold" x-text="q.text"></div>
            <div class="mt-2 grid gap-2">
              <template x-for="o in q.options" :key="o.id">
                <label class="flex items-center gap-2">
                  <input type="radio" :name="'q_'+q.id" :value="o.id"
                         @change="answers[q.id]=Number($event.target.value)">
                  <span x-text="o.text"></span>
                </label>
              </template>
            </div>
          </div>
        </template>

        <div class="pt-2 flex items-center gap-3">
          <button type="submit"
                  class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold">
            –°–¥–∞—Ç—å
          </button>
          <div class="text-sm" :class="passed ? 'text-emerald-400' : 'text-slate-300'"
               x-show="resultText" x-text="resultText"></div>
        </div>
      </form>

      <div class="mt-4">
        <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-indigo-500 to-emerald-400" :style="`width:${progress}%`"></div>
        </div>
        <div class="text-xs text-slate-400 mt-1">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span x-text="progress"></span>%</div>
      </div>
    </div>
  </div>

</section>

{% endblock %}

{% block scripts %}
<script>
function trainingCourse(id){
  return {
    // --- state ---
    courseId: id,
    stage: 1,                 // 1 ‚Äî –º–∞—Ç–µ—Ä–∏–∞–ª, 2 ‚Äî –∫–≤–∏–∑
    canSwitchTabs: true,      // –∑–∞–ø—Ä–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª—É –≤–æ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏
    course: null,
    questions: [],
    answers: {},
    limits: null,             // { left, total }
    progress: 0,              // –ª—É—á—à–∏–π % –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∫—É—Ä—Å—É
    resultText: '',
    passed: false,            // —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
    hasPassed: false,         // —É–∂–µ –µ—Å—Ç—å —É—Å–ø–µ—à–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤ –ø—Ä–æ—à–ª–æ–º
    bestScore: 0,

    // --- –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ Alpine stores (no-op, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç) ---
    fx(){
      try { return (window.Alpine && Alpine.store && Alpine.store('fx')) || { confetti(){}, coins(){} }; }
      catch(_) { return { confetti(){}, coins(){} }; }
    },
    toast(){
      try { return (window.Alpine && Alpine.store && Alpine.store('toasts')) || { push(){}, dismiss(){} }; }
      catch(_) { return { push(){}, dismiss(){} }; }
    },

    // --- helpers ---
    renderMd(md){
      if(!md) return '';
      let h = md
        .replace(/^### (.*)$/gim, '<h3>$1</h3>')
        .replace(/^## (.*)$/gim, '<h2>$1</h2>')
        .replace(/^# (.*)$/gim, '<h1>$1</h1>')
        .replace(/^\> (.*)$/gim, '<blockquote>$1</blockquote>')
        .replace(/\*\*(.*?)\*\*/gim, '<b>$1</b>')
        .replace(/\*(.*?)\*/gim, '<i>$1</i>')
        .replace(/`([^`]+)`/gim, '<code>$1</code>')
        .replace(/\n$/gim, '<br/>');
      h = h.replace(/^- (.*)$/gim, '<li>$1</li>');
      h = h.replace(/(<li>.*<\/li>)/gims, '<ul>$1</ul>');
      return h;
    },
    youtubeEmbed(url){
      try{
        const u = new URL(url);
        const id = (u.searchParams.get('v') || '').trim();
        if(id) return `https://www.youtube.com/embed/${id}`;
      }catch(_){}
      if((url||'').includes('youtu.be/')){
        const id = url.split('youtu.be/')[1].split(/[?&]/)[0];
        return `https://www.youtube.com/embed/${id}`;
      }
      return url;
    },

    // --- lifecycle ---
    async init(){
      await this.load();
      await this.loadProgress();
      // –µ—Å–ª–∏ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω ‚Äî —Å—Ä–∞–∑—É –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
      if(this.hasPassed){
        this.limits = { left: 0, total: this.course?.max_attempts ?? 0 };
      }
    },

    // --- data ---
    async load(){
      const r = await fetch(`/api/training/courses/${this.courseId}`);
      const j = await r.json();
      if(!r.ok) throw new Error(j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å');
      this.course = j.course;
      this.questions = (j.course.questions || []).map(q => ({
        id: q.id, text: q.text, options: q.options || []
      }));
    },
    async loadProgress(){
      const pr = await fetch('/api/training/progress').then(r=>r.json());
      const attempts = (pr.attempts || []).filter(a => a.course_id === this.courseId);
      this.bestScore = attempts.reduce((m,a)=>Math.max(m, a.score||0), 0);
      this.progress = this.bestScore;
      this.hasPassed = attempts.some(a => a.passed);
    },

    // --- –≤–∫–ª–∞–¥–∫–∏/–Ω–∞–≤–∏–≥–∞—Ü–∏—è ---
    setStage(n){
      if(n === 2){
        this.stage = 2; // –∫ –∫–≤–∏–∑—É –º–æ–∂–Ω–æ
        return;
      }
      if(!this.canSwitchTabs){
        this.toast().push({title:'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ', text:'–í–æ–∑–≤—Ä–∞—Ç –∫ –º–∞—Ç–µ—Ä–∏–∞–ª—É –≤–æ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—Ä–µ—â—ë–Ω', emoji:'‚õîÔ∏è'});
        return;
      }
      this.stage = 1;
    },

    // --- –∑–∞–ø—Ä–µ—Ç "–Ω–∞–∑–∞–¥" –≤ –±—Ä–∞—É–∑–µ—Ä–µ –≤–æ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏ ---
    _popHandler: null,
    _installNoBack(){
      history.pushState({ sjLock:true }, '', location.href);
      this._popHandler = ()=>{
        if(!this.canSwitchTabs){
          history.pushState({ sjLock:true }, '', location.href);
          this.toast().push({title:'–ò–¥—ë—Ç –ø–æ–ø—ã—Ç–∫–∞', text:'–ù–µ–ª—å–∑—è –≤–µ—Ä–Ω—É—Ç—å—Å—è, –ø–æ–∫–∞ –∏–¥—ë—Ç –∫–≤–∏–∑', emoji:'‚è≠Ô∏è'});
        }
      };
      window.addEventListener('popstate', this._popHandler);
    },
    _removeNoBack(){
      if(this._popHandler){
        window.removeEventListener('popstate', this._popHandler);
        this._popHandler = null;
      }
    },
    lockQuiz(){ this.canSwitchTabs = false; this._installNoBack(); },
    unlockQuiz(){ this.canSwitchTabs = true; this._removeNoBack(); },

    // --- —Å—Ç–∞—Ä—ã–π –∞–ª–∏–∞—Å, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å HTML (@click="start()") ---
    async start(){ return this.beginQuiz(); },

    // --- –∫–≤–∏–∑ ---
    async beginQuiz(){
      if(this.hasPassed){
        this.toast().push({title:'–£–∂–µ –ø—Ä–æ–π–¥–µ–Ω–æ', text:'–ö—É—Ä—Å —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.', emoji:'‚úÖ'});
        return;
      }
      try{
        const r = await fetch(`/api/training/courses/${this.courseId}/start`, { method:'POST' });
        const j = await r.json();
        if(!r.ok) throw new Error(j.description || '–ù–µ–ª—å–∑—è –Ω–∞—á–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É');
        this.limits = { left: j.attempts_left, total: (this.course?.max_attempts || j.attempts_left) };
        this.answers = {};
        this.resultText = '';
        this.passed = false;

        this.lockQuiz();
        this.stage = 2;

        this.toast().push({title:'–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞—á–∞—Ç–∞', text:`–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${j.attempts_left}`, emoji:'‚ñ∂Ô∏è'});
      }catch(e){
        this.toast().push({title:'–û—à–∏–±–∫–∞', text:e.message, emoji:'‚ö†Ô∏è'});
      }
    },

    async submit(){
      try{
        const payload = {
          answers: Object.entries(this.answers).map(([qid, oid]) => ({
            question_id: Number(qid), option_id: Number(oid)
          }))
        };
        const r = await fetch(`/api/training/courses/${this.courseId}/submit_quiz`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.description || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–∞—Ç—å —Ç–µ—Å—Ç');

        this.passed = !!j.passed;
        this.resultText = this.passed
          ? `–£—Å–ø–µ—Ö! –ë–∞–ª–ª: ${j.score}%`
          : `–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ. –ë–∞–ª–ª: ${j.score}%. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`;

        await this.loadProgress(); // –ø–æ–¥—Ç—è–Ω—É—Ç—å —Ñ–∞–∫—Ç –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è

        if(this.passed){
          this.hasPassed = true;
          this.fx().confetti();                    // –∞–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—à–∫–∏
          this.toast().push({title:'–ö—É—Ä—Å –ø—Ä–æ–π–¥–µ–Ω', text:`+${this.course.xp_reward} XP`, emoji:'üèÜ'});

          // –±–ª–æ–∫–∏—Ä—É–µ–º –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø–æ–ø—ã—Ç–∫–∏
          this.limits = { left: 0, total: this.course?.max_attempts ?? 0 };
          this.unlockQuiz();

          // —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤
          setTimeout(()=>{ window.location.href = '/training'; }, 1500);
        }else{
          this.toast().push({title:'–ü–æ–∫–∞ –Ω–µ—Ç', text:'–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑', emoji:'üîÅ'});
          this.unlockQuiz(); // –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –º–æ–∂–Ω–æ
        }
      }catch(e){
        this.resultText = e.message;
        this.toast().push({title:'–û—à–∏–±–∫–∞', text:e.message, emoji:'‚ö†Ô∏è'});
        this.unlockQuiz();
      }
    }
  }
}

// –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
document.addEventListener('alpine:init', () => {
  const root = document.querySelector('[x-data^="trainingCourse("]');
  if(root && !root.__x){
    Alpine.initTree(root);
    queueMicrotask(() => {
      try { root.__x.$data.init(); } catch(_) {}
    });
  }
});
</script>
{% endblock %}
