{% extends "base.html" %}
{% set title = "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è ‚Äî Sales Journey" %}

{% block content %}
<section class="max-w-7xl mx-auto px-4 py-8"
x-data="window.partnerCompanyPage({{ company_id if company_id is not none else 'null' }})"
         x-init="init()"
         x-cloak>
<div class="flex items-center justify-between">
  <div>
    <h1 class="text-3xl font-extrabold">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</h1>
    <p class="text-slate-400" x-text="headerSubtitle"></p>
  </div>

  <div class="flex items-center gap-2">
    <template x-if="companyId">
      <div class="flex items-center gap-2">
        <a href="/partner/requests" class="rounded-xl px-4 py-2 border border-white/10 hover:bg-white/5">–ó–∞—è–≤–∫–∏</a>
        <a href="/partner/reports"  class="rounded-xl px-4 py-2 border border-white/10 hover:bg-white/5">–û—Ç—á—ë—Ç—ã –ø–æ –∑–∞–¥–∞—á–∞–º</a>
      </div>
    </template>

    <template x-if="!companyId">
      <a href="/partner/company/create" class="rounded-xl px-4 py-2 bg-indigo-600 hover:bg-indigo-500 font-semibold">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</a>
    </template>
  </div>
</div>

  <!-- INVITE MODAL -->
  <div x-show="inviteModal" x-transition.opacity x-cloak
       class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60" @click="inviteModal=false"></div>

    <div class="relative w-full max-w-lg rounded-2xl bg-white p-6 text-slate-900"
         @click.stop>
      <div class="flex items-center justify-between">
        <div class="text-lg font-bold">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∫–æ–º–ø–∞–Ω–∏—é</div>
        <button class="text-slate-400 hover:text-slate-600"
                @click="inviteModal=false">&times;</button>
      </div>

      <div class="mt-4 space-y-3">
        <template x-if="invite?.active">
          <div class="space-y-3">
            <div>
              <div class="text-sm text-slate-500">–ö–æ–¥</div>
              <div class="flex items-center gap-2">
                <input class="w-full rounded-lg border px-3 py-2" :value="invite.code" readonly>
                <button class="rounded-lg px-3 py-2 border hover:bg-slate-50"
                        @click="copy(invite.code)">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </div>

            <div>
              <div class="text-sm text-slate-500">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
              <div class="flex items-center gap-2">
                <input class="w-full rounded-lg border px-3 py-2" :value="invite.invite_url" readonly>
                <button class="rounded-lg px-3 py-2 border hover:bg-slate-50"
                        @click="copy(invite.invite_url)">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
              <div class="text-xs text-slate-500 mt-1">
                –≠—Ç—É —Å—Å—ã–ª–∫—É –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç—É ‚Äî –∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
              </div>
            </div>
          </div>
        </template>

        <template x-if="!invite?.active">
          <div class="rounded-lg border border-dashed p-4 text-slate-500">
            –ê–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–¥–∞ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥¬ª.
          </div>
        </template>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <button class="rounded-lg px-3 py-2 border hover:bg-slate-50"
                @click="deactivateInvite()">–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–¥</button>
        <div class="space-x-2">
          <button class="rounded-lg px-3 py-2 border hover:bg-slate-50"
                  @click="inviteModal=false">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="rounded-lg px-3 py-2 bg-indigo-600 text-white hover:bg-indigo-500"
                  @click="regenerateInvite()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        </div>
      </div>
    </div>
  </div>

  <template x-if="companyId">
    <div>
      <!-- LAYOUT: Left content + Right company info -->
      <div class="mt-8 grid md:grid-cols-[1fr,380px] gap-4">

        <!-- LEFT -->
        <div>
          <div class="flex gap-2 text-sm">
            <button :class="tabBtn('feed')"  @click="tab='feed'">–õ–µ–Ω—Ç–∞</button>
            <button :class="tabBtn('tasks')" @click="tab='tasks'">–ó–∞–¥–∞—á–∏</button>
          </div>

          <!-- FEED -->
          <div x-show="tab==='feed'" x-transition.opacity class="mt-4">
            <!-- –ù–æ–≤—ã–π –ø–æ—Å—Ç (—Ç–æ–ª—å–∫–æ –ø–∞—Ä—Ç–Ω—ë—Ä/–º–µ–Ω–µ–¥–∂–µ—Ä) -->
            <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4 mb-4"
                 x-show="canPost">
              <div class="font-semibold mb-2">–ù–æ–≤—ã–π –ø–æ—Å—Ç</div>
              <textarea x-model="newPost"
                        class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 h-28"
                        placeholder="–¢–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è..."></textarea>

              <!-- –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
              <div class="mt-2">
                <input type="file" accept="image/*" x-ref="newPostImageInput"
                       class="block w-full text-sm file:mr-3 file:rounded-lg file:border file:border-white/10 file:bg-white/5 file:px-3 file:py-1.5 file:hover:bg-white/10"
                       @change="onNewPostFile($event)">
                <div x-show="newPostPreview" class="mt-2">
                  <img :src="newPostPreview" alt=""
                       class="max-h-48 rounded-lg border border-white/10 object-contain">
                  <button type="button"
                          class="mt-2 text-xs text-slate-300 underline hover:opacity-80"
                          @click="clearNewPostFile()">–£–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                </div>
              </div>

              <label class="inline-flex items-center gap-2 text-sm mt-2">
                <input type="checkbox" x-model="newPinned" class="rounded"> –ó–∞–∫—Ä–µ–ø–∏—Ç—å
              </label>

              <button class="mt-3 w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 py-2 font-semibold"
                      @click="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            </div>

            <!-- –õ–µ–Ω—Ç–∞ -->
            <div class="space-y-3">
              <template x-for="p in feed" :key="p.id">
                <div class="rounded-xl border border-white/10 bg-black/30 p-4">
                  <div class="text-xs text-slate-400"
                       x-text="new Date(p.created_at).toLocaleString()"></div>
                  <div class="font-semibold mt-1">
                    <span class="text-emerald-400" x-text="p.author"></span>
                    <span class="text-slate-500 text-xs"
                          x-text="p.type==='partner'?'(–ø–∞—Ä—Ç–Ω—ë—Ä)':'(–º–µ–Ω–µ–¥–∂–µ—Ä)'"></span>
                    <span x-show="p.pinned" class="ml-2 text-amber-300">üìå</span>
                  </div>
                  <div class="mt-1 text-slate-200 whitespace-pre-line" x-text="p.text"></div>
                  <template x-if="(p.image_url || p.photo_url || p.image)">
                    <img :src="p.image_url || p.photo_url || p.image"
                         class="mt-2 rounded-lg border border-white/10 max-h-80 object-contain"
                         loading="lazy" alt="">
                  </template>
                </div>
              </template>
              <div x-show="feed.length===0" class="text-slate-400 text-sm">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>
            </div>
          </div>

          <!-- TASKS -->
          <div x-show="tab==='tasks'" x-transition.opacity class="mt-4">
            <div class="space-y-3">
              <template x-for="t in tasks" :key="t.id">
                <div class="rounded-xl border border-white/10 bg-black/30 p-4 flex items-start justify-between gap-4">
                  <!-- –ª–µ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                  <div>
                    <div class="font-semibold" x-text="t.title"></div>
                    <div class="flex items-center gap-2 mt-1">
                      <span class="text-[11px] px-2 py-0.5 rounded-full border border-white/10"
                            :class="{
                              'text-emerald-300': t.priority==='low',
                              'text-sky-300':     t.priority==='normal',
                              'text-amber-300':   t.priority==='high',
                              'text-rose-300':    t.priority==='critical',
                            }"
                            x-text="'–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ' + (t.priority || 'normal')"></span>
                      <span class="text-[11px] text-slate-400"
                            x-text="t.require_proof ? '—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç' : '–±–µ–∑ –æ—Ç—á—ë—Ç–∞'"></span>
                    </div>

                    <div class="text-sm text-slate-300 mt-1" x-text="t.description"></div>

                    <div class="text-xs text-slate-400 mt-1">
                      –ù–∞–≥—Ä–∞–¥–∞:
                      <span class="text-emerald-300" x-text="t.points_xp + ' XP'"></span>,
                      <span class="text-amber-300"   x-text="t.coins + ' ü™ô'"></span>
                      <span x-show="t.due_at"> ¬∑ –¥–µ–¥–ª–∞–π–Ω:
                        <span x-text="new Date(t.due_at).toLocaleDateString()"></span>
                      </span>
                      <span x-show="t.due_at" class="ml-2"
                            :class="t.is_due_passed ? 'text-rose-300' : 'text-emerald-300'"
                            x-text="t.is_due_passed ? '—Å—Ä–æ–∫ –∏—Å—Ç—ë–∫' : '—Å—Ä–æ–∫ –Ω–µ –∏—Å—Ç—ë–∫'"></span>
                    </div>

                    <div class="text-xs mt-1"
                         :class="{'text-sky-300': t.assign_status==='assigned', 'text-emerald-300': t.assign_status==='approved', 'text-rose-300': t.assign_status==='rejected'}"
                         x-show="t.assign_status"
                         x-text="t.assign_status==='assigned' ? '–ù–∞–∑–Ω–∞—á–µ–Ω–∞' : (t.assign_status==='approved' ? '–ó–∞—á—Ç–µ–Ω–∞' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞')">
                    </div>
                  </div>

                  <div class="shrink-0 flex items-center gap-2">
                    <template x-if="canCreateTasks">
                      <button class="rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5"
                              @click="openTaskModal('edit', t)">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    </template>

                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ backend –≤—ã–¥–∞–ª submittable=true -->
                    <template x-if="t.submittable">
                      <div class="flex items-center gap-2">
                        <input type="file" class="hidden" :id="'proof_'+t.id"
                               @change="submitProof(t.id, $event)">
                        <button class="rounded-lg border border-white/10 px-3 py-2 hover:bg-white/5"
                                @click="document.getElementById('proof_'+t.id).click()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç</button>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
              <div x-show="tasks.length===0" class="text-slate-400 text-sm">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç.</div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
            <div class="flex justify-end mt-4" x-show="canCreateTasks">
              <button class="rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-2 font-semibold"
                      @click="openTaskModal('create')">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
          </div>

          <!-- TASK MODAL (create/edit) -->
          <div x-show="taskModal.open" x-transition.opacity x-cloak>
            <div class="fixed inset-0 bg-black/60 z-40" @click="closeTaskModal()"></div>

            <div class="fixed inset-x-0 top-[6%] mx-auto max-w-2xl z-50
                        rounded-2xl border border-white/10 bg-slate-900/95 p-5"
                 @click.stop>
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold"
                    x-text="taskModal.mode==='create' ? '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞' : '–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É'"></h3>
                <button class="rounded-lg border border-white/10 px-2 py-1 hover:bg-white/5"
                        @click="closeTaskModal()">‚úï</button>
              </div>

              <div class="px-5 py-4 max-h-[75vh] overflow-y-auto overscroll-contain">
                <!-- –§–û–†–ú–ê –ó–ê–î–ê–ß–ò -->
                <div class="mt-4 grid gap-3">
                  <input x-model="taskModal.form.title"
                         class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2"
                         placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">

                  <textarea x-model="taskModal.form.description"
                            class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 h-28"
                            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>

                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <label class="text-xs text-slate-400">XP</label>
                      <input x-model.number="taskModal.form.points_xp" type="number"
                             class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
                    </div>
                    <div>
                      <label class="text-xs text-slate-400">–ö–æ–∏–Ω—ã</label>
                      <input x-model.number="taskModal.form.coins" type="number"
                             class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-2">
                    <div>
                      <label class="text-xs text-slate-400">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                      <select x-model="taskModal.form.priority"
                              class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
                        <option value="low">low</option>
                        <option value="normal">normal</option>
                        <option value="high">high</option>
                        <option value="critical">critical</option>
                      </select>
                    </div>
                    <div class="flex items-end">
                      <label class="inline-flex items-center gap-2 text-xs text-slate-400">
                        <input type="checkbox" x-model="taskModal.form.require_proof" class="rounded">
                        –¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç —Å —Ñ–æ—Ç–æ
                      </label>
                    </div>
                  </div>

                  <div>
                    <label class="text-xs text-slate-400">–î–µ–¥–ª–∞–π–Ω (–¥–∞—Ç–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="date" x-model="taskModal.form._due_date"
                           class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
                  </div>

                  <div>
                    <label class="text-xs text-slate-400">ID –∞—á–∏–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input x-model.number="taskModal.form.reward_achievement_id" type="number"
                           class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2"
                           placeholder="–ù–∞–ø—Ä., 3">
                  </div>
                </div>

                <!-- –í–´–ë–û–† –°–û–¢–†–£–î–ù–ò–ö–û–í -->
                <div class="mt-5">
                  <div class="text-sm font-semibold">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</div>

                  <!-- –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∏–ø—Å—ã -->
                  <div class="mt-2 flex flex-wrap gap-2" x-show="taskModal.selectedIds.length">
                    <template x-for="uid in taskModal.selectedIds" :key="uid">
                      <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full
                                    border border-white/10 bg-black/30">
                        <span x-text="nameById(uid)"></span>
                        <button class="hover:text-rose-400" @click="tmUnselect(uid)">‚úï</button>
                      </span>
                    </template>
                  </div>

                  <!-- –ø–æ–∏—Å–∫ -->
                  <div class="mt-2">
                    <input x-model="taskModal.query" @input="tmSearchMembers"
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email"
                           class="w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2">
                  </div>

                  <!-- —Å–ø–∏—Å–æ–∫ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ -->
                  <div class="mt-3 max-h-64 overflow-auto divide-y divide-white/5">
                    <template x-for="m in taskModal.members" :key="m.id">
                      <label class="flex items-center gap-3 py-2 px-1 cursor-pointer">
                        <input type="checkbox"
                               :value="String(m.id)"
                               :checked="taskModal.selectedIds.includes(String(m.id))"
                               @change="tmToggleSelect(m.id)">
                        <div class="leading-tight">
                          <div class="font-medium" x-text="m.display_name"></div>
                          <div class="text-xs text-slate-400" x-text="m.email"></div>
                        </div>
                      </label>
                    </template>
                    <div class="text-sm text-slate-400 py-6 text-center"
                         x-show="!taskModal.members.length">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                  </div>
                </div>
              </div>

              <div class="sticky bottom-0 z-10 flex justify-end gap-2 px-5 py-3 border-t border-white/10
                          bg-slate-900/95/80 backdrop-blur">
                <button class="rounded-xl border border-white/10 px-4 py-2 hover:bg-white/5"
                        @click="closeTaskModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-2 font-semibold disabled:opacity-50"
                        :disabled="!taskModal.form.title?.trim()"
                        @click="saveTask()"
                        x-text="taskModal.mode==='create' ? '–°–æ–∑–¥–∞—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'">
                </button>
              </div>
            </div>
          </div>
        </div> <!-- /LEFT -->

        <!-- RIGHT -->
        <aside class="space-y-4 md:pt-11">
          <!-- –ü–∞—Å–ø–æ—Ä—Ç –∫–æ–º–ø–∞–Ω–∏–∏ -->
          <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-5">
            <div class="flex items-center gap-4">
              <div class="h-16 w-16 rounded-full border border-white/10 bg-indigo-600/20 flex items-center justify-center text-xl font-bold">
                <span x-text="(company && company.name ? company.name.charAt(0).toUpperCase() : 'C')"></span>
              </div>
              <div>
                <div class="text-lg font-bold" x-text="company?.name || '–ö–æ–º–ø–∞–Ω–∏—è'"></div>
                <div class="text-xs text-slate-400" x-text="company ? '@' + company.slug : ''"></div>
              </div>
            </div>

            <!-- KPI –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="mt-4 grid grid-cols-3 gap-2">
              <div class="rounded-xl border border-white/10 bg-black/30 p-3 text-center">
                <div class="text-[11px] text-slate-400">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
                <div class="text-lg font-bold" x-text="kpi.members ?? '‚Äî'"></div>
              </div>
              <div class="rounded-2xl border border-white/10 bg-black/30 p-3 text-center">
                <div class="text-[11px] text-slate-400">–£—Ä–æ–≤–µ–Ω—å</div>
                <div class="text-lg font-bold" x-text="kpi.avg_level ?? '‚Äî'"></div>
              </div>
              <div class="rounded-xl border border-white/10 bg-black/30 p-3 text-center">
                <div class="text-[11px] text-slate-400">–°–æ–±—ã—Ç.30–¥</div>
                <div class="text-lg font-bold" x-text="kpi.events_30d ?? '‚Äî'"></div>
              </div>
            </div>
          </div>

          <!-- –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä -->
          <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4 text-sm text-slate-300">
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å –∫–æ–º–ø–∞–Ω–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π ¬´–õ–µ–Ω—Ç–∞¬ª –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π, ¬´–ó–∞–¥–∞—á–∏¬ª ‚Äî –¥–ª—è –º–∏–∫—Ä–æ-–∫–≤–µ—Å—Ç–æ–≤, ¬´–õ–∏–¥–µ—Ä–±–æ—Ä–¥¬ª ‚Äî –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞ 30 –¥–Ω–µ–π.
          </div>

          <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ (30 –¥–Ω–µ–π) -->
          <div class="rounded-2xl border border-white/10 bg-slate-900/60 p-4">
            <div class="text-sm text-slate-400 mb-2">–õ–∏–¥–µ—Ä–±–æ—Ä–¥ ¬∑ 30 –¥–Ω–µ–π</div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-slate-400">
                <tr>
                  <th class="text-left py-2">#</th>
                  <th class="text-left">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                  <th class="text-right">XP</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="(row,idx) in leaderboard" :key="row.user_id || row.id">
                  <tr class="border-t border-white/5">
                    <td class="py-2" x-text="idx+1"></td>
                    <td x-text="row.display_name"></td>
                    <td class="text-right font-semibold" x-text="row.xp_30d"></td>
                  </tr>
                </template>
                </tbody>
              </table>
              <div x-show="leaderboard.length===0"
                   class="text-slate-400 text-sm py-2">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
            </div>
          </div>
        </aside>

      </div> <!-- /grid -->
    </div>
  </template>
</section>
{% endblock %}

{% block scripts %}
<script>
window.partnerCompanyPage = function(initialCompanyId){
  return {
    /* ---------- helpers ---------- */
    toLocalInputDate(iso){
      if(!iso) return '';
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    },
    isoFromLocalDateEnd(dateStr){
      if(!dateStr) return null;
      const dt = new Date(`${dateStr}T23:59:59`);
      return dt.toISOString();
    },
    tabBtn(kind){ return `px-3 py-1 rounded-lg border ${this.tab===kind?'bg-white/10 border-white/20':'border-white/10 hover:bg-white/5'}`; },

    /* ---------- state ---------- */
    companyId: initialCompanyId,
    company: null,
    kpi: {},
    feed: [],
    tasks: [],
    leaderboard: [],
    tab: 'feed',

    canPost: false,
    canCreateTasks: false,

    // feed create
    newPost: '',
    newPinned: false,
    newPostFile: null,
    newPostPreview: '',

    // invite modal
    inviteModal: false,
    invite: null,

    // task modal state
    taskModal: {
      open:false, mode:'create', taskId:null,
      form: { title:'', description:'', points_xp:20, coins:5, due_at:'', priority:'normal', require_proof:true, reward_achievement_id:null, _due_date:'' },
      query:'', members:[], selectedIds:[],
      _byId: Object.create(null)
    },

    get headerSubtitle(){
      return this.company ? `${this.company.name} (${this.company.slug})` : '–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π'
    },

    /* ---------- invite ---------- */
    async openInviteModal(){
      this.inviteModal = true;
      const r = await fetch(`/api/partners/company/${this.companyId}/invite`, {credentials:'same-origin'});
      if (r.ok) this.invite = await r.json().catch(()=>null);
    },
    async regenerateInvite(){
      const r = await fetch(`/api/partners/company/${this.companyId}/invite/regenerate`, {
        method:'POST', credentials:'same-origin'
      });
      if (r.ok) this.invite = await r.json().catch(()=>null);
    },
    async deactivateInvite(){
      const r = await fetch(`/api/partners/company/${this.companyId}/invite/deactivate`, {
        method:'POST', credentials:'same-origin'
      });
      if (r.ok) this.invite = await r.json().catch(()=>null);
    },
    copy(v){
      navigator.clipboard?.writeText(v).then(()=> {
        Alpine.store('toasts')?.push?.({title:'–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', emoji:'üìã'});
      });
    },

    /* ---------- proof submit ---------- */
    async submitProof(taskId, ev){
      const input = ev.target;
      const file = input.files?.[0];
      if(!file) return;

      const fd = new FormData();
      fd.append('photo', file);

      try{
        const r = await fetch(`/api/company/tasks/${taskId}/submit`, {
          method:'POST', body: fd, credentials: 'same-origin'
        });
        if(!r.ok){
          const err = await r.json().catch(()=>null);
          alert(err?.description || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç');
          return;
        }
        Alpine.store('toasts')?.push?.({title:'–û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', emoji:'üì§'});
        input.value = '';
        await this.loadDashboard();
      }catch(_e){
        alert('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      }
    },

    /* ---------- task modal open/close ---------- */
    openTaskModal(mode, task=null){
      this.taskModal.open = true;
      document.body.style.overflow = 'hidden';
      this.taskModal.mode = mode;
      this.taskModal.taskId = null;

      // reset form
      this.taskModal.form = { title:'', description:'', points_xp:20, coins:5, due_at:'', priority:'normal', require_proof:true, reward_achievement_id:null, _due_date:'' };
      this.taskModal.selectedIds = [];
      this.taskModal.query = '';
      this.taskModal.members = [];
      this.taskModal._byId = Object.create(null);

      if (mode === 'edit' && task){
        this.taskModal.taskId = task.id;
        this.taskModal.form = {
          title: task.title || '',
          description: task.description || '',
          points_xp: task.points_xp ?? 20,
          coins: task.coins ?? 5,
          due_at: task.due_at || '',
          _due_date: task.due_at ? this.toLocalInputDate(task.due_at) : '',
          priority: task.priority || 'normal',
          require_proof: !!task.require_proof,
          reward_achievement_id: task.reward_achievement_id ?? null
        };

        const preset = this.extractAssignedIds(task);
        this.taskModal.selectedIds = preset.length ? preset : [];
        if (!preset.length) this.tryFetchAssignees(task.id);
      }

      this.tmFetchMembers();
    },
    closeTaskModal(){
      this.taskModal.open = false;
      document.body.style.overflow = '';
      this.taskModal.taskId = null;
    },

    extractAssignedIds(task){
      const out = [];
      if (task) {
        if (Array.isArray(task.assigned_user_ids)) out.push(...task.assigned_user_ids);
        else if (Array.isArray(task.assignees))     out.push(...task.assignees.map(a => (typeof a === 'object' ? (a.id ?? a.user_id) : a)));
        else if (Array.isArray(task.assigned))      out.push(...task.assigned);
        else if (Array.isArray(task.assigned_ids))  out.push(...task.assigned_ids);
      }
      return out.map(x => String(x));
    },
    async tryFetchAssignees(taskId){
      const cid = this.companyId;
      const candidates = [
        `/api/partners/company/${cid}/tasks/${taskId}/assign`,
        `/api/partners/company/${cid}/tasks/${taskId}/assignees`,
        `/api/partners/company/${cid}/tasks/${taskId}?with=assignees=1`,
      ];
      for (const url of candidates){
        try{
          const r = await fetch(url, { credentials: 'same-origin' });
          if(!r.ok) continue;
          const d = await r.json().catch(()=>null);
          const ids =
            Array.isArray(d?.assigned_user_ids) ? d.assigned_user_ids :
            Array.isArray(d?.assignees)        ? d.assignees.map(a => a.id ?? a.user_id ?? a) :
            Array.isArray(d)                   ? d.map(a => a.id ?? a.user_id ?? a) :
            null;
          if (ids && ids.length){
            this.taskModal.selectedIds = ids.map(x => String(x));
            break;
          }
        }catch(_e){}
      }
    },

    /* ---------- members search/select ---------- */
    async tmFetchMembers(){
      const url = `/api/partners/company/${this.companyId}/members` + (this.taskModal.query ? `?query=${encodeURIComponent(this.taskModal.query)}` : '');
      const r = await fetch(url, { credentials: 'same-origin' });
      if(!r.ok) return;
      const d = await r.json().catch(()=>({}));
      this.taskModal.members = d.members || [];
      this.taskModal._byId = Object.create(null);
      for (const m of this.taskModal.members){
        this.taskModal._byId[String(m.id)] = m;
      }
    },
    tmSearchMembers(){
      clearTimeout(this._tmTimer);
      this._tmTimer = setTimeout(()=> this.tmFetchMembers(), 250);
    },
    tmToggleSelect(id){
      id = String(id);
      const i = this.taskModal.selectedIds.indexOf(id);
      if(i===-1) this.taskModal.selectedIds.push(id);
      else this.taskModal.selectedIds.splice(i,1);
    },
    tmUnselect(id){
      id = String(id);
      const i = this.taskModal.selectedIds.indexOf(id);
      if(i!==-1) this.taskModal.selectedIds.splice(i,1);
    },
    nameById(id){
      id = String(id);
      return this.taskModal._byId[id]?.display_name || `#${id}`;
    },

    /* ---------- create/update task ---------- */
    async saveTask(){
      const cid = this.companyId;
      const body = {...this.taskModal.form};

      if (body._due_date && body._due_date.trim()){
        body.due_at = this.isoFromLocalDateEnd(body._due_date.trim());
      } else {
        body.due_at = null;
      }
      delete body._due_date;

      if(this.taskModal.mode === 'create'){
        // 1) —Å–æ–∑–¥–∞—ë–º –∑–∞–¥–∞—á—É
        const r = await fetch(`/api/partners/company/${cid}/tasks`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body),
          credentials: 'same-origin'
        });
        if(!r.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É'); return; }
        const created = await r.json().catch(()=>null);
        const taskId = created?.task_id || created?.id;

        // 2) –Ω–∞–∑–Ω–∞—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö (replace)
        if(taskId && this.taskModal.selectedIds.length){
          const ra = await fetch(`/api/partners/company/${cid}/tasks/${taskId}/assign`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ user_ids: this.taskModal.selectedIds.map(Number), replace: true }),
            credentials: 'same-origin'
          });
          if(!ra.ok){ alert('–°–æ–∑–¥–∞–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤'); }
        }
        Alpine.store('toasts')?.push?.({title:'–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞', emoji:'‚úÖ'});
      } else {
        // —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        const taskId = this.taskModal.taskId;
        if(!taskId) return;

        const ru = await fetch(`/api/partners/company/${cid}/tasks/${taskId}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body),
          credentials: 'same-origin'
        });
        if(!ru.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è'); return; }

        const ra = await fetch(`/api/partners/company/${cid}/tasks/${taskId}/assign`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_ids: this.taskModal.selectedIds.map(Number), replace: true }),
          credentials: 'same-origin'
        });
        if(!ra.ok){ alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'); }

        Alpine.store('toasts')?.push?.({title:'–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', emoji:'üíæ'});
      }

      this.closeTaskModal();
      await this.loadDashboard();
    },

    /* ---------- feed create ---------- */
    async createPost(){
      if(!this.newPost.trim() && !this.newPostFile) return;

      let r;
      if (this.newPostFile){
        const fd = new FormData();
        fd.append('text', this.newPost || '');
        fd.append('pinned', this.newPinned ? '1' : '0');
        fd.append('photo', this.newPostFile);
        r = await fetch(`/api/partners/company/${this.companyId}/feed`, {
          method:'POST', body: fd, credentials: 'same-origin'
        });
      } else {
        r = await fetch(`/api/partners/company/${this.companyId}/feed`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({text:this.newPost, pinned:this.newPinned}),
          credentials: 'same-origin'
        });
      }

      if(!r.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç'); return; }

      this.newPost = '';
      this.newPinned = false;
      this.clearNewPostFile();
      await this.loadDashboard();
    },
    onNewPostFile(ev){
      const f = ev.target.files?.[0];
      if(!f){ this.clearNewPostFile(); return; }
      if(this.newPostPreview) URL.revokeObjectURL(this.newPostPreview);
      this.newPostFile = f;
      this.newPostPreview = URL.createObjectURL(f);
    },
    clearNewPostFile(){
      this.newPostFile = null;
      if(this.newPostPreview){
        URL.revokeObjectURL(this.newPostPreview);
        this.newPostPreview = '';
      }
      this.$refs?.newPostImageInput && (this.$refs.newPostImageInput.value = '');
    },

    /* ---------- init/load ---------- */
    async init(){
      if(!this.companyId) return;
      await this.loadDashboard();
    },
    async loadDashboard(){
      const r = await fetch(`/api/partners/company/${this.companyId}/dashboard`, { credentials: 'same-origin' });
      if(!r.ok){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥'); return; }
      const d = await r.json().catch(()=>({}));
      const dd = d.dashboard || d.data || d;

      this.company     = dd.company || dd.company_info || null;
      this.kpi         = dd.kpi || dd.stats || {};
      this.feed        = dd.feed || dd.company_feed || dd.posts || [];
      this.tasks       = dd.tasks || dd.company_tasks || [];
      this.leaderboard = dd.leaderboard || dd.top || [];

      const perms = dd.permissions || dd.perms || {};
      this.canPost        = !!(perms.can_create_feed  ?? perms.can_manage ?? false);
      this.canCreateTasks = !!(perms.can_create_tasks ?? perms.can_manage ?? false);
    }
  }
}
</script>
<script>
  // –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–π–¥–∏ –∏ —Å–ª–∞–≥ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞
  window.SJ_COMPANY_ID = {{ company_id|default('null') }};
  window.SJ_COMPANY_SLUG = {{ company_slug|tojson|safe }};
</script>
{% endblock %}
