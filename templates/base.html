<!DOCTYPE html>
<html lang="ru" x-data>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or "Sales Journey" }}</title>

  <!-- Tailwind CDN (dev). –í –ø—Ä–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–±—Ä–∞–Ω–Ω—ã–π CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- –ù–∞—à–∏ stores/—ç—Ñ—Ñ–µ–∫—Ç—ã: –ü–ï–†–ï–î Alpine -->
  <script defer src="{{ url_for('static', filename='app.js') }}"></script>
  <script defer src="{{ url_for('static', filename='admin.js') }}"></script>

  <!-- Alpine: –ü–û–°–õ–ï app.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif}
    .glow { box-shadow: 0 0 30px rgba(59,130,246,.35), inset 0 0 15px rgba(99,102,241,.25); }
    .grad-anim { background: linear-gradient(120deg,#0ea5e9,#6366f1,#e879f9,#22d3ee); background-size:300% 300%; animation:shift 10s ease infinite; }
    @keyframes shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .float { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-6px) } }
    .sparkle { position:relative; }
    .sparkle:after{ content:""; position:absolute; inset:-2px; border-radius:14px; background: radial-gradient(white,rgba(255,255,255,0)) center/150% 150% no-repeat; filter: blur(8px); opacity:.15; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <!-- nav -->
  <header class="sticky top-0 z-40 bg-slate-950/70 backdrop-blur border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="text-xl font-extrabold tracking-tight">
        <span class="bg-gradient-to-r from-indigo-400 via-cyan-400 to-emerald-400 text-transparent bg-clip-text">
          Sales Journey
        </span>
      </a>

      <!-- DESKTOP NAV -->
{% set is_user = current_user is not none %}
{% set is_partner = current_partner is not none %}
{% set is_admin = current_admin is not none %}

<nav class="hidden md:flex items-center gap-3">
  {# –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #}
  {% if is_user %}
    <a href="{{ url_for('page_training_list') }}" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–ö—É—Ä—Å—ã</a>
    <a href="/contests" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–ö–æ–Ω–∫—É—Ä—Å—ã</a>
    <a href="/store" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–ú–∞–≥–∞–∑–∏–Ω</a>
    {% if current_user.company and is_manager(current_user.company.id) %}
      <a href="/company/requests" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–ó–∞—è–≤–∫–∏</a>
      <a href="/training/create" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
    {% endif %}
  {% endif %}

  {# –ú–µ–Ω—é –ø–∞—Ä—Ç–Ω—ë—Ä–∞ #}
  {% if is_partner %}
    <a href="/partner/company" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</a>
    <a href="/partner/training/create" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold">–ö—É—Ä—Å –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</a>
  {% endif %}

  {# –ú–µ–Ω—é –∞–¥–º–∏–Ω–∞ #}
  {% if is_admin %}
    <a href="{{ url_for('page_admin_dashboard') }}" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-semibold">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
  {% endif %}


</nav>

{# –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —à–∞–ø–∫–∏ #}
<div class="flex items-center gap-3">
  {% if is_user %}
  <div class="relative" x-data="notifMenu()" @keydown.escape="open=false">
  <button @click="toggle()" class="relative rounded-xl border border-white/10 px-3 py-2 hover:bg-white/5">
    üîî
    <span x-show="unreadCount" class="absolute -top-1 -right-1 text-[10px] px-1 rounded bg-rose-600 text-white" x-text="unreadCount"></span>
  </button>
  <div x-show="open" x-transition class="absolute right-0 mt-2 w-80 rounded-xl border border-white/10 bg-slate-900/95 p-2">
    <div class="text-sm text-slate-400 px-2 py-1">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    <template x-for="n in items" :key="n.id">
      <div class="p-2 rounded-lg hover:bg-white/5">
        <div class="text-sm font-semibold" x-text="n.title"></div>
        <div class="text-xs text-slate-400" x-text="n.body"></div>
      </div>
    </template>
    <div class="flex justify-end">
      <button class="text-xs text-slate-300 hover:text-white px-2 py-1" @click="markAllRead()">–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å—ë –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º</button>
    </div>
  </div>
</div>
    {# –ø—Ä–æ—Ñ–∏–ª—å –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #}
    <div class="relative" x-data="{open:false}" @mouseenter="open=true" @mouseleave="open=false">
      <a href="{{ url_for('profile_page') }}" class="flex items-center gap-3">
        <img src="{{ url_for('avatar_svg', user_id=current_user.id) }}?part=head&t={{ (current_user.updated_at.timestamp()|int) if current_user.updated_at else 0 }}"
             alt="avatar" class="w-9 h-9 rounded-full ring-2 ring-white/10 transition">
        <span class="text-slate-100 font-semibold">{{ current_user.display_name }}</span>
      </a>
      <div x-show="open" x-transition class="absolute right-0 mt-2 w-44 rounded-xl border border-white/10 bg-slate-900/95 p-2">
        <a class="block px-3 py-2 rounded-lg hover:bg-white/5" href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
  <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5"
        onclick="fetch('/api/auth/logout',{method:'POST'}).then(()=>location.href='/login')">
  –í—ã–π—Ç–∏
</button>


      </div>
    </div>

  {% elif is_partner %}
    {# –ø—Ä–æ—Ñ–∏–ª—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞ #}
    <div class="relative" x-data="{open:false}" @mouseenter="open=true" @mouseleave="open=false">
      <a href="/partner/company" class="flex items-center gap-3">
        <div class="w-9 h-9 grid place-items-center rounded-full ring-2 ring-white/10 bg-indigo-500/20">ü§ù</div>
        <span class="text-slate-100 font-semibold">{{ current_partner.email }}</span>
      </a>
      <div x-show="open" x-transition class="absolute right-0 mt-2 w-48 rounded-xl border border-white/10 bg-slate-900/95 p-2">
        <a class="block px-3 py-2 rounded-lg hover:bg-white/5" href="/partner/company">–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è</a>
        <a class="block px-3 py-2 rounded-lg hover:bg-white/5" href="/partner/training/create">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
       <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5"
        onclick="fetch('/api/partners/auth/logout',{method:'POST'}).then(()=>location.href='/partner/login')">
  –í—ã–π—Ç–∏ (–ø–∞—Ä—Ç–Ω—ë—Ä)
</button>

      </div>
    </div>

  {% elif is_admin %}
    {# –∞–¥–º–∏–Ω: —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∞ #}
    <form onsubmit="event.preventDefault(); fetch('/api/admin/logout',{method:'POST'}).then(()=>location.href='/admin/login')">
      <button class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–í—ã–π—Ç–∏ (–∞–¥–º–∏–Ω)</button>
    </form>

  {% else %}
    {# –Ω–∏–∫—Ç–æ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ö–æ–¥/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –≤—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞ #}
    <a href="/login" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10">–í–æ–π—Ç–∏</a>
    <a href="/register" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
    <a href="{{ url_for('page_admin_login') }}" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∞</a>
    {# –≤—Ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ —É–∂–µ –µ—Å—Ç—å –≤ –ª–µ–≤–æ–º –º–µ–Ω—é, –Ω–æ –º–æ–∂–Ω–æ –∏ —Ç—É—Ç –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å: #}
    <a href="/partner/login" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">–í—Ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</a>
  {% endif %}
</div>

      </div>
    </div>
  </header>

  <main class="min-h-[80vh]">
    {% block content %}{% endblock %}
  </main>

  <footer class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-8 grid sm:grid-cols-3 gap-6 text-sm text-slate-400">
      <div>¬© 2025 Sales Journey</div>
      <div class="text-center">–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–¥–∞–∂, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª—å–Ω–æ –¥–≤–∏–≥–∞–µ—Ç —Ü–∏—Ñ—Ä—ã</div>
      <div class="text-right">hello@salesjourney.app</div>
    </div>
  </footer>

  <!-- Toasts -->
  <div class="fixed top-3 right-3 z-[100] space-y-3 w-80" aria-live="polite">
    <template x-for="t in $store.toasts?.items || []" :key="t.id">
      <div x-show="t.show" x-transition.opacity.duration.200ms
           class="rounded-xl border border-white/10 shadow-xl bg-slate-900/90 p-4 flex gap-3">
        <div class="text-2xl" x-text="t.emoji || '‚ú®'"></div>
        <div class="flex-1">
          <div class="font-semibold" x-text="t.title"></div>
          <div class="text-sm text-slate-300" x-text="t.text"></div>
        </div>
        <button class="text-slate-400 hover:text-slate-200" @click="$store.toasts.dismiss(t.id)">‚úï</button>
      </div>
    </template>
  </div>

  <!-- Confetti canvas -->
  <canvas id="confetti" class="pointer-events-none fixed inset-0 z-[90]"></canvas>
  {% block scripts %}{% endblock %}
<script>
function notifMenu(){ return {
  open:false, items:[], unreadCount:0,
  async toggle(){ this.open=!this.open; if(this.open){ await this.load(); } },
  async load(){
    const r = await fetch('/api/notifications'); if(!r.ok) return;
    const d = await r.json(); this.items = d.notifications || [];
    this.unreadCount = this.items.filter(x=>!x.is_read).length;
  },
  async markAllRead(){ await fetch('/api/notifications/read',{method:'POST'}); await this.load(); }
}}
</script>
</body>

</html>
